version: '3.9'

# Docker Compose for Development with LDAP and OAuth2 support
# Start with: docker-compose -f docker-compose.dev-full.yml up -d
# Stop with: docker-compose -f docker-compose.dev-full.yml down

services:
  # OpenLDAP Server for development/testing
  ldap:
    image: osixia/openldap:latest
    container_name: myrc-ldap-dev
    hostname: ldap
    ports:
      - "389:389"
      - "636:636"
    environment:
      LDAP_ORGANISATION: "myRC"
      LDAP_DOMAIN: "myrc.local"
      LDAP_BASE_DN: "dc=myrc,dc=local"
      LDAP_ADMIN_PASSWORD: "admin-password"
      LDAP_READONLY_USER: "true"
      LDAP_READONLY_USER_USERNAME: "readonly"
      LDAP_READONLY_USER_PASSWORD: "readonly-password"
    volumes:
      - ldap_data:/var/lib/ldap
      - ldap_config:/etc/ldap/slapd.d
      - ./ldap-init.ldif:/container/service/slapd/assets/config/bootstrap/ldif/50-bootstrap.ldif:ro
    networks:
      - myrc-network
    healthcheck:
      test: ["CMD", "ldapwhoami", "-x", "-D", "cn=admin,dc=myrc,dc=local", "-w", "admin-password"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # LDAP Admin UI for managing LDAP (optional)
  phpldapadmin:
    image: osixia/phpldapadmin:latest
    container_name: myrc-ldap-admin
    ports:
      - "6443:443"
    environment:
      PHPLDAPADMIN_LDAP_HOSTS: "ldap"
      PHPLDAPADMIN_LDAP_CLIENT_ADD: "true"
    depends_on:
      - ldap
    networks:
      - myrc-network

  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: myrc-postgres-dev
    hostname: postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: myrc
      POSTGRES_USER: myrc
      POSTGRES_PASSWORD: devpassword
      TZ: UTC
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - myrc-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U myrc -d myrc"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Backend API with LDAP and OAuth2 support
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: myrc-api-dev
    hostname: api
    ports:
      - "8080:8080"
    environment:
      # Application settings
      SPRING_PROFILES_ACTIVE: "dev,ldap,oauth2"
      SPRING_APPLICATION_NAME: "myrc-api"
      
      # LDAP Configuration
      SPRING_LDAP_URLS: "ldap://ldap:389"
      SPRING_LDAP_BASE: "dc=myrc,dc=local"
      SPRING_LDAP_USERNAME: "cn=admin,dc=myrc,dc=local"
      SPRING_LDAP_PASSWORD: "admin-password"
      SPRING_LDAP_USER_SEARCH_FILTER: "(uid={0})"
      SPRING_LDAP_USER_SEARCH_BASE: "ou=users"
      SPRING_LDAP_GROUP_SEARCH_FILTER: "(member={0})"
      SPRING_LDAP_GROUP_SEARCH_BASE: "ou=groups"
      
      # OAuth2 Configuration (development values)
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_ID: "dev-google-client-id"
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_SECRET: "dev-google-secret"
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_REDIRECT_URI: "http://localhost:8080/login/oauth2/code/google"
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GITHUB_CLIENT_ID: "dev-github-client-id"
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GITHUB_CLIENT_SECRET: "dev-github-secret"
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GITHUB_REDIRECT_URI: "http://localhost:8080/login/oauth2/code/github"
      
      # Database Configuration
      SPRING_DATASOURCE_URL: "jdbc:postgresql://postgres:5432/myrc"
      SPRING_DATASOURCE_USERNAME: "myrc"
      SPRING_DATASOURCE_PASSWORD: "devpassword"
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: "org.postgresql.Driver"
      SPRING_JPA_DATABASE: "POSTGRESQL"
      SPRING_JPA_HIBERNATE_DDL_AUTO: "create-drop"
      SPRING_JPA_SHOW_SQL: "false"
      
      # Logging
      LOGGING_LEVEL_ROOT: "INFO"
      LOGGING_LEVEL_COM_BOXOFFICE: "DEBUG"
      LOGGING_LEVEL_SPRING_SECURITY: "DEBUG"
      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_LDAP: "DEBUG"
      
      # CORS
      CORS_ALLOWED_ORIGINS: "http://localhost:4200,http://localhost:3000"
      
    depends_on:
      ldap:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - myrc-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: myrc-web-dev
    hostname: web
    ports:
      - "4200:4200"
    environment:
      API_URL: "http://api:8080"
      ANGULAR_SERVE_HOST: "0.0.0.0"
    depends_on:
      - api
    networks:
      - myrc-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4200/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  ldap_data:
    driver: local
  ldap_config:
    driver: local
  postgres_data:
    driver: local

networks:
  myrc-network:
    driver: bridge
