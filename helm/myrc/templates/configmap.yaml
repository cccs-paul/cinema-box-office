{{- /*
myRC Helm Chart - ConfigMap
*/ -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "myrc.fullname" . }}-config
  namespace: {{ include "myrc.namespace" . }}
  labels:
    {{- include "myrc.labels" . | nindent 4 }}
    app.kubernetes.io/component: config
data:
  # JPA / Hibernate
  SPRING_JPA_HIBERNATE_DDL_AUTO: {{ .Values.jpa.ddlAuto | quote }}
  SPRING_JPA_SHOW_SQL: {{ .Values.jpa.showSql | quote }}

  # Flyway
  SPRING_FLYWAY_ENABLED: {{ .Values.flyway.enabled | quote }}
  SPRING_FLYWAY_BASELINE_ON_MIGRATE: {{ .Values.flyway.baselineOnMigrate | quote }}
  SPRING_FLYWAY_BASELINE_VERSION: {{ .Values.flyway.baselineVersion | quote }}

  # Logging
  LOGGING_LEVEL_ROOT: {{ .Values.logging.rootLevel | quote }}
  LOGGING_LEVEL_COM_MYRC: {{ .Values.logging.appLevel | quote }}

  # Spring profiles
  SPRING_PROFILES_ACTIVE: {{ .Values.backend.springProfiles | quote }}

  # CORS
  APP_CORS_ALLOWED_ORIGINS: {{ .Values.cors.allowedOrigins | quote }}

  # Upload limits
  SPRING_SERVLET_MULTIPART_MAX_FILE_SIZE: {{ .Values.upload.maxFileSize | quote }}
  SPRING_SERVLET_MULTIPART_MAX_REQUEST_SIZE: {{ .Values.upload.maxRequestSize | quote }}

  # Authentication: login methods
  APP_SECURITY_LOGIN_METHODS_APP_ACCOUNT_ENABLED: {{ .Values.auth.appAccount.enabled | quote }}
  APP_SECURITY_LOGIN_METHODS_APP_ACCOUNT_ALLOW_REGISTRATION: {{ .Values.auth.appAccount.allowRegistration | quote }}
  APP_SECURITY_LOGIN_METHODS_LDAP_ENABLED: {{ .Values.auth.ldap.enabled | quote }}
  APP_SECURITY_LOGIN_METHODS_OAUTH2_ENABLED: {{ .Values.auth.oauth2.enabled | quote }}

  {{- if .Values.auth.ldap.enabled }}
  # LDAP configuration
  APP_SECURITY_LDAP_ENABLED: "true"
  APP_SECURITY_LDAP_URL: {{ include "myrc.ldapUrl" . | quote }}
  {{- if .Values.testLdap.enabled }}
  APP_SECURITY_LDAP_BASE_DN: "dc=planetexpress,dc=com"
  APP_SECURITY_LDAP_MANAGER_DN: "cn=admin,dc=planetexpress,dc=com"
  APP_SECURITY_LDAP_USER_SEARCH_BASE: "ou=people"
  APP_SECURITY_LDAP_USER_SEARCH_FILTER: "(uid={0})"
  APP_SECURITY_LDAP_GROUP_SEARCH_BASE: "ou=people"
  APP_SECURITY_LDAP_GROUP_SEARCH_FILTER: "(member={0})"
  APP_SECURITY_LDAP_GROUP_NAME_ATTRIBUTE: "cn"
  {{- else }}
  APP_SECURITY_LDAP_BASE_DN: {{ .Values.auth.ldap.baseDn | quote }}
  APP_SECURITY_LDAP_MANAGER_DN: {{ .Values.auth.ldap.managerDn | quote }}
  APP_SECURITY_LDAP_USER_SEARCH_BASE: {{ .Values.auth.ldap.userSearchBase | quote }}
  APP_SECURITY_LDAP_USER_SEARCH_FILTER: {{ .Values.auth.ldap.userSearchFilter | quote }}
  APP_SECURITY_LDAP_GROUP_SEARCH_BASE: {{ .Values.auth.ldap.groupSearchBase | quote }}
  APP_SECURITY_LDAP_GROUP_SEARCH_FILTER: {{ .Values.auth.ldap.groupSearchFilter | quote }}
  APP_SECURITY_LDAP_GROUP_NAME_ATTRIBUTE: {{ .Values.auth.ldap.groupNameAttribute | quote }}
  {{- end }}
  APP_SECURITY_LDAP_CONNECT_TIMEOUT: {{ .Values.auth.ldap.connectTimeout | quote }}
  APP_SECURITY_LDAP_READ_TIMEOUT: {{ .Values.auth.ldap.readTimeout | quote }}
  APP_SECURITY_LDAP_ALLOW_SIGN_UP: {{ .Values.auth.ldap.allowSignUp | quote }}
  APP_SECURITY_LDAP_SKIP_ORG_ROLE_SYNC: {{ .Values.auth.ldap.skipOrgRoleSync | quote }}

  # LDAP attribute mappings
  APP_SECURITY_LDAP_ATTRIBUTES_USERNAME: {{ .Values.auth.ldap.attributes.username | quote }}
  APP_SECURITY_LDAP_ATTRIBUTES_EMAIL: {{ .Values.auth.ldap.attributes.email | quote }}
  APP_SECURITY_LDAP_ATTRIBUTES_NAME: {{ .Values.auth.ldap.attributes.name | quote }}
  APP_SECURITY_LDAP_ATTRIBUTES_SURNAME: {{ .Values.auth.ldap.attributes.surname | quote }}
  APP_SECURITY_LDAP_ATTRIBUTES_GIVEN_NAME: {{ .Values.auth.ldap.attributes.givenName | quote }}
  APP_SECURITY_LDAP_ATTRIBUTES_MEMBER_OF: {{ .Values.auth.ldap.attributes.memberOf | quote }}

  # LDAP group-to-role mappings
  {{- range $i, $mapping := .Values.auth.ldap.groupMappings }}
  APP_SECURITY_LDAP_GROUP_MAPPINGS_{{ $i }}_GROUP_DN: {{ $mapping.groupDn | quote }}
  APP_SECURITY_LDAP_GROUP_MAPPINGS_{{ $i }}_ROLE: {{ $mapping.role | quote }}
  APP_SECURITY_LDAP_GROUP_MAPPINGS_{{ $i }}_IS_ADMIN: {{ $mapping.isAdmin | quote }}
  {{- end }}
  {{- end }}
