# ============================================================================
# myRC - Docker Compose for Test LDAP Deployment
# ============================================================================
# Copyright (c) 2026 myRC Team
# Licensed under MIT License
#
# Description: Docker Compose configuration for running myRC with LDAP-only
#              authentication using the docker-test-openldap image.
#              Uses Futurama-themed test users from Planet Express.
#
# Usage:
#   docker compose --project-name myrc-testldap -f docker-compose.testldap.yml up -d
#
# See docs/TEST_LDAP_DEPLOYMENT.md for detailed instructions and user credentials.
# ============================================================================

services:
  # --------------------------------------------------------------------------
  # OpenLDAP Test Server (Futurama / Planet Express)
  # --------------------------------------------------------------------------
  # Image: https://github.com/rroemhild/docker-test-openldap
  # Pre-populated with Futurama characters as test users.
  # Ports: 10389 (LDAP), 10636 (LDAPS)
  # --------------------------------------------------------------------------
  openldap:
    image: ghcr.io/rroemhild/docker-test-openldap:master
    container_name: myrc-testldap-openldap
    hostname: openldap
    ports:
      - "10389:10389"
      - "10636:10636"
    networks:
      - myrc-testldap-network
    healthcheck:
      test: ["CMD-SHELL", "ldapsearch -H ldap://localhost:10389 -x -b 'dc=planetexpress,dc=com' -D 'cn=admin,dc=planetexpress,dc=com' -w GoodNewsEveryone '(objectClass=organization)' dn 2>/dev/null | grep -q 'dn:'"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s
    restart: unless-stopped

  # --------------------------------------------------------------------------
  # PostgreSQL Database
  # --------------------------------------------------------------------------
  postgres:
    image: postgres:16-alpine
    container_name: myrc-testldap-db
    hostname: postgres
    environment:
      POSTGRES_DB: myrc
      POSTGRES_USER: myrc
      POSTGRES_PASSWORD: myrc_password
    volumes:
      - myrc_testldap_postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U myrc"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - myrc-testldap-network
    restart: unless-stopped

  # --------------------------------------------------------------------------
  # myRC Backend API - Configured for LDAP-Only Authentication
  # --------------------------------------------------------------------------
  api:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: myrc-testldap-api
    hostname: api
    environment:
      # --- Spring Core ---
      SPRING_PROFILES_ACTIVE: dev
      SPRING_SERVLET_MULTIPART_MAX_FILE_SIZE: 50MB
      SPRING_SERVLET_MULTIPART_MAX_REQUEST_SIZE: 50MB

      # --- Database ---
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/myrc
      SPRING_DATASOURCE_USERNAME: myrc
      SPRING_DATASOURCE_PASSWORD: myrc_password
      SPRING_JPA_HIBERNATE_DDL_AUTO: update

      # --- Login Methods: LDAP only ---
      APP_SECURITY_LOGIN_METHODS_APP_ACCOUNT_ENABLED: "false"
      APP_SECURITY_LOGIN_METHODS_APP_ACCOUNT_ALLOW_REGISTRATION: "false"
      APP_SECURITY_LOGIN_METHODS_LDAP_ENABLED: "true"
      APP_SECURITY_LOGIN_METHODS_OAUTH2_ENABLED: "false"

      # --- LDAP Server Configuration ---
      APP_SECURITY_LDAP_ENABLED: "true"
      APP_SECURITY_LDAP_URL: "ldap://openldap:10389"
      APP_SECURITY_LDAP_BASE_DN: "dc=planetexpress,dc=com"
      APP_SECURITY_LDAP_MANAGER_DN: "cn=admin,dc=planetexpress,dc=com"
      APP_SECURITY_LDAP_MANAGER_PASSWORD: "GoodNewsEveryone"
      APP_SECURITY_LDAP_USER_SEARCH_BASE: "ou=people"
      APP_SECURITY_LDAP_USER_SEARCH_FILTER: "(uid={0})"
      APP_SECURITY_LDAP_GROUP_SEARCH_BASE: "ou=people"
      APP_SECURITY_LDAP_GROUP_SEARCH_FILTER: "(member={0})"
      APP_SECURITY_LDAP_GROUP_NAME_ATTRIBUTE: "cn"
      APP_SECURITY_LDAP_GROUP_OBJECT_CLASS: "(objectClass=Group)"
      APP_SECURITY_LDAP_DISTRIBUTION_LIST_SEARCH_BASE: "ou=people"
      APP_SECURITY_LDAP_CONNECT_TIMEOUT: "5000"
      APP_SECURITY_LDAP_READ_TIMEOUT: "5000"
      APP_SECURITY_LDAP_ALLOW_SIGN_UP: "true"
      APP_SECURITY_LDAP_SKIP_ORG_ROLE_SYNC: "false"

      # --- LDAP Attribute Mapping ---
      APP_SECURITY_LDAP_ATTRIBUTES_USERNAME: "uid"
      APP_SECURITY_LDAP_ATTRIBUTES_EMAIL: "mail"
      APP_SECURITY_LDAP_ATTRIBUTES_NAME: "cn"
      APP_SECURITY_LDAP_ATTRIBUTES_SURNAME: "sn"
      APP_SECURITY_LDAP_ATTRIBUTES_GIVEN_NAME: "givenName"
      APP_SECURITY_LDAP_ATTRIBUTES_MEMBER_OF: "memberOf"

      # --- LDAP Group-to-Role Mappings ---
      # admin_staff group -> ADMIN role
      APP_SECURITY_LDAP_GROUP_MAPPINGS_0_GROUP_DN: "cn=admin_staff,ou=people,dc=planetexpress,dc=com"
      APP_SECURITY_LDAP_GROUP_MAPPINGS_0_ROLE: "ADMIN"
      APP_SECURITY_LDAP_GROUP_MAPPINGS_0_IS_ADMIN: "true"
      # ship_crew group -> USER role
      APP_SECURITY_LDAP_GROUP_MAPPINGS_1_GROUP_DN: "cn=ship_crew,ou=people,dc=planetexpress,dc=com"
      APP_SECURITY_LDAP_GROUP_MAPPINGS_1_ROLE: "USER"
      APP_SECURITY_LDAP_GROUP_MAPPINGS_1_IS_ADMIN: "false"

      # --- Logging ---
      LOGGING_LEVEL_COM_MYRC: DEBUG
      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_SECURITY: DEBUG
      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_LDAP: DEBUG

    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      openldap:
        condition: service_healthy
    networks:
      - myrc-testldap-network
    restart: unless-stopped

  # --------------------------------------------------------------------------
  # myRC Frontend (Angular Dev Server)
  # --------------------------------------------------------------------------
  web:
    build:
      context: .
      dockerfile: frontend/Dockerfile.dev
    container_name: myrc-testldap-web
    hostname: web
    environment:
      NODE_ENV: development
    ports:
      - "4200:4200"
    depends_on:
      - api
    networks:
      - myrc-testldap-network
    restart: unless-stopped

  # --------------------------------------------------------------------------
  # pgAdmin - Database Management UI
  # --------------------------------------------------------------------------
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: myrc-testldap-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@example.com
      PGADMIN_DEFAULT_PASSWORD: admin_password
      PGADMIN_CONFIG_ENHANCED_COOKIE_PROTECTION: 'False'
      PGADMIN_CONFIG_CONSOLE_LOG_LEVEL: 10
    ports:
      - "5050:80"
    depends_on:
      - postgres
    networks:
      - myrc-testldap-network
    restart: unless-stopped

volumes:
  myrc_testldap_postgres_data:
    driver: local

networks:
  myrc-testldap-network:
    driver: bridge
