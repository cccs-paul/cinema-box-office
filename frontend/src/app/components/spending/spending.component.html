<!--
  myRC - Spending Component Template
  Copyright (c) 2026 myRC Team
  Licensed under MIT License
-->
<div class="spending-container">
  <!-- Action Bar -->
  <div class="action-bar">
    <button class="btn btn-primary" (click)="showCreate()" *ngIf="canWrite && !showCreateForm" [disabled]="categories.length === 0">
      + Add Spending Item
    </button>
  </div>

  <!-- Messages -->
  <div class="messages">
    <div class="alert alert-danger" *ngIf="errorMessage">
      {{ errorMessage }}
    </div>
    <div class="alert alert-success" *ngIf="successMessage">
      {{ successMessage }}
    </div>
  </div>

  <!-- Search and Category Filter -->
  <div class="filters-bar" [class.collapsed]="!filtersExpanded" *ngIf="!showCreateForm">
    <div class="filters-header">
      <button 
        class="btn-toggle-filters" 
        (click)="toggleFilters()"
        [title]="filtersExpanded ? 'Collapse filters' : 'Expand filters'">
        <span class="toggle-icon" [class.collapsed]="!filtersExpanded">â–¼</span>
        <span class="toggle-label">{{ filtersExpanded ? 'Hide Filters' : 'Show Filters' }}</span>
      </button>
    </div>
    <div class="filters-content" *ngIf="filtersExpanded">
      <!-- Search Box -->
      <div class="search-box">
        <input
          type="text"
          [(ngModel)]="searchTerm"
          placeholder="Search spending items..."
          class="search-input"
        />
        <button 
          class="btn-clear" 
          *ngIf="searchTerm" 
          (click)="clearSearch()"
          title="Clear search">
          âœ•
        </button>
      </div>

      <!-- Category Filter -->
      <div class="category-filter" *ngIf="categories.length > 0 && selectedFY?.showCategoryFilter !== false">
        <span class="filter-label">Category:</span>
        <button 
          class="filter-btn"
          [class.active]="selectedCategoryId === null"
          (click)="filterByCategory(null)">
          All
        </button>
        <button 
          *ngFor="let category of categories"
          class="filter-btn"
          [class.active]="selectedCategoryId === category.id"
          (click)="filterByCategory(category.id)">
          {{ category.name }}
        </button>
      </div>
    </div>
  </div>

  <!-- Create Form -->
  <div class="create-form-container" *ngIf="showCreateForm">
    <div class="create-form">
      <h2>New Spending Item</h2>
      
      <div class="form-row">
        <div class="form-group">
          <label for="name">Name *</label>
          <input 
            type="text" 
            id="name" 
            [(ngModel)]="newItemName"
            placeholder="Enter spending item name"
            class="form-control">
        </div>
        <div class="form-group">
          <label for="category">Category *</label>
          <select id="category" [(ngModel)]="newItemCategoryId" (ngModelChange)="onCategoryChange()" class="form-control">
            <option *ngFor="let category of categories" [ngValue]="category.id">
              {{ category.name }}
            </option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="description">Description</label>
        <textarea 
          id="description" 
          [(ngModel)]="newItemDescription"
          placeholder="Enter description"
          class="form-control"
          rows="2"></textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="vendor">Vendor</label>
          <input 
            type="text" 
            id="vendor" 
            [(ngModel)]="newItemVendor"
            placeholder="Vendor name"
            class="form-control">
        </div>
        <div class="form-group">
          <label for="referenceNumber">Reference Number</label>
          <input 
            type="text" 
            id="referenceNumber" 
            [(ngModel)]="newItemReferenceNumber"
            placeholder="PO/Invoice #"
            class="form-control">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="status">Status</label>
          <select id="status" [(ngModel)]="newItemStatus" class="form-control">
            <option *ngFor="let status of statusOptions" [value]="status">
              {{ getStatusLabel(status) }}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label for="currency">Currency</label>
          <select id="currency" [(ngModel)]="newItemCurrency" class="form-control">
            <option *ngFor="let currency of currencies" [value]="currency.code">
              {{ getCurrencyFlag(currency.code) }} {{ currency.code }} - {{ currency.name }}
            </option>
          </select>
        </div>
        <div class="form-group" *ngIf="newItemCurrency !== 'CAD'">
          <label for="exchangeRate">Exchange Rate</label>
          <input 
            type="number" 
            id="exchangeRate" 
            [(ngModel)]="newItemExchangeRate"
            placeholder="Rate to CAD"
            step="0.0001"
            min="0"
            class="form-control">
        </div>
      </div>

      <!-- Money Allocations -->
      <div class="money-allocations-section">
        <h3>Money Allocations</h3>
        <p class="allocation-hint">
          <span class="info-icon">â„¹ï¸</span>
          <ng-container *ngIf="selectedCategoryAllowsCap() && selectedCategoryAllowsOm()">
            At least one money type must have a CAP or OM amount greater than $0.00
          </ng-container>
          <ng-container *ngIf="selectedCategoryAllowsCap() && !selectedCategoryAllowsOm()">
            This category allows <strong>Capital (CAP) only</strong>. At least one CAP amount must be greater than $0.00
          </ng-container>
          <ng-container *ngIf="!selectedCategoryAllowsCap() && selectedCategoryAllowsOm()">
            This category allows <strong>O&M only</strong>. At least one OM amount must be greater than $0.00
          </ng-container>
        </p>
        <div class="allocations-table">
          <table>
            <thead>
              <tr>
                <th>Money Type</th>
                <th *ngIf="selectedCategoryAllowsCap()">CAP Amount</th>
                <th *ngIf="selectedCategoryAllowsOm()">OM Amount</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let allocation of newItemMoneyAllocations">
                <td class="money-name">
                  {{ allocation.moneyName }}
                </td>
                <td *ngIf="selectedCategoryAllowsCap()">
                  <input 
                    type="number" 
                    [(ngModel)]="allocation.capAmount"
                    min="0"
                    step="0.01"
                    class="form-control amount-input">
                </td>
                <td *ngIf="selectedCategoryAllowsOm()">
                  <input 
                    type="number" 
                    [(ngModel)]="allocation.omAmount"
                    min="0"
                    step="0.01"
                    class="form-control amount-input">
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="form-actions">
        <button class="btn btn-secondary" (click)="cancelCreate()">Cancel</button>
        <button 
          class="btn btn-primary" 
          (click)="createSpendingItem()"
          [disabled]="!newItemName.trim() || !newItemCategoryId || isCreating || !hasValidMoneyAllocation()">
          {{ isCreating ? 'Creating...' : 'Create Spending Item' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading" *ngIf="isLoadingItems">
    <div class="loading-spinner"></div>
    <p>Loading spending items...</p>
  </div>

  <!-- Empty State - No items match filter -->
  <div class="empty-state" *ngIf="!isLoadingItems && spendingItems.length > 0 && filteredSpendingItems.length === 0 && !showCreateForm">
    <div class="empty-icon">ğŸ”</div>
    <h3>No Matching Items</h3>
    <p>No spending items match the current filter(s). Try adjusting your search or category filter.</p>
    <button class="btn btn-secondary" (click)="clearSearch(); selectedCategoryId = null">
      Clear Filters
    </button>
  </div>

  <!-- Empty State - No items exist -->
  <div class="empty-state" *ngIf="!isLoadingItems && spendingItems.length === 0 && !showCreateForm">
    <div class="empty-icon">ğŸ’°</div>
    <h3>No Spending Items Yet</h3>
    <p>Get started by creating your first spending item for this fiscal year.</p>
    <button class="btn btn-primary" (click)="showCreate()" *ngIf="canWrite && categories.length > 0">
      Create First Spending Item
    </button>
    <p class="hint" *ngIf="categories.length === 0">
      Configure spending categories first in the Configuration page.
    </p>
  </div>

  <!-- Spending Items List -->
  <div class="items-list" *ngIf="!isLoadingItems && filteredSpendingItems.length > 0">
    <div class="item-card" *ngFor="let item of filteredSpendingItems" [class.expanded]="expandedItemId === item.id">
      <!-- Item Summary Row -->
      <div class="item-summary" (click)="toggleItemDetails(item)">
        <div class="item-info">
          <span class="item-name">{{ item.name }}</span>
          <span class="category-badge" *ngIf="item.categoryName">{{ item.categoryName }}</span>
          <span class="status-badge" [ngClass]="getStatusClass(item.status)">
            {{ getStatusLabel(item.status) }}
          </span>
          <span class="currency-badge" [class.foreign-currency]="item.currency !== 'CAD'">
            {{ getCurrencyFlag(item.currency) }} {{ item.currency }}
          </span>
          <span class="total-amount">{{ formatCurrency(calculateTotal(item), item.currency) }}</span>
        </div>
        <div class="item-actions">
          <button
            class="btn-icon expand-btn"
            [title]="expandedItemId === item.id ? 'Collapse' : 'Expand'"
            (click)="toggleItemDetails(item); $event.stopPropagation()"
          >
            {{ expandedItemId === item.id ? 'â–²' : 'â–¼' }}
          </button>
          <button
            class="btn-icon btn-edit"
            title="Edit"
            *ngIf="canWrite && editingItemId !== item.id"
            (click)="startEditSpendingItem(item); $event.stopPropagation()"
          >
            âœï¸
          </button>
          <button
            class="btn-icon btn-delete"
            title="Delete"
            *ngIf="canWrite"
            (click)="deleteSpendingItem(item); $event.stopPropagation()"
          >
            ğŸ—‘ï¸
          </button>
        </div>
      </div>

      <!-- Expanded Details Section -->
      <div class="item-details" *ngIf="expandedItemId === item.id">
        <!-- View Mode -->
        <div class="details-content" *ngIf="editingItemId !== item.id">
          <div class="info-grid">
            <div class="info-item" *ngIf="item.description">
              <label>Description</label>
              <span>{{ item.description }}</span>
            </div>
            <div class="info-item" *ngIf="item.vendor">
              <label>Vendor</label>
              <span>{{ item.vendor }}</span>
            </div>
            <div class="info-item" *ngIf="item.referenceNumber">
              <label>Reference Number</label>
              <span>{{ item.referenceNumber }}</span>
            </div>
            <div class="info-item" *ngIf="item.currency !== 'CAD' && item.exchangeRate">
              <label>Exchange Rate</label>
              <span>1 {{ item.currency }} = {{ item.exchangeRate }} CAD</span>
            </div>
          </div>
          <!-- Money Allocations -->
          <div class="money-section" *ngIf="item.moneyAllocations && item.moneyAllocations.length > 0">
            <label>Money Allocations</label>
            <div class="money-grid">
              <div class="money-row" *ngFor="let allocation of item.moneyAllocations">
                <span class="money-label">{{ allocation.moneyName || 'AB' }}:</span>
                <span class="money-amounts">
                  <ng-container *ngIf="categoryAllowsCapById(item.categoryId)">
                    CAP: {{ formatCurrency(allocation.capAmount, item.currency) }}
                  </ng-container>
                  <ng-container *ngIf="categoryAllowsCapById(item.categoryId) && categoryAllowsOmById(item.categoryId)">, </ng-container>
                  <ng-container *ngIf="categoryAllowsOmById(item.categoryId)">
                    OM: {{ formatCurrency(allocation.omAmount, item.currency) }}
                  </ng-container>
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Edit Mode -->
        <div class="edit-form" *ngIf="editingItemId === item.id">
          <h4>Edit Spending Item</h4>
          <div class="form-row">
            <div class="form-group">
              <label for="editItemName">Name <span class="required">*</span></label>
              <input
                id="editItemName"
                type="text"
                [(ngModel)]="editItemName"
                placeholder="Enter item name"
                [disabled]="isUpdating"
                required
              />
            </div>
            <div class="form-group">
              <label for="editItemDescription">Description</label>
              <input
                id="editItemDescription"
                type="text"
                [(ngModel)]="editItemDescription"
                placeholder="Optional description"
                [disabled]="isUpdating"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="editItemVendor">Vendor</label>
              <input
                id="editItemVendor"
                type="text"
                [(ngModel)]="editItemVendor"
                placeholder="Vendor name"
                [disabled]="isUpdating"
              />
            </div>
            <div class="form-group">
              <label for="editItemReferenceNumber">Reference Number</label>
              <input
                id="editItemReferenceNumber"
                type="text"
                [(ngModel)]="editItemReferenceNumber"
                placeholder="Reference number"
                [disabled]="isUpdating"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="editItemCurrency">Currency</label>
              <div class="currency-selector">
                <span class="currency-flag">{{ getCurrencyFlag(editItemCurrency) }}</span>
                <select id="editItemCurrency" [(ngModel)]="editItemCurrency" [disabled]="isUpdating"
                        (change)="onEditCurrencyChange()">
                  <option value="CAD">ğŸ‡¨ğŸ‡¦ CAD - Canadian Dollar</option>
                  <option value="USD">ğŸ‡ºğŸ‡¸ USD - US Dollar</option>
                  <option value="EUR">ğŸ‡ªğŸ‡º EUR - Euro</option>
                  <option value="GBP">ğŸ‡¬ğŸ‡§ GBP - British Pound</option>
                  <option value="JPY">ğŸ‡¯ğŸ‡µ JPY - Japanese Yen</option>
                  <option value="AUD">ğŸ‡¦ğŸ‡º AUD - Australian Dollar</option>
                  <option value="CHF">ğŸ‡¨ğŸ‡­ CHF - Swiss Franc</option>
                  <option value="CNY">ğŸ‡¨ğŸ‡³ CNY - Chinese Yuan</option>
                  <option value="INR">ğŸ‡®ğŸ‡³ INR - Indian Rupee</option>
                  <option value="MXN">ğŸ‡²ğŸ‡½ MXN - Mexican Peso</option>
                  <option value="BRL">ğŸ‡§ğŸ‡· BRL - Brazilian Real</option>
                  <option value="KRW">ğŸ‡°ğŸ‡· KRW - South Korean Won</option>
                  <option value="SGD">ğŸ‡¸ğŸ‡¬ SGD - Singapore Dollar</option>
                  <option value="HKD">ğŸ‡­ğŸ‡° HKD - Hong Kong Dollar</option>
                  <option value="NZD">ğŸ‡³ğŸ‡¿ NZD - New Zealand Dollar</option>
                  <option value="SEK">ğŸ‡¸ğŸ‡ª SEK - Swedish Krona</option>
                  <option value="NOK">ğŸ‡³ğŸ‡´ NOK - Norwegian Krone</option>
                  <option value="DKK">ğŸ‡©ğŸ‡° DKK - Danish Krone</option>
                </select>
              </div>
            </div>
            <div class="form-group" *ngIf="editItemCurrency !== 'CAD'">
              <label for="editItemExchangeRate">Exchange Rate <span class="required">*</span></label>
              <div class="exchange-rate-field">
                1 {{ editItemCurrency }} = 
                <input
                  id="editItemExchangeRate"
                  type="number"
                  [(ngModel)]="editItemExchangeRate"
                  placeholder="Enter exchange rate"
                  [disabled]="isUpdating"
                  step="0.000001"
                  min="0.000001"
                  class="exchange-rate-input"
                /> CAD
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="editItemStatus">Status <span class="required">*</span></label>
              <select id="editItemStatus" [(ngModel)]="editItemStatus" [disabled]="isUpdating" required>
                <option *ngFor="let status of statusOptions" [value]="status">
                  {{ getStatusLabel(status) }}
                </option>
              </select>
            </div>
            <div class="form-group">
              <label for="editItemCategory">Category</label>
              <select 
                id="editItemCategory" 
                [(ngModel)]="editItemCategoryId" 
                [disabled]="isUpdating || isLoadingCategories"
              >
                <option [ngValue]="null">-- No Category --</option>
                <option *ngFor="let category of categories" [ngValue]="category.id">
                  {{ category.name }}
                </option>
              </select>
            </div>
          </div>

          <!-- Edit Money Allocations -->
          <div class="money-allocations" *ngIf="editItemMoneyAllocations && editItemMoneyAllocations.length > 0">
            <h4>Money Allocations</h4>
            <p class="allocation-hint">
              <ng-container *ngIf="editCategoryAllowsCap() && editCategoryAllowsOm()">
                Enter spending amounts for each money type. 
                <strong>At least one money type must have a CAP or OM amount greater than $0.00.</strong>
              </ng-container>
              <ng-container *ngIf="editCategoryAllowsCap() && !editCategoryAllowsOm()">
                This category allows <strong>Capital (CAP) only</strong>. At least one CAP amount must be greater than $0.00.
              </ng-container>
              <ng-container *ngIf="!editCategoryAllowsCap() && editCategoryAllowsOm()">
                This category allows <strong>O&M only</strong>. At least one OM amount must be greater than $0.00.
              </ng-container>
            </p>
            <div class="allocations-grid">
              <div class="allocation-row" *ngFor="let allocation of editItemMoneyAllocations; let i = index" [class.is-default]="allocation.isDefault">
                <div class="allocation-header">
                  <span class="money-code">{{ allocation.moneyName }}</span>
                </div>
                <div class="allocation-inputs">
                  <div class="allocation-field" *ngIf="editCategoryAllowsCap()">
                    <label [for]="'edit-cap-' + i">{{ allocation.moneyName }} (CAP)</label>
                    <input
                      [id]="'edit-cap-' + i"
                      type="number"
                      [(ngModel)]="allocation.capAmount"
                      placeholder="0.00"
                      [disabled]="isUpdating"
                      step="0.01"
                      min="0"
                      class="money-input"
                    />
                  </div>
                  <div class="allocation-field" *ngIf="editCategoryAllowsOm()">
                    <label [for]="'edit-om-' + i">{{ allocation.moneyName }} (O&M)</label>
                    <input
                      [id]="'edit-om-' + i"
                      type="number"
                      [(ngModel)]="allocation.omAmount"
                      placeholder="0.00"
                      [disabled]="isUpdating"
                      step="0.01"
                      min="0"
                      class="money-input"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button 
              class="btn-secondary" 
              (click)="cancelEditSpendingItem()"
              [disabled]="isUpdating"
            >
              Cancel
            </button>
            <button 
              class="btn-primary" 
              (click)="updateSpendingItem()"
              [disabled]="isUpdating || !editItemName.trim() || !hasValidEditMoneyAllocation()"
            >
              <span *ngIf="isUpdating">Updating...</span>
              <span *ngIf="!isUpdating">Update Item</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Summary Section -->
  <div class="summary-section" *ngIf="spendingItems.length > 0">
    <h3>Summary</h3>
    
    <!-- Summary by Money Type -->
    <div class="summary-group">
      <h4>Totals by Money Type</h4>
      <table class="summary-table">
        <thead>
          <tr>
            <th>Money Type</th>
            <th>Total CAP</th>
            <th>Total OM</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let summary of summaryByMoneyType">
            <td>{{ summary.moneyCode }} - {{ summary.moneyName }}</td>
            <td class="amount">{{ formatCurrency(summary.totalCap) }}</td>
            <td class="amount">{{ formatCurrency(summary.totalOm) }}</td>
            <td class="amount total">{{ formatCurrency(summary.total) }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- Summary by Category -->
    <div class="summary-group" *ngIf="summaryByCategory.length > 0">
      <h4>Totals by Category</h4>
      <table class="summary-table">
        <thead>
          <tr>
            <th>Category</th>
            <th>Total CAP</th>
            <th>Total OM</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let summary of summaryByCategory">
            <td>{{ summary.categoryName }}</td>
            <td class="amount">{{ formatCurrency(summary.totalCap) }}</td>
            <td class="amount">{{ formatCurrency(summary.totalOm) }}</td>
            <td class="amount total">{{ formatCurrency(summary.total) }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- Grand Total -->
    <div class="grand-total">
      <table class="summary-table">
        <tbody>
          <tr class="grand-total-row">
            <td><strong>Grand Total (All Spending Items)</strong></td>
            <td class="amount"><strong>{{ formatCurrency(grandTotalCap) }}</strong></td>
            <td class="amount"><strong>{{ formatCurrency(grandTotalOm) }}</strong></td>
            <td class="amount total"><strong>{{ formatCurrency(grandTotal) }}</strong></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
