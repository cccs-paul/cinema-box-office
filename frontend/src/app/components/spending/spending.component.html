<!--
  myRC - Spending Component Template
  Copyright (c) 2026 myRC Team
  Licensed under MIT License
-->
<div class="spending-container">
  <!-- Messages -->
  <div class="messages">
    <div class="alert alert-danger" *ngIf="errorMessage">
      {{ errorMessage }}
    </div>
    <div class="alert alert-success" *ngIf="successMessage">
      {{ successMessage }}
    </div>
  </div>

  <!-- Search and Category Filter -->
  <div class="filters-bar" [class.collapsed]="!filtersExpanded" *ngIf="!showCreateForm && displayPreferences.showSearchBox">
    <!-- Search Box - Always Visible -->
    <div class="search-box-always-visible">
      <input
        type="text"
        [(ngModel)]="searchTerm"
        [placeholder]="'spending.searchPlaceholder' | translate"
        class="search-input"
      />
      <button 
        class="btn-clear" 
        *ngIf="searchTerm" 
        (click)="clearSearch()"
        [title]="'common.clearSearch' | translate">
        âœ•
      </button>
      <button 
        class="btn-toggle-filters" 
        (click)="toggleFilters()"
        [title]="filtersExpanded ? ('common.hideFilters' | translate) : ('common.showFilters' | translate)">
        <span class="toggle-icon" [class.collapsed]="!filtersExpanded">â–¼</span>
        <span class="toggle-label">{{ filtersExpanded ? ('common.hideFilters' | translate) : ('common.showFilters' | translate) }}</span>
      </button>
    </div>
    <div class="filters-content" *ngIf="filtersExpanded">
      <!-- Category Filter -->
      <div class="category-filter" *ngIf="categories.length > 0 && displayPreferences.showCategoryFilter">
        <span class="filter-label">{{ 'common.category' | translate }}:</span>
        <button 
          class="filter-btn"
          [class.active]="selectedCategoryId === null"
          (click)="filterByCategory(null)">
          {{ 'common.all' | translate }}
        </button>
        <button 
          *ngFor="let category of categories"
          class="filter-btn"
          [class.active]="selectedCategoryId === category.id"
          (click)="filterByCategory(category.id)">
          {{ getCategoryDisplayName(category) }}
        </button>
      </div>
    </div>
  </div>

  <!-- Create Form -->
  <div class="create-form-container" *ngIf="showCreateForm">
    <div class="create-form">
      <h2>{{ 'spending.createNewItem' | translate }}</h2>
      
      <div class="form-row">
        <div class="form-group">
          <label for="name">{{ 'common.name' | translate }} *</label>
          <input 
            type="text" 
            id="name" 
            [(ngModel)]="newItemName"
            [placeholder]="'spending.enterItemName' | translate"
            class="form-control">
        </div>
        <div class="form-group">
          <label for="category">{{ 'common.category' | translate }} *</label>
          <select id="category" [(ngModel)]="newItemCategoryId" (ngModelChange)="onCategoryChange()" class="form-control">
            <option *ngFor="let category of categories" [ngValue]="category.id">
              {{ getCategoryDisplayName(category) }}
            </option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="description">{{ 'common.description' | translate }}</label>
        <textarea 
          id="description" 
          [(ngModel)]="newItemDescription"
          [placeholder]="'spending.enterDescription' | translate"
          class="form-control"
          rows="2"></textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="vendor">{{ 'spending.vendor' | translate }}</label>
          <input 
            type="text" 
            id="vendor" 
            [(ngModel)]="newItemVendor"
            [placeholder]="'spending.vendorName' | translate"
            class="form-control">
        </div>
        <div class="form-group">
          <label for="referenceNumber">{{ 'spending.referenceNumber' | translate }}</label>
          <input 
            type="text" 
            id="referenceNumber" 
            [(ngModel)]="newItemReferenceNumber"
            [placeholder]="'spending.poInvoice' | translate"
            class="form-control">
        </div>
      </div>

      <div class="form-row" [class.three-cols]="newItemCurrency !== 'CAD'">
        <div class="form-group">
          <label for="status">{{ 'common.status' | translate }}</label>
          <select id="status" [(ngModel)]="newItemStatus" class="form-control">
            <option *ngFor="let status of statusOptions" [value]="status">
              {{ getStatusLabel(status) }}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label for="currency">{{ 'spending.currency' | translate }}</label>
          <select id="currency" [(ngModel)]="newItemCurrency" class="form-control">
            <option *ngFor="let currency of currencies" [value]="currency.code">
              {{ getCurrencyFlag(currency.code) }} {{ currency.code }} - {{ currency.name }}
            </option>
          </select>
        </div>
        <div class="form-group" *ngIf="newItemCurrency !== 'CAD'">
          <label for="exchangeRate">{{ 'spending.exchangeRate' | translate }}</label>
          <input 
            type="number" 
            id="exchangeRate" 
            [(ngModel)]="newItemExchangeRate"
            [placeholder]="'spending.rateToCad' | translate"
            step="0.0001"
            min="0"
            class="form-control">
        </div>
      </div>

      <!-- Money Allocations -->
      <div class="money-allocations-section">
        <h3>{{ 'spending.moneyAllocations' | translate }}</h3>
        <p class="allocation-hint">
          <span class="info-icon">â„¹ï¸</span>
          <ng-container *ngIf="selectedCategoryAllowsCap() && selectedCategoryAllowsOm()">
            {{ 'spending.allocationRequired' | translate }}
          </ng-container>
          <ng-container *ngIf="selectedCategoryAllowsCap() && !selectedCategoryAllowsOm()">
            {{ 'spending.capOnlyHint' | translate }}
          </ng-container>
          <ng-container *ngIf="!selectedCategoryAllowsCap() && selectedCategoryAllowsOm()">
            {{ 'spending.omOnlyHint' | translate }}
          </ng-container>
        </p>
        <div class="allocations-table">
          <table>
            <thead>
              <tr>
                <th>{{ 'spending.moneyType' | translate }}</th>
                <th *ngIf="selectedCategoryAllowsCap()">{{ 'spending.capAmount' | translate }}</th>
                <th *ngIf="selectedCategoryAllowsOm()">{{ 'spending.omAmount' | translate }}</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let allocation of newItemMoneyAllocations">
                <td class="money-name">
                  {{ allocation.moneyName }}
                </td>
                <td *ngIf="selectedCategoryAllowsCap()">
                  <input 
                    type="text"
                    currencyInput
                    [(ngModel)]="allocation.capAmount"
                    class="form-control amount-input">
                </td>
                <td *ngIf="selectedCategoryAllowsOm()">
                  <input 
                    type="text"
                    currencyInput
                    [(ngModel)]="allocation.omAmount"
                    class="form-control amount-input">
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="form-actions">
        <button class="btn btn-secondary" (click)="cancelCreate()">{{ 'common.cancel' | translate }}</button>
        <button 
          class="btn btn-primary" 
          (click)="createSpendingItem()"
          [disabled]="!newItemName.trim() || !newItemCategoryId || isCreating || !hasValidMoneyAllocation()">
          {{ isCreating ? ('common.creating' | translate) : ('spending.createItem' | translate) }}
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading" *ngIf="isLoadingItems">
    <div class="loading-spinner"></div>
    <p>{{ 'spending.loadingItems' | translate }}</p>
  </div>

  <!-- Empty State - No items match filter -->
  <div class="empty-state" *ngIf="!isLoadingItems && spendingItems.length > 0 && filteredSpendingItems.length === 0 && !showCreateForm">
    <div class="empty-icon">ğŸ”</div>
    <h3>{{ 'spending.noMatchingItems' | translate }}</h3>
    <p>{{ 'spending.noMatchingItemsHint' | translate }}</p>
    <button class="btn btn-secondary" (click)="clearSearch(); selectedCategoryId = null">
      {{ 'common.clearFilters' | translate }}
    </button>
  </div>

  <!-- Empty State - No items exist -->
  <div class="empty-state" *ngIf="!isLoadingItems && spendingItems.length === 0 && !showCreateForm">
    <div class="empty-icon">ğŸ’°</div>
    <h3>{{ 'spending.noItemsYet' | translate }}</h3>
    <p>{{ 'spending.noItemsHint' | translate }}</p>
    <button class="btn btn-primary" (click)="showCreate()" *ngIf="canWrite && categories.length > 0">
      {{ 'spending.createFirstItem' | translate }}
    </button>
    <p class="hint" *ngIf="categories.length === 0">
      {{ 'spending.configureCategoriesFirst' | translate }}
    </p>
  </div>

  <!-- Spending Items List - Grouped by Category -->
  <div class="items-list grouped" *ngIf="!isLoadingItems && filteredSpendingItems.length > 0 && displayPreferences.groupByCategory">
    <ng-container *ngFor="let group of groupedSpendingItems; trackBy: trackByGroupName">
      <div class="category-group-header">
        <span class="category-group-name">{{ group.categoryName }}</span>
        <span class="category-group-count">({{ group.items.length }} {{ group.items.length === 1 ? ('common.item' | translate) : ('common.items' | translate) }})</span>
      </div>
      <div class="item-card" *ngFor="let item of group.items; trackBy: trackByItemId" [class.expanded]="expandedItemId === item.id" [id]="'spending-item-' + item.id">
        <ng-container *ngTemplateOutlet="spendingItemCardTemplate; context: { item: item }"></ng-container>
      </div>
    </ng-container>
  </div>

  <!-- Spending Items List - Flat View (no grouping) -->
  <div class="items-list" *ngIf="!isLoadingItems && filteredSpendingItems.length > 0 && !displayPreferences.groupByCategory">
    <div class="item-card" *ngFor="let item of filteredSpendingItems; trackBy: trackByItemId" [class.expanded]="expandedItemId === item.id" [id]="'spending-item-' + item.id">
      <ng-container *ngTemplateOutlet="spendingItemCardTemplate; context: { item: item }"></ng-container>
    </div>
  </div>

  <!-- Spending Item Card Template (reused for both grouped and flat views) -->
  <ng-template #spendingItemCardTemplate let-item="item">
    <!-- Item Summary Row -->
    <div class="item-summary" (click)="toggleItemDetails(item)">
      <div class="item-info">
        <span class="item-name">{{ item.name }}</span>
        <span class="procurement-indicator" *ngIf="item.procurementItemId" [title]="('spending.linkedTo' | translate) + ': ' + (item.procurementItemName || ('spending.procurementItem' | translate))">ğŸ“¦</span>
        <span class="warning-indicator" *ngIf="item.procurementItemId && hasPriceMismatch(item)" [title]="'spending.priceMismatchWarning' | translate">âš ï¸</span>
        <span class="warning-indicator invoice-warning" *ngIf="hasInvoiceMismatch(item)" [title]="'spending.invoiceMismatchTooltip' | translate">ğŸ§¾âš ï¸</span>
        <span class="category-badge" *ngIf="item.categoryName && !displayPreferences.groupByCategory">{{ getCategoryDisplayNameById(item.categoryId, item.categoryName) }}</span>
        <!-- Tracking Status Badge - Shows procurement tracking for linked items, spending event for standalone -->
        <span class="tracking-badge" *ngIf="item.procurementItemId && item.procurementMostRecentEventType" 
              [ngClass]="getTrackingStatusClass(item.procurementMostRecentEventType)"
              [title]="('spending.procurementTracking' | translate) + ': ' + getEventTypeLabel(item.procurementMostRecentEventType)">
          {{ getEventTypeIcon(item.procurementMostRecentEventType) }} {{ getEventTypeLabel(item.procurementMostRecentEventType) }}
        </span>
        <span class="tracking-badge" *ngIf="!item.procurementItemId && item.mostRecentEventType"
              [ngClass]="getSpendingEventStatusClass(item.mostRecentEventType)"
              [title]="('spending.tracking' | translate) + ': ' + getSpendingEventLabel(item.mostRecentEventType)">
          {{ getSpendingEventIcon(item.mostRecentEventType) }} {{ getSpendingEventLabel(item.mostRecentEventType) }}
        </span>
        <span class="currency-badge" [class.foreign-currency]="item.currency !== 'CAD'">
          {{ getCurrencyFlag(item.currency) }} {{ item.currency }}
        </span>
        <span class="total-amount">{{ formatCurrency(calculateTotal(item), item.currency) }}</span>
      </div>
      <div class="item-actions">
        <button
          class="btn-icon expand-btn"
          [title]="expandedItemId === item.id ? ('common.collapse' | translate) : ('common.expand' | translate)"
          (click)="toggleItemDetails(item); $event.stopPropagation()"
        >
          {{ expandedItemId === item.id ? 'â–²' : 'â–¼' }}
        </button>
        <button
          class="btn-icon btn-edit"
          [title]="'common.edit' | translate"
          *ngIf="canWrite && editingItemId !== item.id"
          (click)="startEditSpendingItem(item); $event.stopPropagation()"
        >
          âœï¸
        </button>
        <button
          class="btn-icon btn-delete"
          [title]="item.procurementItemId ? ('spending.cannotDeleteLinked' | translate) : ('common.delete' | translate)"
          *ngIf="canWrite"
          [disabled]="!!item.procurementItemId"
          [class.disabled]="!!item.procurementItemId"
          (click)="!item.procurementItemId && deleteSpendingItem(item); $event.stopPropagation()"
        >
          ğŸ—‘ï¸
        </button>
      </div>
    </div>

    <!-- Expanded Details Section -->
    <div class="item-details" *ngIf="expandedItemId === item.id">
      <!-- View Mode -->
      <div class="details-content" *ngIf="editingItemId !== item.id">
        <div class="info-grid">
          <div class="info-item" *ngIf="item.description">
            <label>{{ 'common.description' | translate }}</label>
            <span>{{ item.description }}</span>
          </div>
          <div class="info-item" *ngIf="item.vendor">
            <label>{{ 'spending.vendor' | translate }}</label>
            <span>{{ item.vendor }}</span>
          </div>
          <div class="info-item" *ngIf="item.referenceNumber">
            <label>{{ 'spending.referenceNumber' | translate }}</label>
            <span>{{ item.referenceNumber }}</span>
          </div>
          <!-- ECO Amount for standalone items -->
          <div class="info-item" *ngIf="!item.procurementItemId && item.ecoAmount != null">
            <label>{{ 'spending.ecoAmount' | translate }}</label>
            <span>{{ formatCurrency(item.ecoAmount, item.currency) }}</span>
          </div>
          <div class="info-item" *ngIf="item.currency !== 'CAD' && item.exchangeRate">
            <label>{{ 'spending.exchangeRate' | translate }}</label>
            <span>1 {{ item.currency }} = {{ item.exchangeRate }} CAD</span>
          </div>
          <!-- Linked Procurement Item (compact box with status) -->
          <div class="info-item procurement-link-box" *ngIf="item.procurementItemId">
            <label>{{ 'spending.linkedProcurement' | translate }}</label>
            <div class="procurement-link-content">
              <div class="procurement-row-compact">
                <div class="procurement-item-link">
                  <span class="procurement-name">{{ item.procurementItemName || ('spending.procurementItem' | translate) }}</span>
                </div>
                <button 
                  class="btn-link" 
                  [title]="'spending.viewInProcurement' | translate"
                  (click)="viewLinkedProcurement()">
                  {{ 'common.view' | translate }} â†’
                </button>
              </div>
              <!-- Latest Procurement Tracking Event -->
              <div class="procurement-tracking-compact" *ngIf="item.procurementMostRecentEventType">
                <span class="tracking-label">{{ 'spending.latestStatus' | translate }}:</span>
                <span class="event-type-badge compact" [ngClass]="getTrackingStatusClass(item.procurementMostRecentEventType)">
                  {{ getEventTypeIcon(item.procurementMostRecentEventType) }} {{ getEventTypeLabel(item.procurementMostRecentEventType) }}
                </span>
                <span class="tracking-date" *ngIf="item.procurementMostRecentEventDate">
                  ({{ item.procurementMostRecentEventDate | date:'dd/MM/yyyy' }})
                </span>
              </div>
              <!-- Procurement Price Display (inline) -->
              <div class="procurement-price-inline" *ngIf="item.procurementFinalPrice != null || item.procurementQuotedPrice != null">
                <span class="price-row" *ngIf="item.procurementFinalPrice != null">
                  <span class="price-label">{{ 'procurement.finalPrice' | translate }}:</span>
                  <span class="price-value">
                    {{ formatCurrency(item.procurementFinalPrice, item.procurementPriceCurrency || 'CAD') }}
                    <span class="price-cad" *ngIf="item.procurementPriceCurrency !== 'CAD' && item.procurementFinalPriceCad != null">
                      ({{ formatCurrency(item.procurementFinalPriceCad, 'CAD') }})
                    </span>
                  </span>
                </span>
                <span class="price-row" *ngIf="item.procurementFinalPrice == null && item.procurementQuotedPrice != null">
                  <span class="price-label">{{ 'procurement.quotedPrice' | translate }}:</span>
                  <span class="price-value">
                    {{ formatCurrency(item.procurementQuotedPrice, item.procurementPriceCurrency || 'CAD') }}
                    <span class="price-cad" *ngIf="item.procurementPriceCurrency !== 'CAD' && item.procurementQuotedPriceCad != null">
                      ({{ formatCurrency(item.procurementQuotedPriceCad, 'CAD') }})
                    </span>
                  </span>
                </span>
              </div>
              <!-- Price Mismatch Warning -->
              <div class="price-mismatch-warning" *ngIf="hasPriceMismatch(item)">
                <span class="warning-icon">âš ï¸</span>
                <span class="warning-text">{{ 'spending.priceMismatchWarning' | translate }}</span>
                <span class="warning-details">
                  {{ 'spending.spendingTotal' | translate }}: {{ formatCurrency(calculateTotal(item), item.currency) }}
                  <span *ngIf="item.currency !== 'CAD'"> ({{ formatCurrency(calculateTotalCad(item), 'CAD') }})</span>
                  vs
                  {{ 'spending.procurementPrice' | translate }}: {{ formatCurrency(getProcurementPriceCad(item), 'CAD') }}
                </span>
              </div>
            </div>
          </div>
        </div>
        <!-- Money Allocations -->
        <div class="money-section" *ngIf="item.moneyAllocations && item.moneyAllocations.length > 0">
          <label>{{ 'spending.moneyAllocations' | translate }}</label>
          <div class="money-grid">
            <div class="money-row" *ngFor="let allocation of item.moneyAllocations">
              <span class="money-label">{{ allocation.moneyName || 'AB' }}:</span>
              <span class="money-amounts">
                <ng-container *ngIf="categoryAllowsCapById(item.categoryId)">
                  CAP: {{ formatCurrency(allocation.capAmount, item.currency) }}
                </ng-container>
                <ng-container *ngIf="categoryAllowsCapById(item.categoryId) && categoryAllowsOmById(item.categoryId)">, </ng-container>
                <ng-container *ngIf="categoryAllowsOmById(item.categoryId)">
                  OM: {{ formatCurrency(allocation.omAmount, item.currency) }}
                </ng-container>
              </span>
            </div>
          </div>
        </div>
        
        <!-- Tracking Events Section for non-procurement-linked items -->
        <div class="tracking-section standalone-tracking" *ngIf="!item.procurementItemId">
          <div class="section-header">
            <label>ğŸ“‹ {{ 'spending.trackingEvents' | translate }} ({{ getEventCount(item) }})</label>
            <button 
              class="btn btn-primary" 
              *ngIf="canWrite && addEventItemId !== item.id"
              (click)="openAddEventForm(item)">
              â• {{ 'spending.addEvent' | translate }}
            </button>
          </div>
          
          <!-- Inline Add Event Form -->
          <div class="add-event-form" *ngIf="addEventItemId === item.id">
            <form (ngSubmit)="createSpendingEvent()">
              <div class="form-row">
                <div class="form-group">
                  <label for="newEventType">{{ 'spending.eventType' | translate }} *</label>
                  <select 
                    id="newEventType" 
                    [(ngModel)]="newEventType" 
                    name="newEventType"
                    required>
                    <option *ngFor="let type of eventTypeOptions" [value]="type">
                      {{ getSpendingEventIcon(type) }} {{ getSpendingEventLabel(type) }}
                    </option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="newEventDate">{{ 'common.date' | translate }} *</label>
                  <input
                    type="text"
                    dateInput
                    id="newEventDate"
                    [(ngModel)]="newEventDate"
                    name="newEventDate"
                    required
                  />
                </div>
              </div>
              <div class="form-group">
                <label for="newEventComment">{{ 'spending.comment' | translate }}</label>
                <textarea
                  id="newEventComment"
                  [(ngModel)]="newEventComment"
                  name="newEventComment"
                  rows="2"
                  [placeholder]="'spending.optionalComment' | translate"
                ></textarea>
              </div>
              <div class="form-actions">
                <button type="button" class="btn btn-secondary" (click)="closeAddEventForm()">{{ 'common.cancel' | translate }}</button>
                <button 
                  type="submit" 
                  class="btn btn-primary" 
                  [disabled]="isCreatingEvent || !newEventDate">
                  {{ isCreatingEvent ? ('spending.adding' | translate) : ('spending.addEvent' | translate) }}
                </button>
              </div>
            </form>
          </div>
          
          <div class="events-list" *ngIf="selectedItemEvents.length > 0 && selectedEventItemId === item.id">
            <div class="events-list-header">
              <button class="btn-toggle" (click)="collapseEvents()">
                {{ 'common.hideAll' | translate }} â–¼
              </button>
            </div>
            <div class="events-timeline">
              <div class="event-item" *ngFor="let event of selectedItemEvents"
                   [ngClass]="getSpendingEventStatusClass(event.eventType)">
                <div class="event-icon">{{ getSpendingEventIcon(event.eventType) }}</div>
                <!-- View Mode -->
                <ng-container *ngIf="editingEventId !== event.id">
                  <div class="event-content">
                    <div class="event-header">
                      <span class="event-type">{{ getSpendingEventLabel(event.eventType) }}</span>
                      <span class="event-date">{{ event.eventDate | date:'dd/MM/yyyy' }}</span>
                    </div>
                    <p class="event-comment" *ngIf="event.comment">{{ event.comment }}</p>
                    <div class="event-meta">
                      <span class="created-by" *ngIf="event.createdBy">{{ event.createdBy }}</span>
                    </div>
                  </div>
                  <div class="event-actions" *ngIf="canWrite">
                    <button class="btn-icon btn-edit" (click)="editEvent(event)" [title]="'common.edit' | translate">âœï¸</button>
                    <button class="btn-icon btn-delete" (click)="deleteEvent(event)" [title]="'common.delete' | translate">ğŸ—‘ï¸</button>
                  </div>
                </ng-container>
              <!-- Edit Mode -->
              <div class="edit-event-form" *ngIf="editingEventId === event.id">
                <form (ngSubmit)="updateSpendingEvent()">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="editEventType">{{ 'spending.eventType' | translate }} *</label>
                      <select
                        id="editEventType"
                        [(ngModel)]="editEventType"
                        name="editEventType"
                        required>
                        <option *ngFor="let type of eventTypeOptions" [value]="type">
                          {{ getSpendingEventIcon(type) }} {{ getSpendingEventLabel(type) }}
                        </option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label for="editEventDate">{{ 'common.date' | translate }} *</label>
                      <input
                        type="text"
                        dateInput
                        id="editEventDate"
                        [(ngModel)]="editEventDate"
                        name="editEventDate"
                        required
                      />
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="editEventComment">{{ 'spending.comment' | translate }}</label>
                    <textarea
                      id="editEventComment"
                      [(ngModel)]="editEventComment"
                      name="editEventComment"
                      rows="2"
                      [placeholder]="'spending.optionalComment' | translate"
                    ></textarea>
                  </div>
                  <div class="form-actions">
                    <button type="button" class="btn btn-secondary" (click)="cancelEditEvent()">{{ 'common.cancel' | translate }}</button>
                    <button
                      type="submit"
                      class="btn btn-primary"
                      [disabled]="isUpdatingEvent || !editEventDate">
                      {{ isUpdatingEvent ? ('common.updating' | translate) : ('common.save' | translate) }}
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          </div>
          <div class="events-collapsed" *ngIf="(selectedItemEvents.length === 0 || selectedEventItemId !== item.id) && item.mostRecentEventType && addEventItemId !== item.id">
            <div class="event-item collapsed-event" [ngClass]="getSpendingEventStatusClass(item.mostRecentEventType)">
              <div class="event-icon">{{ getSpendingEventIcon(item.mostRecentEventType) }}</div>
              <div class="event-content">
                <div class="event-header">
                  <span class="event-type">{{ getSpendingEventLabel(item.mostRecentEventType) }}</span>
                  <span class="event-date" *ngIf="item.mostRecentEventDate">{{ item.mostRecentEventDate | date:'dd/MM/yyyy' }}</span>
                </div>
              </div>
            </div>
            <button class="btn-link" (click)="loadEventsForItem(item)">{{ 'common.showAll' | translate }} â–¶</button>
          </div>
          <div class="empty-state" *ngIf="!item.mostRecentEventType && (selectedItemEvents.length === 0 || selectedEventItemId !== item.id) && addEventItemId !== item.id">
            <p>{{ 'spending.noEvents' | translate }}</p>
            <p class="hint" *ngIf="canWrite">{{ 'spending.noEventsHint' | translate }}</p>
          </div>
        </div>

        <!-- Invoices/Receipts Section -->
        <div class="invoices-section">
          <div class="section-header">
            <label>ğŸ§¾ {{ 'spending.invoicesReceipts' | translate }} ({{ item.invoiceCount || 0 }})</label>
            <span class="invoice-total-badge" *ngIf="item.invoiceCount && item.invoiceCount > 0">
              {{ 'spending.invoiceTotal' | translate }}: {{ formatCurrency(getInvoiceTotalDisplay(item), item.currency) }}
              <span class="invoice-mismatch-icon" *ngIf="hasInvoiceMismatch(item)" [title]="('spending.invoiceMismatchTooltip' | translate) + ' ' + ('spending.spendingTotal' | translate) + ': ' + formatCurrency(calculateTotal(item), item.currency) + ' vs ' + ('spending.invoiceTotal' | translate) + ': ' + formatCurrency(getInvoiceTotalDisplay(item), item.currency)">
                âš ï¸
              </span>
            </span>
            <div class="section-actions">
              <button class="btn btn-primary" *ngIf="canWrite && addInvoiceItemId !== item.id" (click)="openAddInvoiceForm(item)">
                â• {{ 'spending.addInvoice' | translate }}
              </button>
            </div>
          </div>

          <!-- Inline Add Invoice Form -->
          <div class="add-invoice-form" *ngIf="addInvoiceItemId === item.id">
            <form (ngSubmit)="createInvoice()">
              <div class="form-row three-cols">
                <div class="form-group">
                  <label for="newInvoiceAmount">{{ 'spending.invoiceAmount' | translate }} *</label>
                  <input type="text" currencyInput id="newInvoiceAmount" [(ngModel)]="newInvoiceAmount" name="newInvoiceAmount" required />
                </div>
                <div class="form-group">
                  <label for="newInvoiceCurrency">{{ 'spending.currency' | translate }}</label>
                  <select id="newInvoiceCurrency" [(ngModel)]="newInvoiceCurrency" name="newInvoiceCurrency">
                    <option *ngFor="let currency of currencies" [value]="currency.code">{{ getCurrencyFlag(currency.code) }} {{ currency.code }}</option>
                  </select>
                </div>
                <div class="form-group" *ngIf="newInvoiceCurrency !== 'CAD'">
                  <label for="newInvoiceExchangeRate">{{ 'spending.exchangeRate' | translate }}</label>
                  <input type="number" id="newInvoiceExchangeRate" [(ngModel)]="newInvoiceExchangeRate" name="newInvoiceExchangeRate" step="0.000001" min="0" />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="newInvoiceDateReceived">{{ 'spending.dateReceived' | translate }}</label>
                  <input type="text" dateInput id="newInvoiceDateReceived" [(ngModel)]="newInvoiceDateReceived" name="newInvoiceDateReceived" />
                </div>
                <div class="form-group">
                  <label for="newInvoiceDateProcessed">{{ 'spending.dateProcessed' | translate }}</label>
                  <input type="text" dateInput id="newInvoiceDateProcessed" [(ngModel)]="newInvoiceDateProcessed" name="newInvoiceDateProcessed" />
                </div>
              </div>
              <div class="form-group">
                <label for="newInvoiceComments">{{ 'spending.invoiceComments' | translate }}</label>
                <textarea id="newInvoiceComments" [(ngModel)]="newInvoiceComments" name="newInvoiceComments" rows="2" [placeholder]="'spending.optionalComment' | translate"></textarea>
              </div>
              <!-- File attachment during creation -->
              <div class="form-group file-attach-section">
                <label>{{ 'spending.attachFile' | translate }}</label>
                <div class="file-attach-row">
                  <label class="btn-file-select">
                    ğŸ“ {{ 'spending.selectFile' | translate }}
                    <input type="file" (change)="onNewInvoiceFileSelected($event)" style="display: none"
                           accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.xls,.xlsx,.txt,.csv" />
                  </label>
                  <div class="selected-file-preview" *ngIf="newInvoiceFile">
                    <span class="file-icon">ğŸ“</span>
                    <span class="file-name">{{ newInvoiceFileName }}</span>
                    <button type="button" class="btn-icon btn-small" (click)="removeNewInvoiceFile()" [title]="'common.remove' | translate">âœ•</button>
                  </div>
                </div>
              </div>
              <div class="form-actions">
                <button type="button" class="btn btn-secondary" (click)="closeAddInvoiceForm()">{{ 'common.cancel' | translate }}</button>
                <button type="submit" class="btn btn-primary" [disabled]="isCreatingInvoice || !newInvoiceAmount">
                  {{ isCreatingInvoice ? ('common.creating' | translate) : ('spending.addInvoice' | translate) }}
                </button>
              </div>
            </form>
          </div>

          <!-- Invoices List -->
          <div class="invoices-list" *ngIf="selectedItemInvoices.length > 0 && invoiceItemId === item.id">
            <div class="invoices-list-header">
              <button class="btn-toggle" (click)="collapseInvoices()">{{ 'common.hideAll' | translate }} â–¼</button>
            </div>
            <div class="invoice-item" *ngFor="let invoice of selectedItemInvoices">
              <ng-container *ngIf="editingInvoiceId !== invoice.id">
                <div class="invoice-icon">ğŸ§¾</div>
                <div class="invoice-content">
                  <div class="invoice-header">
                    <span class="invoice-amount">{{ formatCurrency(invoice.amount, invoice.currency) }}</span>
                    <span class="invoice-currency-badge" *ngIf="invoice.currency !== 'CAD'">
                      {{ getCurrencyFlag(invoice.currency) }} {{ invoice.currency }}
                      ({{ formatCurrency(invoice.amountCad, 'CAD') }})
                    </span>
                  </div>
                  <div class="invoice-details">
                    <span class="invoice-date" *ngIf="invoice.dateReceived">
                      <span class="detail-label">{{ 'spending.received' | translate }}:</span> {{ invoice.dateReceived }}
                    </span>
                    <span class="invoice-date" *ngIf="invoice.dateProcessed">
                      <span class="detail-label">{{ 'spending.processed' | translate }}:</span> {{ invoice.dateProcessed }}
                    </span>
                  </div>
                  <p class="invoice-comment" *ngIf="invoice.comments">{{ invoice.comments }}</p>

                  <!-- Invoice Files -->
                  <div class="invoice-files-section" *ngIf="(invoice.files && invoice.files.length > 0) || canWrite">
                    <div class="invoice-files-list" *ngIf="invoice.files && invoice.files.length > 0">
                      <div class="file-item" *ngFor="let file of invoice.files">
                        <span class="file-icon">ğŸ“</span>
                        <div class="file-info">
                          <span class="file-name">{{ file.fileName }}</span>
                          <span class="file-size">({{ file.formattedFileSize }})</span>
                        </div>
                        <div class="file-actions">
                          <a class="btn-icon" [href]="getInvoiceFileViewUrl(invoice, file)" target="_blank" [title]="'common.view' | translate">ğŸ‘ï¸</a>
                          <a class="btn-icon" [href]="getInvoiceFileDownloadUrl(invoice, file)" [title]="'common.download' | translate">â¬‡ï¸</a>
                          <label class="btn-icon btn-replace" *ngIf="canWrite" [title]="'spending.replaceFile' | translate">
                            ğŸ”„
                            <input type="file" (change)="replaceInvoiceFile($event, invoice, file)" style="display: none"
                                   accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.xls,.xlsx,.txt,.csv" />
                          </label>
                          <button class="btn-icon btn-danger" *ngIf="canWrite" (click)="deleteInvoiceFile(invoice, file)" [title]="'common.delete' | translate">ğŸ—‘ï¸</button>
                        </div>
                      </div>
                    </div>
                    <!-- Upload file button -->
                    <div class="invoice-upload-row" *ngIf="canWrite">
                      <label class="btn-file-select small">
                        ğŸ“¤ {{ 'spending.uploadFile' | translate }}
                        <input type="file" (change)="onInvoiceFileSelected($event, invoice)" style="display: none"
                               accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.xls,.xlsx,.txt,.csv" />
                      </label>
                    </div>
                  </div>

                  <div class="invoice-meta">
                    <span class="created-by" *ngIf="invoice.createdBy">{{ invoice.createdBy }}</span>
                  </div>
                </div>
                <div class="invoice-actions" *ngIf="canWrite">
                  <button class="btn-icon" (click)="editInvoice(invoice)" [title]="'common.edit' | translate">âœï¸</button>
                  <button class="btn-icon btn-danger" (click)="deleteInvoice(invoice)" [title]="'common.delete' | translate">ğŸ—‘ï¸</button>
                </div>
              </ng-container>

              <!-- Edit Invoice Mode -->
              <div class="edit-invoice-form" *ngIf="editingInvoiceId === invoice.id">
                <form (ngSubmit)="updateInvoice()">
                  <div class="form-row three-cols">
                    <div class="form-group">
                      <label for="editInvoiceAmount">{{ 'spending.invoiceAmount' | translate }} *</label>
                      <input type="text" currencyInput id="editInvoiceAmount" [(ngModel)]="editInvoiceAmount" name="editInvoiceAmount" required />
                    </div>
                    <div class="form-group">
                      <label for="editInvoiceCurrency">{{ 'spending.currency' | translate }}</label>
                      <select id="editInvoiceCurrency" [(ngModel)]="editInvoiceCurrency" name="editInvoiceCurrency">
                        <option *ngFor="let currency of currencies" [value]="currency.code">{{ getCurrencyFlag(currency.code) }} {{ currency.code }}</option>
                      </select>
                    </div>
                    <div class="form-group" *ngIf="editInvoiceCurrency !== 'CAD'">
                      <label for="editInvoiceExchangeRate">{{ 'spending.exchangeRate' | translate }}</label>
                      <input type="number" id="editInvoiceExchangeRate" [(ngModel)]="editInvoiceExchangeRate" name="editInvoiceExchangeRate" step="0.000001" min="0" />
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="editInvoiceDateReceived">{{ 'spending.dateReceived' | translate }}</label>
                      <input type="text" dateInput id="editInvoiceDateReceived" [(ngModel)]="editInvoiceDateReceived" name="editInvoiceDateReceived" />
                    </div>
                    <div class="form-group">
                      <label for="editInvoiceDateProcessed">{{ 'spending.dateProcessed' | translate }}</label>
                      <input type="text" dateInput id="editInvoiceDateProcessed" [(ngModel)]="editInvoiceDateProcessed" name="editInvoiceDateProcessed" />
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="editInvoiceComments">{{ 'spending.invoiceComments' | translate }}</label>
                    <textarea id="editInvoiceComments" [(ngModel)]="editInvoiceComments" name="editInvoiceComments" rows="2" [placeholder]="'spending.optionalComment' | translate"></textarea>
                  </div>
                  <div class="form-actions">
                    <button type="button" class="btn btn-secondary" (click)="cancelEditInvoice()">{{ 'common.cancel' | translate }}</button>
                    <button type="submit" class="btn btn-primary" [disabled]="isUpdatingInvoice || !editInvoiceAmount">
                      {{ isUpdatingInvoice ? ('common.updating' | translate) : ('common.save' | translate) }}
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Collapsed invoices summary -->
          <div class="invoices-collapsed" *ngIf="(selectedItemInvoices.length === 0 || invoiceItemId !== item.id) && item.invoiceCount && item.invoiceCount > 0 && addInvoiceItemId !== item.id">
            <div class="invoice-summary-row">
              <span class="invoice-count">{{ item.invoiceCount }} {{ item.invoiceCount === 1 ? ('spending.invoice' | translate) : ('spending.invoicesLabel' | translate) }}</span>
              <span class="invoice-total-compact">{{ formatCurrency(getInvoiceTotalDisplay(item), item.currency) }}</span>
              <span class="invoice-mismatch-icon" *ngIf="hasInvoiceMismatch(item)" [title]="('spending.invoiceMismatchTooltip' | translate) + ' ' + ('spending.spendingTotal' | translate) + ': ' + formatCurrency(calculateTotal(item), item.currency) + ' vs ' + ('spending.invoiceTotal' | translate) + ': ' + formatCurrency(getInvoiceTotalDisplay(item), item.currency)">âš ï¸</span>
            </div>
            <button class="btn-link" (click)="loadInvoicesForItem(item)">{{ 'common.showAll' | translate }} â–¶</button>
          </div>

          <!-- No invoices -->
          <div class="empty-state" *ngIf="(!item.invoiceCount || item.invoiceCount === 0) && (selectedItemInvoices.length === 0 || invoiceItemId !== item.id) && addInvoiceItemId !== item.id">
            <p>{{ 'spending.noInvoices' | translate }}</p>
            <p class="hint" *ngIf="canWrite">{{ 'spending.noInvoicesHint' | translate }}</p>
          </div>
        </div>
      </div>

      <!-- Edit Mode -->
      <div class="edit-form" *ngIf="editingItemId === item.id">
        <h4>{{ 'spending.editItem' | translate }}</h4>
        
        <!-- Linked Procurement Info (Read-only) -->
        <div class="edit-procurement-link-box" *ngIf="item.procurementItemId">
          <div class="procurement-link-header">
            <span class="procurement-icon">ğŸ“¦</span>
            <label>{{ 'spending.linkedProcurement' | translate }}</label>
          </div>
          <div class="procurement-link-content">
            <div class="procurement-item-link">
              <span class="procurement-name">{{ item.procurementItemName || ('spending.procurementItem' | translate) }}</span>
              <button 
                class="btn-link" 
                type="button"
                [title]="'spending.viewInProcurement' | translate"
                (click)="viewLinkedProcurement()">
                {{ 'common.view' | translate }} â†’
              </button>
            </div>
            <!-- Procurement Price Display -->
            <div class="procurement-price-info" *ngIf="item.procurementFinalPrice != null || item.procurementQuotedPrice != null">
              <div class="price-row" *ngIf="item.procurementFinalPrice != null">
                <span class="price-label">{{ 'procurement.finalPrice' | translate }}:</span>
                <span class="price-value">
                  {{ formatCurrency(item.procurementFinalPrice, item.procurementPriceCurrency || 'CAD') }}
                  <span class="price-cad" *ngIf="item.procurementPriceCurrency !== 'CAD' && item.procurementFinalPriceCad != null">
                    ({{ formatCurrency(item.procurementFinalPriceCad, 'CAD') }})
                  </span>
                </span>
              </div>
              <div class="price-row" *ngIf="item.procurementFinalPrice == null && item.procurementQuotedPrice != null">
                <span class="price-label">{{ 'procurement.quotedPrice' | translate }}:</span>
                <span class="price-value">
                  {{ formatCurrency(item.procurementQuotedPrice, item.procurementPriceCurrency || 'CAD') }}
                  <span class="price-cad" *ngIf="item.procurementPriceCurrency !== 'CAD' && item.procurementQuotedPriceCad != null">
                    ({{ formatCurrency(item.procurementQuotedPriceCad, 'CAD') }})
                  </span>
                </span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="editItemName">{{ 'common.name' | translate }} <span class="required">*</span></label>
            <input
              id="editItemName"
              type="text"
              [(ngModel)]="editItemName"
              [placeholder]="'spending.enterItemName' | translate"
              [disabled]="isUpdating"
              required
            />
          </div>
          <div class="form-group">
            <label for="editItemDescription">{{ 'common.description' | translate }}</label>
            <input
              id="editItemDescription"
              type="text"
              [(ngModel)]="editItemDescription"
              [placeholder]="'spending.optionalDescription' | translate"
              [disabled]="isUpdating"
            />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="editItemVendor">{{ 'spending.vendor' | translate }}</label>
            <input
              id="editItemVendor"
              type="text"
              [(ngModel)]="editItemVendor"
              [placeholder]="'spending.vendorName' | translate"
              [disabled]="isUpdating"
            />
          </div>
          <div class="form-group">
            <label for="editItemReferenceNumber">{{ 'spending.referenceNumber' | translate }}</label>
            <input
              id="editItemReferenceNumber"
              type="text"
              [(ngModel)]="editItemReferenceNumber"
              [placeholder]="'spending.referenceNumber' | translate"
              [disabled]="isUpdating"
            />
          </div>
          <!-- ECO Amount for standalone items -->
          <div class="form-group" *ngIf="!item.procurementItemId">
            <label for="editItemEcoAmount">{{ 'spending.ecoAmount' | translate }}</label>
            <input
              id="editItemEcoAmount"
              type="number"
              [(ngModel)]="editItemEcoAmount"
              [placeholder]="'spending.ecoAmountPlaceholder' | translate"
              [disabled]="isUpdating"
              step="0.01"
              min="0"
            />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="editItemCurrency">{{ 'spending.currency' | translate }}</label>
            <div class="currency-selector">
              <span class="currency-flag">{{ getCurrencyFlag(editItemCurrency) }}</span>
              <select id="editItemCurrency" [(ngModel)]="editItemCurrency" [disabled]="isUpdating"
                      (change)="onEditCurrencyChange()">
                <option value="CAD">ğŸ‡¨ğŸ‡¦ CAD - Canadian Dollar</option>
                <option value="USD">ğŸ‡ºğŸ‡¸ USD - US Dollar</option>
                <option value="EUR">ğŸ‡ªğŸ‡º EUR - Euro</option>
                <option value="GBP">ğŸ‡¬ğŸ‡§ GBP - British Pound</option>
                <option value="JPY">ğŸ‡¯ğŸ‡µ JPY - Japanese Yen</option>
                <option value="AUD">ğŸ‡¦ğŸ‡º AUD - Australian Dollar</option>
                <option value="CHF">ğŸ‡¨ğŸ‡­ CHF - Swiss Franc</option>
                <option value="CNY">ğŸ‡¨ğŸ‡³ CNY - Chinese Yuan</option>
                <option value="INR">ğŸ‡®ğŸ‡³ INR - Indian Rupee</option>
                <option value="MXN">ğŸ‡²ğŸ‡½ MXN - Mexican Peso</option>
                <option value="BRL">ğŸ‡§ğŸ‡· BRL - Brazilian Real</option>
                <option value="KRW">ğŸ‡°ğŸ‡· KRW - South Korean Won</option>
                <option value="SGD">ğŸ‡¸ğŸ‡¬ SGD - Singapore Dollar</option>
                <option value="HKD">ğŸ‡­ğŸ‡° HKD - Hong Kong Dollar</option>
                <option value="NZD">ğŸ‡³ğŸ‡¿ NZD - New Zealand Dollar</option>
                <option value="SEK">ğŸ‡¸ğŸ‡ª SEK - Swedish Krona</option>
                <option value="NOK">ğŸ‡³ğŸ‡´ NOK - Norwegian Krone</option>
                <option value="DKK">ğŸ‡©ğŸ‡° DKK - Danish Krone</option>
              </select>
            </div>
          </div>
          <div class="form-group" *ngIf="editItemCurrency !== 'CAD'">
            <label for="editItemExchangeRate">{{ 'spending.exchangeRate' | translate }} <span class="required">*</span></label>
            <div class="exchange-rate-field">
              1 {{ editItemCurrency }} = 
              <input
                id="editItemExchangeRate"
                type="number"
                [(ngModel)]="editItemExchangeRate"
                [placeholder]="'spending.enterExchangeRate' | translate"
                [disabled]="isUpdating"
                step="0.000001"
                min="0.000001"
                class="exchange-rate-input"
              /> CAD
            </div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="editItemStatus">{{ 'common.status' | translate }} <span class="required">*</span></label>
            <select id="editItemStatus" [(ngModel)]="editItemStatus" [disabled]="isUpdating" required>
              <option *ngFor="let status of statusOptions" [value]="status">
                {{ getStatusLabel(status) }}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label for="editItemCategory">{{ 'common.category' | translate }}</label>
            <select 
              id="editItemCategory" 
              [(ngModel)]="editItemCategoryId" 
              [disabled]="isUpdating || isLoadingCategories"
            >
              <option [ngValue]="null">-- {{ 'spending.noCategory' | translate }} --</option>
              <option *ngFor="let category of categories" [ngValue]="category.id">
                {{ getCategoryDisplayName(category) }}
              </option>
            </select>
          </div>
        </div>

        <!-- Edit Money Allocations -->
        <div class="money-allocations" *ngIf="editItemMoneyAllocations && editItemMoneyAllocations.length > 0">
          <h4>{{ 'spending.moneyAllocations' | translate }}</h4>
          <p class="allocation-hint">
            <ng-container *ngIf="editCategoryAllowsCap() && editCategoryAllowsOm()">
              {{ 'spending.allocationHint' | translate }}
              <strong>{{ 'spending.allocationRequired' | translate }}</strong>
            </ng-container>
            <ng-container *ngIf="editCategoryAllowsCap() && !editCategoryAllowsOm()">
              {{ 'spending.capOnlyHint' | translate }}
            </ng-container>
            <ng-container *ngIf="!editCategoryAllowsCap() && editCategoryAllowsOm()">
              {{ 'spending.omOnlyHint' | translate }}
            </ng-container>
          </p>
          <div class="allocations-grid">
            <div class="allocation-row" *ngFor="let allocation of editItemMoneyAllocations; let i = index" [class.is-default]="allocation.isDefault">
              <div class="allocation-header">
                <span class="money-code">{{ allocation.moneyName }}</span>
              </div>
              <div class="allocation-inputs">
                <div class="allocation-field" *ngIf="editCategoryAllowsCap()">
                  <label [for]="'edit-cap-' + i">{{ allocation.moneyName }} (CAP)</label>
                  <input
                    [id]="'edit-cap-' + i"
                    type="text"
                    currencyInput
                    [(ngModel)]="allocation.capAmount"
                    placeholder="0.00"
                    [disabled]="isUpdating"
                    class="money-input"
                  />
                </div>
                <div class="allocation-field" *ngIf="editCategoryAllowsOm()">
                  <label [for]="'edit-om-' + i">{{ allocation.moneyName }} (O&M)</label>
                  <input
                    [id]="'edit-om-' + i"
                    type="text"
                    currencyInput
                    [(ngModel)]="allocation.omAmount"
                    placeholder="0.00"
                    [disabled]="isUpdating"
                    class="money-input"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button 
            class="btn-secondary" 
            (click)="cancelEditSpendingItem()"
            [disabled]="isUpdating"
          >
            {{ 'common.cancel' | translate }}
          </button>
          <button 
            class="btn-primary" 
            (click)="updateSpendingItem()"
            [disabled]="isUpdating || !editItemName.trim() || !hasValidEditMoneyAllocation()"
          >
            <span *ngIf="isUpdating">{{ 'common.updating' | translate }}</span>
            <span *ngIf="!isUpdating">{{ 'spending.updateItem' | translate }}</span>
          </button>
        </div>
      </div>
    </div>
  </ng-template>

  <!-- Add Button - After Items List -->
  <div class="action-bar bottom" *ngIf="canWrite && !showCreateForm && spendingItems.length > 0">
    <button class="btn btn-primary" (click)="showCreate()" [disabled]="categories.length === 0">
      + {{ 'spending.addItem' | translate }}
    </button>
  </div>

  <!-- Summary Section -->
  <div class="summary-section" [class.collapsed]="!summaryExpanded" *ngIf="spendingItems.length > 0">
    <div class="summary-header" (click)="toggleSummary()">
      <button 
        class="btn-toggle-summary" 
        [title]="summaryExpanded ? ('common.hideSummary' | translate) : ('common.showSummary' | translate)">
        <span class="toggle-icon" [class.collapsed]="!summaryExpanded">â–¼</span>
        <span class="toggle-label">{{ summaryExpanded ? ('common.hideSummary' | translate) : ('common.showSummary' | translate) }}</span>
      </button>
    </div>
    
    <div class="summary-content" *ngIf="summaryExpanded">
      <!-- Summary by Money Type -->
      <div class="summary-group">
        <h4>{{ 'spending.totalsByMoneyType' | translate }}</h4>
        <table class="summary-table">
          <thead>
            <tr>
              <th>{{ 'spending.moneyType' | translate }}</th>
              <th>{{ 'spending.totalCap' | translate }}</th>
              <th>{{ 'spending.totalOm' | translate }}</th>
              <th>{{ 'common.total' | translate }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let summary of summaryByMoneyType">
              <td>{{ summary.moneyCode }} - {{ summary.moneyName }}</td>
              <td class="amount">{{ formatCurrency(summary.totalCap) }}</td>
              <td class="amount">{{ formatCurrency(summary.totalOm) }}</td>
              <td class="amount total">{{ formatCurrency(summary.total) }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Summary by Category -->
      <div class="summary-group" *ngIf="summaryByCategory.length > 0">
        <h4>{{ 'spending.totalsByCategory' | translate }}</h4>
        <table class="summary-table">
          <thead>
            <tr>
              <th>{{ 'common.category' | translate }}</th>
              <th>{{ 'spending.totalCap' | translate }}</th>
              <th>{{ 'spending.totalOm' | translate }}</th>
              <th>{{ 'common.total' | translate }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let summary of summaryByCategory">
              <td>{{ summary.categoryName }}</td>
              <td class="amount">{{ formatCurrency(summary.totalCap) }}</td>
              <td class="amount">{{ formatCurrency(summary.totalOm) }}</td>
              <td class="amount total">{{ formatCurrency(summary.total) }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Grand Total -->
      <div class="grand-total">
        <table class="summary-table">
          <tbody>
            <tr class="grand-total-row">
              <td><strong>{{ 'spending.grandTotal' | translate }}</strong></td>
              <td class="amount"><strong>{{ formatCurrency(grandTotalCap) }}</strong></td>
              <td class="amount"><strong>{{ formatCurrency(grandTotalOm) }}</strong></td>
              <td class="amount total"><strong>{{ formatCurrency(grandTotal) }}</strong></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>