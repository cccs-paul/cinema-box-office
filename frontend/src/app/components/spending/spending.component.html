<!--
  myRC - Spending Component Template
  Copyright (c) 2026 myRC Team
  Licensed under MIT License
-->
<div class="spending-container">
  <!-- Action Bar -->
  <div class="action-bar">
    <button class="btn btn-primary" (click)="showCreate()" *ngIf="canWrite && !showCreateForm" [disabled]="categories.length === 0">
      + {{ 'spending.addItem' | translate }}
    </button>
  </div>

  <!-- Messages -->
  <div class="messages">
    <div class="alert alert-danger" *ngIf="errorMessage">
      {{ errorMessage }}
    </div>
    <div class="alert alert-success" *ngIf="successMessage">
      {{ successMessage }}
    </div>
  </div>

  <!-- Search and Category Filter -->
  <div class="filters-bar" [class.collapsed]="!filtersExpanded" *ngIf="!showCreateForm && selectedFY?.showSearchBox !== false">
    <div class="filters-header">
      <button 
        class="btn-toggle-filters" 
        (click)="toggleFilters()"
        [title]="filtersExpanded ? ('common.hideFilters' | translate) : ('common.showFilters' | translate)">
        <span class="toggle-icon" [class.collapsed]="!filtersExpanded">â–¼</span>
        <span class="toggle-label">{{ filtersExpanded ? ('common.hideFilters' | translate) : ('common.showFilters' | translate) }}</span>
      </button>
    </div>
    <div class="filters-content" *ngIf="filtersExpanded">
      <!-- Search Box -->
      <div class="search-box">
        <input
          type="text"
          [(ngModel)]="searchTerm"
          [placeholder]="'spending.searchPlaceholder' | translate"
          class="search-input"
        />
        <button 
          class="btn-clear" 
          *ngIf="searchTerm" 
          (click)="clearSearch()"
          [title]="'common.clearSearch' | translate">
          âœ•
        </button>
      </div>

      <!-- Category Filter -->
      <div class="category-filter" *ngIf="categories.length > 0 && selectedFY?.showCategoryFilter !== false">
        <span class="filter-label">{{ 'common.category' | translate }}:</span>
        <button 
          class="filter-btn"
          [class.active]="selectedCategoryId === null"
          (click)="filterByCategory(null)">
          {{ 'common.all' | translate }}
        </button>
        <button 
          *ngFor="let category of categories"
          class="filter-btn"
          [class.active]="selectedCategoryId === category.id"
          (click)="filterByCategory(category.id)">
          {{ category.name }}
        </button>
      </div>
    </div>
  </div>

  <!-- Create Form -->
  <div class="create-form-container" *ngIf="showCreateForm">
    <div class="create-form">
      <h2>{{ 'spending.createNewItem' | translate }}</h2>
      
      <div class="form-row">
        <div class="form-group">
          <label for="name">{{ 'common.name' | translate }} *</label>
          <input 
            type="text" 
            id="name" 
            [(ngModel)]="newItemName"
            [placeholder]="'spending.enterItemName' | translate"
            class="form-control">
        </div>
        <div class="form-group">
          <label for="category">{{ 'common.category' | translate }} *</label>
          <select id="category" [(ngModel)]="newItemCategoryId" (ngModelChange)="onCategoryChange()" class="form-control">
            <option *ngFor="let category of categories" [ngValue]="category.id">
              {{ category.name }}
            </option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="description">{{ 'common.description' | translate }}</label>
        <textarea 
          id="description" 
          [(ngModel)]="newItemDescription"
          [placeholder]="'spending.enterDescription' | translate"
          class="form-control"
          rows="2"></textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="vendor">{{ 'spending.vendor' | translate }}</label>
          <input 
            type="text" 
            id="vendor" 
            [(ngModel)]="newItemVendor"
            [placeholder]="'spending.vendorName' | translate"
            class="form-control">
        </div>
        <div class="form-group">
          <label for="referenceNumber">{{ 'spending.referenceNumber' | translate }}</label>
          <input 
            type="text" 
            id="referenceNumber" 
            [(ngModel)]="newItemReferenceNumber"
            [placeholder]="'spending.poInvoice' | translate"
            class="form-control">
        </div>
      </div>

      <div class="form-row" [class.three-cols]="newItemCurrency !== 'CAD'">
        <div class="form-group">
          <label for="status">{{ 'common.status' | translate }}</label>
          <select id="status" [(ngModel)]="newItemStatus" class="form-control">
            <option *ngFor="let status of statusOptions" [value]="status">
              {{ getStatusLabel(status) }}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label for="currency">{{ 'spending.currency' | translate }}</label>
          <select id="currency" [(ngModel)]="newItemCurrency" class="form-control">
            <option *ngFor="let currency of currencies" [value]="currency.code">
              {{ getCurrencyFlag(currency.code) }} {{ currency.code }} - {{ currency.name }}
            </option>
          </select>
        </div>
        <div class="form-group" *ngIf="newItemCurrency !== 'CAD'">
          <label for="exchangeRate">{{ 'spending.exchangeRate' | translate }}</label>
          <input 
            type="number" 
            id="exchangeRate" 
            [(ngModel)]="newItemExchangeRate"
            [placeholder]="'spending.rateToCad' | translate"
            step="0.0001"
            min="0"
            class="form-control">
        </div>
      </div>

      <!-- Money Allocations -->
      <div class="money-allocations-section">
        <h3>{{ 'spending.moneyAllocations' | translate }}</h3>
        <p class="allocation-hint">
          <span class="info-icon">â„¹ï¸</span>
          <ng-container *ngIf="selectedCategoryAllowsCap() && selectedCategoryAllowsOm()">
            {{ 'spending.allocationRequired' | translate }}
          </ng-container>
          <ng-container *ngIf="selectedCategoryAllowsCap() && !selectedCategoryAllowsOm()">
            {{ 'spending.capOnlyHint' | translate }}
          </ng-container>
          <ng-container *ngIf="!selectedCategoryAllowsCap() && selectedCategoryAllowsOm()">
            {{ 'spending.omOnlyHint' | translate }}
          </ng-container>
        </p>
        <div class="allocations-table">
          <table>
            <thead>
              <tr>
                <th>{{ 'spending.moneyType' | translate }}</th>
                <th *ngIf="selectedCategoryAllowsCap()">{{ 'spending.capAmount' | translate }}</th>
                <th *ngIf="selectedCategoryAllowsOm()">{{ 'spending.omAmount' | translate }}</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let allocation of newItemMoneyAllocations">
                <td class="money-name">
                  {{ allocation.moneyName }}
                </td>
                <td *ngIf="selectedCategoryAllowsCap()">
                  <input 
                    type="text"
                    currencyInput
                    [(ngModel)]="allocation.capAmount"
                    class="form-control amount-input">
                </td>
                <td *ngIf="selectedCategoryAllowsOm()">
                  <input 
                    type="text"
                    currencyInput
                    [(ngModel)]="allocation.omAmount"
                    class="form-control amount-input">
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="form-actions">
        <button class="btn btn-secondary" (click)="cancelCreate()">{{ 'common.cancel' | translate }}</button>
        <button 
          class="btn btn-primary" 
          (click)="createSpendingItem()"
          [disabled]="!newItemName.trim() || !newItemCategoryId || isCreating || !hasValidMoneyAllocation()">
          {{ isCreating ? ('common.creating' | translate) : ('spending.createItem' | translate) }}
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading" *ngIf="isLoadingItems">
    <div class="loading-spinner"></div>
    <p>{{ 'spending.loadingItems' | translate }}</p>
  </div>

  <!-- Empty State - No items match filter -->
  <div class="empty-state" *ngIf="!isLoadingItems && spendingItems.length > 0 && filteredSpendingItems.length === 0 && !showCreateForm">
    <div class="empty-icon">ğŸ”</div>
    <h3>{{ 'spending.noMatchingItems' | translate }}</h3>
    <p>{{ 'spending.noMatchingItemsHint' | translate }}</p>
    <button class="btn btn-secondary" (click)="clearSearch(); selectedCategoryId = null">
      {{ 'common.clearFilters' | translate }}
    </button>
  </div>

  <!-- Empty State - No items exist -->
  <div class="empty-state" *ngIf="!isLoadingItems && spendingItems.length === 0 && !showCreateForm">
    <div class="empty-icon">ğŸ’°</div>
    <h3>{{ 'spending.noItemsYet' | translate }}</h3>
    <p>{{ 'spending.noItemsHint' | translate }}</p>
    <button class="btn btn-primary" (click)="showCreate()" *ngIf="canWrite && categories.length > 0">
      {{ 'spending.createFirstItem' | translate }}
    </button>
    <p class="hint" *ngIf="categories.length === 0">
      {{ 'spending.configureCategoriesFirst' | translate }}
    </p>
  </div>

  <!-- Spending Items List - Grouped by Category -->
  <div class="items-list grouped" *ngIf="!isLoadingItems && filteredSpendingItems.length > 0 && selectedFY?.groupByCategory">
    <ng-container *ngFor="let group of groupedSpendingItems; trackBy: trackByGroupName">
      <div class="category-group-header">
        <span class="category-group-name">{{ group.categoryName }}</span>
        <span class="category-group-count">({{ group.items.length }} {{ group.items.length === 1 ? ('common.item' | translate) : ('common.items' | translate) }})</span>
      </div>
      <div class="item-card" *ngFor="let item of group.items; trackBy: trackByItemId" [class.expanded]="expandedItemId === item.id" [id]="'spending-item-' + item.id">
        <ng-container *ngTemplateOutlet="spendingItemCardTemplate; context: { item: item }"></ng-container>
      </div>
    </ng-container>
  </div>

  <!-- Spending Items List - Flat View (no grouping) -->
  <div class="items-list" *ngIf="!isLoadingItems && filteredSpendingItems.length > 0 && !selectedFY?.groupByCategory">
    <div class="item-card" *ngFor="let item of filteredSpendingItems; trackBy: trackByItemId" [class.expanded]="expandedItemId === item.id" [id]="'spending-item-' + item.id">
      <ng-container *ngTemplateOutlet="spendingItemCardTemplate; context: { item: item }"></ng-container>
    </div>
  </div>

  <!-- Spending Item Card Template (reused for both grouped and flat views) -->
  <ng-template #spendingItemCardTemplate let-item="item">
    <!-- Item Summary Row -->
    <div class="item-summary" (click)="toggleItemDetails(item)">
      <div class="item-info">
        <span class="item-name">{{ item.name }}</span>
        <span class="procurement-indicator" *ngIf="item.procurementItemId" [title]="('spending.linkedTo' | translate) + ': ' + (item.procurementItemName || ('spending.procurementItem' | translate))">ğŸ“¦</span>
        <span class="warning-indicator" *ngIf="item.procurementItemId && hasPriceMismatch(item)" [title]="'spending.priceMismatchWarning' | translate">âš ï¸</span>
        <span class="category-badge" *ngIf="item.categoryName && !selectedFY?.groupByCategory">{{ item.categoryName }}</span>
        <!-- Tracking Status Badge - Shows procurement tracking for linked items, spending event for standalone -->
        <span class="tracking-badge" *ngIf="item.procurementItemId && item.procurementMostRecentEventType" 
              [ngClass]="getTrackingStatusClass(item.procurementMostRecentEventType)"
              [title]="('spending.procurementTracking' | translate) + ': ' + getEventTypeLabel(item.procurementMostRecentEventType)">
          {{ getEventTypeIcon(item.procurementMostRecentEventType) }} {{ getEventTypeLabel(item.procurementMostRecentEventType) }}
        </span>
        <span class="tracking-badge" *ngIf="!item.procurementItemId && item.mostRecentEventType"
              [ngClass]="getSpendingEventStatusClass(item.mostRecentEventType)"
              [title]="('spending.tracking' | translate) + ': ' + getSpendingEventLabel(item.mostRecentEventType)">
          {{ getSpendingEventIcon(item.mostRecentEventType) }} {{ getSpendingEventLabel(item.mostRecentEventType) }}
        </span>
        <span class="currency-badge" [class.foreign-currency]="item.currency !== 'CAD'">
          {{ getCurrencyFlag(item.currency) }} {{ item.currency }}
        </span>
        <span class="total-amount">{{ formatCurrency(calculateTotal(item), item.currency) }}</span>
      </div>
      <div class="item-actions">
        <button
          class="btn-icon expand-btn"
          [title]="expandedItemId === item.id ? ('common.collapse' | translate) : ('common.expand' | translate)"
          (click)="toggleItemDetails(item); $event.stopPropagation()"
        >
          {{ expandedItemId === item.id ? 'â–²' : 'â–¼' }}
        </button>
        <button
          class="btn-icon btn-edit"
          [title]="'common.edit' | translate"
          *ngIf="canWrite && editingItemId !== item.id"
          (click)="startEditSpendingItem(item); $event.stopPropagation()"
        >
          âœï¸
        </button>
        <button
          class="btn-icon btn-delete"
          [title]="item.procurementItemId ? ('spending.cannotDeleteLinked' | translate) : ('common.delete' | translate)"
          *ngIf="canWrite"
          [disabled]="!!item.procurementItemId"
          [class.disabled]="!!item.procurementItemId"
          (click)="!item.procurementItemId && deleteSpendingItem(item); $event.stopPropagation()"
        >
          ğŸ—‘ï¸
        </button>
      </div>
    </div>

    <!-- Expanded Details Section -->
    <div class="item-details" *ngIf="expandedItemId === item.id">
      <!-- View Mode -->
      <div class="details-content" *ngIf="editingItemId !== item.id">
        <div class="info-grid">
          <div class="info-item" *ngIf="item.description">
            <label>{{ 'common.description' | translate }}</label>
            <span>{{ item.description }}</span>
          </div>
          <div class="info-item" *ngIf="item.vendor">
            <label>{{ 'spending.vendor' | translate }}</label>
            <span>{{ item.vendor }}</span>
          </div>
          <div class="info-item" *ngIf="item.referenceNumber">
            <label>{{ 'spending.referenceNumber' | translate }}</label>
            <span>{{ item.referenceNumber }}</span>
          </div>
          <!-- ECO Amount for standalone items -->
          <div class="info-item" *ngIf="!item.procurementItemId && item.ecoAmount != null">
            <label>{{ 'spending.ecoAmount' | translate }}</label>
            <span>{{ formatCurrency(item.ecoAmount, item.currency) }}</span>
          </div>
          <div class="info-item" *ngIf="item.currency !== 'CAD' && item.exchangeRate">
            <label>{{ 'spending.exchangeRate' | translate }}</label>
            <span>1 {{ item.currency }} = {{ item.exchangeRate }} CAD</span>
          </div>
          <!-- Linked Procurement Item (compact box with status) -->
          <div class="info-item procurement-link-box" *ngIf="item.procurementItemId">
            <label>{{ 'spending.linkedProcurement' | translate }}</label>
            <div class="procurement-link-content">
              <div class="procurement-row-compact">
                <div class="procurement-item-link">
                  <span class="procurement-name">{{ item.procurementItemName || ('spending.procurementItem' | translate) }}</span>
                </div>
                <button 
                  class="btn-link" 
                  [title]="'spending.viewInProcurement' | translate"
                  (click)="viewLinkedProcurement()">
                  {{ 'common.view' | translate }} â†’
                </button>
              </div>
              <!-- Latest Procurement Tracking Event -->
              <div class="procurement-tracking-compact" *ngIf="item.procurementMostRecentEventType">
                <span class="tracking-label">{{ 'spending.latestStatus' | translate }}:</span>
                <span class="event-type-badge compact" [ngClass]="getTrackingStatusClass(item.procurementMostRecentEventType)">
                  {{ getEventTypeIcon(item.procurementMostRecentEventType) }} {{ getEventTypeLabel(item.procurementMostRecentEventType) }}
                </span>
                <span class="tracking-date" *ngIf="item.procurementMostRecentEventDate">
                  ({{ item.procurementMostRecentEventDate | date:'dd/MM/yyyy' }})
                </span>
              </div>
              <!-- Procurement Price Display (inline) -->
              <div class="procurement-price-inline" *ngIf="item.procurementFinalPrice != null || item.procurementQuotedPrice != null">
                <span class="price-row" *ngIf="item.procurementFinalPrice != null">
                  <span class="price-label">{{ 'procurement.finalPrice' | translate }}:</span>
                  <span class="price-value">
                    {{ formatCurrency(item.procurementFinalPrice, item.procurementPriceCurrency || 'CAD') }}
                    <span class="price-cad" *ngIf="item.procurementPriceCurrency !== 'CAD' && item.procurementFinalPriceCad != null">
                      ({{ formatCurrency(item.procurementFinalPriceCad, 'CAD') }})
                    </span>
                  </span>
                </span>
                <span class="price-row" *ngIf="item.procurementFinalPrice == null && item.procurementQuotedPrice != null">
                  <span class="price-label">{{ 'procurement.quotedPrice' | translate }}:</span>
                  <span class="price-value">
                    {{ formatCurrency(item.procurementQuotedPrice, item.procurementPriceCurrency || 'CAD') }}
                    <span class="price-cad" *ngIf="item.procurementPriceCurrency !== 'CAD' && item.procurementQuotedPriceCad != null">
                      ({{ formatCurrency(item.procurementQuotedPriceCad, 'CAD') }})
                    </span>
                  </span>
                </span>
              </div>
              <!-- Price Mismatch Warning -->
              <div class="price-mismatch-warning" *ngIf="hasPriceMismatch(item)">
                <span class="warning-icon">âš ï¸</span>
                <span class="warning-text">{{ 'spending.priceMismatchWarning' | translate }}</span>
                <span class="warning-details">
                  {{ 'spending.spendingTotal' | translate }}: {{ formatCurrency(calculateTotal(item), item.currency) }}
                  <span *ngIf="item.currency !== 'CAD'"> ({{ formatCurrency(calculateTotalCad(item), 'CAD') }})</span>
                  vs
                  {{ 'spending.procurementPrice' | translate }}: {{ formatCurrency(getProcurementPriceCad(item), 'CAD') }}
                </span>
              </div>
            </div>
          </div>
        </div>
        <!-- Money Allocations -->
        <div class="money-section" *ngIf="item.moneyAllocations && item.moneyAllocations.length > 0">
          <label>{{ 'spending.moneyAllocations' | translate }}</label>
          <div class="money-grid">
            <div class="money-row" *ngFor="let allocation of item.moneyAllocations">
              <span class="money-label">{{ allocation.moneyName || 'AB' }}:</span>
              <span class="money-amounts">
                <ng-container *ngIf="categoryAllowsCapById(item.categoryId)">
                  CAP: {{ formatCurrency(allocation.capAmount, item.currency) }}
                </ng-container>
                <ng-container *ngIf="categoryAllowsCapById(item.categoryId) && categoryAllowsOmById(item.categoryId)">, </ng-container>
                <ng-container *ngIf="categoryAllowsOmById(item.categoryId)">
                  OM: {{ formatCurrency(allocation.omAmount, item.currency) }}
                </ng-container>
              </span>
            </div>
          </div>
        </div>
        
        <!-- Tracking Events Section for non-procurement-linked items -->
        <div class="tracking-section standalone-tracking" *ngIf="!item.procurementItemId">
          <div class="section-header">
            <label>ğŸ“‹ {{ 'spending.trackingEvents' | translate }} ({{ getEventCount(item) }})</label>
            <button 
              class="btn btn-primary" 
              *ngIf="canWrite"
              (click)="openAddEventModal(item)">
              â• {{ 'spending.addEvent' | translate }}
            </button>
          </div>
          <div class="events-list" *ngIf="selectedItemEvents.length > 0 && selectedEventItemId === item.id">
            <div class="event-item" *ngFor="let event of selectedItemEvents">
              <div class="event-header">
                <span class="event-type-badge" [ngClass]="getSpendingEventStatusClass(event.eventType)">
                  {{ getSpendingEventIcon(event.eventType) }} {{ getSpendingEventLabel(event.eventType) }}
                </span>
                <span class="event-date">{{ event.eventDate | date:'dd/MM/yyyy' }}</span>
              </div>
              <div class="event-comment" *ngIf="event.comment">{{ event.comment }}</div>
              <div class="event-meta">
                <span class="created-by" *ngIf="event.createdBy">{{ event.createdBy }}</span>
              </div>
              <div class="event-actions" *ngIf="canWrite">
                <button class="btn-icon btn-edit" (click)="editEvent(event)" [title]="'common.edit' | translate">âœï¸</button>
                <button class="btn-icon btn-delete" (click)="deleteEvent(event)" [title]="'common.delete' | translate">ğŸ—‘ï¸</button>
              </div>
            </div>
          </div>
          <div class="events-collapsed" *ngIf="(selectedItemEvents.length === 0 || selectedEventItemId !== item.id) && item.mostRecentEventType">
            <div class="recent-event-info">
              <span class="event-type-badge" [ngClass]="getSpendingEventStatusClass(item.mostRecentEventType)">
                {{ getSpendingEventIcon(item.mostRecentEventType) }} {{ getSpendingEventLabel(item.mostRecentEventType) }}
              </span>
              <span class="event-date" *ngIf="item.mostRecentEventDate">{{ item.mostRecentEventDate | date:'dd/MM/yyyy' }}</span>
            </div>
            <button class="btn-link" (click)="loadEventsForItem(item)">{{ 'common.showAll' | translate }}</button>
          </div>
          <div class="empty-state" *ngIf="!item.mostRecentEventType && (selectedItemEvents.length === 0 || selectedEventItemId !== item.id)">
            <p>{{ 'spending.noEvents' | translate }}</p>
            <p class="hint" *ngIf="canWrite">{{ 'spending.noEventsHint' | translate }}</p>
          </div>
        </div>
      </div>

      <!-- Edit Mode -->
      <div class="edit-form" *ngIf="editingItemId === item.id">
        <h4>{{ 'spending.editItem' | translate }}</h4>
        
        <!-- Linked Procurement Info (Read-only) -->
        <div class="edit-procurement-link-box" *ngIf="item.procurementItemId">
          <div class="procurement-link-header">
            <span class="procurement-icon">ğŸ“¦</span>
            <label>{{ 'spending.linkedProcurement' | translate }}</label>
          </div>
          <div class="procurement-link-content">
            <div class="procurement-item-link">
              <span class="procurement-name">{{ item.procurementItemName || ('spending.procurementItem' | translate) }}</span>
              <button 
                class="btn-link" 
                type="button"
                [title]="'spending.viewInProcurement' | translate"
                (click)="viewLinkedProcurement()">
                {{ 'common.view' | translate }} â†’
              </button>
            </div>
            <!-- Procurement Price Display -->
            <div class="procurement-price-info" *ngIf="item.procurementFinalPrice != null || item.procurementQuotedPrice != null">
              <div class="price-row" *ngIf="item.procurementFinalPrice != null">
                <span class="price-label">{{ 'procurement.finalPrice' | translate }}:</span>
                <span class="price-value">
                  {{ formatCurrency(item.procurementFinalPrice, item.procurementPriceCurrency || 'CAD') }}
                  <span class="price-cad" *ngIf="item.procurementPriceCurrency !== 'CAD' && item.procurementFinalPriceCad != null">
                    ({{ formatCurrency(item.procurementFinalPriceCad, 'CAD') }})
                  </span>
                </span>
              </div>
              <div class="price-row" *ngIf="item.procurementFinalPrice == null && item.procurementQuotedPrice != null">
                <span class="price-label">{{ 'procurement.quotedPrice' | translate }}:</span>
                <span class="price-value">
                  {{ formatCurrency(item.procurementQuotedPrice, item.procurementPriceCurrency || 'CAD') }}
                  <span class="price-cad" *ngIf="item.procurementPriceCurrency !== 'CAD' && item.procurementQuotedPriceCad != null">
                    ({{ formatCurrency(item.procurementQuotedPriceCad, 'CAD') }})
                  </span>
                </span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="editItemName">{{ 'common.name' | translate }} <span class="required">*</span></label>
            <input
              id="editItemName"
              type="text"
              [(ngModel)]="editItemName"
              [placeholder]="'spending.enterItemName' | translate"
              [disabled]="isUpdating"
              required
            />
          </div>
          <div class="form-group">
            <label for="editItemDescription">{{ 'common.description' | translate }}</label>
            <input
              id="editItemDescription"
              type="text"
              [(ngModel)]="editItemDescription"
              [placeholder]="'spending.optionalDescription' | translate"
              [disabled]="isUpdating"
            />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="editItemVendor">{{ 'spending.vendor' | translate }}</label>
            <input
              id="editItemVendor"
              type="text"
              [(ngModel)]="editItemVendor"
              [placeholder]="'spending.vendorName' | translate"
              [disabled]="isUpdating"
            />
          </div>
          <div class="form-group">
            <label for="editItemReferenceNumber">{{ 'spending.referenceNumber' | translate }}</label>
            <input
              id="editItemReferenceNumber"
              type="text"
              [(ngModel)]="editItemReferenceNumber"
              [placeholder]="'spending.referenceNumber' | translate"
              [disabled]="isUpdating"
            />
          </div>
          <!-- ECO Amount for standalone items -->
          <div class="form-group" *ngIf="!item.procurementItemId">
            <label for="editItemEcoAmount">{{ 'spending.ecoAmount' | translate }}</label>
            <input
              id="editItemEcoAmount"
              type="number"
              [(ngModel)]="editItemEcoAmount"
              [placeholder]="'spending.ecoAmountPlaceholder' | translate"
              [disabled]="isUpdating"
              step="0.01"
              min="0"
            />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="editItemCurrency">{{ 'spending.currency' | translate }}</label>
            <div class="currency-selector">
              <span class="currency-flag">{{ getCurrencyFlag(editItemCurrency) }}</span>
              <select id="editItemCurrency" [(ngModel)]="editItemCurrency" [disabled]="isUpdating"
                      (change)="onEditCurrencyChange()">
                <option value="CAD">ğŸ‡¨ğŸ‡¦ CAD - Canadian Dollar</option>
                <option value="USD">ğŸ‡ºğŸ‡¸ USD - US Dollar</option>
                <option value="EUR">ğŸ‡ªğŸ‡º EUR - Euro</option>
                <option value="GBP">ğŸ‡¬ğŸ‡§ GBP - British Pound</option>
                <option value="JPY">ğŸ‡¯ğŸ‡µ JPY - Japanese Yen</option>
                <option value="AUD">ğŸ‡¦ğŸ‡º AUD - Australian Dollar</option>
                <option value="CHF">ğŸ‡¨ğŸ‡­ CHF - Swiss Franc</option>
                <option value="CNY">ğŸ‡¨ğŸ‡³ CNY - Chinese Yuan</option>
                <option value="INR">ğŸ‡®ğŸ‡³ INR - Indian Rupee</option>
                <option value="MXN">ğŸ‡²ğŸ‡½ MXN - Mexican Peso</option>
                <option value="BRL">ğŸ‡§ğŸ‡· BRL - Brazilian Real</option>
                <option value="KRW">ğŸ‡°ğŸ‡· KRW - South Korean Won</option>
                <option value="SGD">ğŸ‡¸ğŸ‡¬ SGD - Singapore Dollar</option>
                <option value="HKD">ğŸ‡­ğŸ‡° HKD - Hong Kong Dollar</option>
                <option value="NZD">ğŸ‡³ğŸ‡¿ NZD - New Zealand Dollar</option>
                <option value="SEK">ğŸ‡¸ğŸ‡ª SEK - Swedish Krona</option>
                <option value="NOK">ğŸ‡³ğŸ‡´ NOK - Norwegian Krone</option>
                <option value="DKK">ğŸ‡©ğŸ‡° DKK - Danish Krone</option>
              </select>
            </div>
          </div>
          <div class="form-group" *ngIf="editItemCurrency !== 'CAD'">
            <label for="editItemExchangeRate">{{ 'spending.exchangeRate' | translate }} <span class="required">*</span></label>
            <div class="exchange-rate-field">
              1 {{ editItemCurrency }} = 
              <input
                id="editItemExchangeRate"
                type="number"
                [(ngModel)]="editItemExchangeRate"
                [placeholder]="'spending.enterExchangeRate' | translate"
                [disabled]="isUpdating"
                step="0.000001"
                min="0.000001"
                class="exchange-rate-input"
              /> CAD
            </div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="editItemStatus">{{ 'common.status' | translate }} <span class="required">*</span></label>
            <select id="editItemStatus" [(ngModel)]="editItemStatus" [disabled]="isUpdating" required>
              <option *ngFor="let status of statusOptions" [value]="status">
                {{ getStatusLabel(status) }}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label for="editItemCategory">{{ 'common.category' | translate }}</label>
            <select 
              id="editItemCategory" 
              [(ngModel)]="editItemCategoryId" 
              [disabled]="isUpdating || isLoadingCategories"
            >
              <option [ngValue]="null">-- {{ 'spending.noCategory' | translate }} --</option>
              <option *ngFor="let category of categories" [ngValue]="category.id">
                {{ category.name }}
              </option>
            </select>
          </div>
        </div>

        <!-- Edit Money Allocations -->
        <div class="money-allocations" *ngIf="editItemMoneyAllocations && editItemMoneyAllocations.length > 0">
          <h4>{{ 'spending.moneyAllocations' | translate }}</h4>
          <p class="allocation-hint">
            <ng-container *ngIf="editCategoryAllowsCap() && editCategoryAllowsOm()">
              {{ 'spending.allocationHint' | translate }}
              <strong>{{ 'spending.allocationRequired' | translate }}</strong>
            </ng-container>
            <ng-container *ngIf="editCategoryAllowsCap() && !editCategoryAllowsOm()">
              {{ 'spending.capOnlyHint' | translate }}
            </ng-container>
            <ng-container *ngIf="!editCategoryAllowsCap() && editCategoryAllowsOm()">
              {{ 'spending.omOnlyHint' | translate }}
            </ng-container>
          </p>
          <div class="allocations-grid">
            <div class="allocation-row" *ngFor="let allocation of editItemMoneyAllocations; let i = index" [class.is-default]="allocation.isDefault">
              <div class="allocation-header">
                <span class="money-code">{{ allocation.moneyName }}</span>
              </div>
              <div class="allocation-inputs">
                <div class="allocation-field" *ngIf="editCategoryAllowsCap()">
                  <label [for]="'edit-cap-' + i">{{ allocation.moneyName }} (CAP)</label>
                  <input
                    [id]="'edit-cap-' + i"
                    type="text"
                    currencyInput
                    [(ngModel)]="allocation.capAmount"
                    placeholder="0.00"
                    [disabled]="isUpdating"
                    class="money-input"
                  />
                </div>
                <div class="allocation-field" *ngIf="editCategoryAllowsOm()">
                  <label [for]="'edit-om-' + i">{{ allocation.moneyName }} (O&M)</label>
                  <input
                    [id]="'edit-om-' + i"
                    type="text"
                    currencyInput
                    [(ngModel)]="allocation.omAmount"
                    placeholder="0.00"
                    [disabled]="isUpdating"
                    class="money-input"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button 
            class="btn-secondary" 
            (click)="cancelEditSpendingItem()"
            [disabled]="isUpdating"
          >
            {{ 'common.cancel' | translate }}
          </button>
          <button 
            class="btn-primary" 
            (click)="updateSpendingItem()"
            [disabled]="isUpdating || !editItemName.trim() || !hasValidEditMoneyAllocation()"
          >
            <span *ngIf="isUpdating">{{ 'common.updating' | translate }}</span>
            <span *ngIf="!isUpdating">{{ 'spending.updateItem' | translate }}</span>
          </button>
        </div>
      </div>
    </div>
  </ng-template>

  <!-- Summary Section -->
  <div class="summary-section" *ngIf="spendingItems.length > 0">
    <h3>{{ 'common.summary' | translate }}</h3>
    
    <!-- Summary by Money Type -->
    <div class="summary-group">
      <h4>{{ 'spending.totalsByMoneyType' | translate }}</h4>
      <table class="summary-table">
        <thead>
          <tr>
            <th>{{ 'spending.moneyType' | translate }}</th>
            <th>{{ 'spending.totalCap' | translate }}</th>
            <th>{{ 'spending.totalOm' | translate }}</th>
            <th>{{ 'common.total' | translate }}</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let summary of summaryByMoneyType">
            <td>{{ summary.moneyCode }} - {{ summary.moneyName }}</td>
            <td class="amount">{{ formatCurrency(summary.totalCap) }}</td>
            <td class="amount">{{ formatCurrency(summary.totalOm) }}</td>
            <td class="amount total">{{ formatCurrency(summary.total) }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- Summary by Category -->
    <div class="summary-group" *ngIf="summaryByCategory.length > 0">
      <h4>{{ 'spending.totalsByCategory' | translate }}</h4>
      <table class="summary-table">
        <thead>
          <tr>
            <th>{{ 'common.category' | translate }}</th>
            <th>{{ 'spending.totalCap' | translate }}</th>
            <th>{{ 'spending.totalOm' | translate }}</th>
            <th>{{ 'common.total' | translate }}</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let summary of summaryByCategory">
            <td>{{ summary.categoryName }}</td>
            <td class="amount">{{ formatCurrency(summary.totalCap) }}</td>
            <td class="amount">{{ formatCurrency(summary.totalOm) }}</td>
            <td class="amount total">{{ formatCurrency(summary.total) }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- Grand Total -->
    <div class="grand-total">
      <table class="summary-table">
        <tbody>
          <tr class="grand-total-row">
            <td><strong>{{ 'spending.grandTotal' | translate }}</strong></td>
            <td class="amount"><strong>{{ formatCurrency(grandTotalCap) }}</strong></td>
            <td class="amount"><strong>{{ formatCurrency(grandTotalOm) }}</strong></td>
            <td class="amount total"><strong>{{ formatCurrency(grandTotal) }}</strong></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
