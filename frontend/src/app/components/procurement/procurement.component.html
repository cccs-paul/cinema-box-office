<!--
  myRC - Procurement Component Template
  Copyright (c) 2026 myRC Team
  Licensed under MIT License
-->
<div class="procurement-container">
  <!-- Messages -->
  <div class="messages" *ngIf="errorMessage || successMessage">
    <div class="alert alert-error" *ngIf="errorMessage">
      <span>‚ùå</span> {{ errorMessage }}
    </div>
    <div class="alert alert-success" *ngIf="successMessage">
      <span>‚úÖ</span> {{ successMessage }}
    </div>
  </div>

  <!-- Main Content -->
  <div class="content-wrapper">
    <!-- Items Panel -->
    <div class="items-panel">
      <!-- Action Bar -->
      <div class="action-bar" *ngIf="canWrite && !showCreateItemForm">
        <button class="btn btn-primary" (click)="showCreateItem()">
          + New Procurement
        </button>
      </div>

      <!-- Search and Category Filter -->
      <div class="filters-bar" *ngIf="!showCreateItemForm">
        <!-- Search Box -->
        <div class="search-box">
          <input
            type="text"
            [(ngModel)]="searchTerm"
            placeholder="Search by PR, PO, name, vendor..."
            class="search-input"
          />
          <button 
            class="btn-clear" 
            *ngIf="searchTerm" 
            (click)="clearSearch()"
            title="Clear search">
            ‚úï
          </button>
        </div>
        <div class="filter-dropdown">
          <select [(ngModel)]="selectedStatusFilter" (change)="filterByStatus(selectedStatusFilter)">
            <option [ngValue]="null">All Statuses</option>
            <option *ngFor="let status of statusOptions" [ngValue]="status">
              {{ getStatusLabel(status) }}
            </option>
          </select>
        </div>

        <!-- Category Filter -->
        <div class="category-filter" *ngIf="categories.length > 0 && selectedFY?.showCategoryFilter !== false">
          <span class="filter-label">Category:</span>
          <button 
            class="filter-btn"
            [class.active]="selectedCategoryId === null"
            (click)="filterByCategory(null)">
            All
          </button>
          <button 
            *ngFor="let category of categories"
            class="filter-btn"
            [class.active]="selectedCategoryId === category.id"
            (click)="filterByCategory(category.id)">
            {{ category.name }}
          </button>
        </div>
      </div>

      <!-- Create Item Form -->
      <div class="create-form" *ngIf="showCreateItemForm">
        <h3>Create Procurement Item</h3>
        <form (ngSubmit)="createProcurementItem()">
          <div class="form-row">
            <div class="form-group">
              <label for="newItemPR">Purchase Requisition (PR) *</label>
              <input
                type="text"
                id="newItemPR"
                [(ngModel)]="newItemPR"
                name="newItemPR"
                required
                placeholder="e.g., PR-2026-001"
              />
            </div>
            <div class="form-group">
              <label for="newItemPO">Purchase Order (PO)</label>
              <input
                type="text"
                id="newItemPO"
                [(ngModel)]="newItemPO"
                name="newItemPO"
                placeholder="e.g., PO-2026-001"
              />
            </div>
          </div>
          <div class="form-group">
            <label for="newItemName">Name *</label>
            <input
              type="text"
              id="newItemName"
              [(ngModel)]="newItemName"
              name="newItemName"
              required
              placeholder="Brief name for this procurement"
            />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="newItemCategory">Category</label>
              <select id="newItemCategory" [(ngModel)]="newItemCategoryId" name="newItemCategory">
                <option [ngValue]="null">-- No Category --</option>
                <option *ngFor="let category of categories" [ngValue]="category.id">
                  {{ category.name }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="newItemDescription">Description</label>
            <textarea
              id="newItemDescription"
              [(ngModel)]="newItemDescription"
              name="newItemDescription"
              placeholder="Detailed description..."
              rows="3"
            ></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="newItemCurrency">Currency</label>
              <select id="newItemCurrency" [(ngModel)]="newItemCurrency" name="newItemCurrency">
                <option *ngFor="let currency of currencies" [value]="currency.code">
                  {{ getCurrencyFlag(currency.code) }} {{ currency.code }} - {{ currency.name }}
                </option>
              </select>
            </div>
            <div class="form-group" *ngIf="newItemCurrency !== 'CAD'">
              <label for="newItemExchangeRate">Exchange Rate to CAD</label>
              <input
                type="number"
                id="newItemExchangeRate"
                [(ngModel)]="newItemExchangeRate"
                name="newItemExchangeRate"
                step="0.0001"
                min="0"
                placeholder="e.g., 1.35"
              />
            </div>
          </div>
          
          <!-- Contract & Vendor Fields -->
          <div class="form-row">
            <div class="form-group">
              <label for="newItemPreferredVendor">Preferred Vendor</label>
              <input
                type="text"
                id="newItemPreferredVendor"
                [(ngModel)]="newItemPreferredVendor"
                name="newItemPreferredVendor"
                placeholder="e.g., Acme Corp"
              />
            </div>
            <div class="form-group">
              <label for="newItemContractNumber">Contract Number</label>
              <input
                type="text"
                id="newItemContractNumber"
                [(ngModel)]="newItemContractNumber"
                name="newItemContractNumber"
                placeholder="e.g., CON-2026-001"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="newItemContractStartDate">Contract Start Date</label>
              <input
                type="date"
                id="newItemContractStartDate"
                [(ngModel)]="newItemContractStartDate"
                name="newItemContractStartDate"
              />
            </div>
            <div class="form-group">
              <label for="newItemContractEndDate">Contract End Date</label>
              <input
                type="date"
                id="newItemContractEndDate"
                [(ngModel)]="newItemContractEndDate"
                name="newItemContractEndDate"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group form-checkbox">
              <input
                type="checkbox"
                id="newItemProcurementCompleted"
                [(ngModel)]="newItemProcurementCompleted"
                name="newItemProcurementCompleted"
              />
              <label for="newItemProcurementCompleted">Procurement Completed</label>
            </div>
            <div class="form-group" *ngIf="newItemProcurementCompleted">
              <label for="newItemProcurementCompletedDate">Completion Date</label>
              <input
                type="date"
                id="newItemProcurementCompletedDate"
                [(ngModel)]="newItemProcurementCompletedDate"
                name="newItemProcurementCompletedDate"
              />
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-secondary" (click)="cancelCreateItem()">Cancel</button>
            <button
              type="submit"
              class="btn-primary"
              [disabled]="isCreatingItem || !newItemPR.trim() || !newItemName.trim()"
            >
              {{ isCreatingItem ? 'Creating...' : 'Create' }}
            </button>
          </div>
        </form>
      </div>

      <!-- Items List -->
      <div class="items-list-container">
        <div class="loading" *ngIf="isLoadingItems">
          <span class="spinner"></span> Loading...
        </div>

        <div class="items-list" *ngIf="!isLoadingItems && filteredProcurementItems.length > 0">
          <div class="item-card" *ngFor="let item of filteredProcurementItems" [class.expanded]="selectedItem?.id === item.id">
            <!-- Item Summary Row -->
            <div class="item-summary" (click)="toggleItemDetails(item)">
              <div class="item-info">
                <span class="item-pr">{{ item.purchaseRequisition }}</span>
                <span class="item-po" *ngIf="item.purchaseOrder">/ {{ item.purchaseOrder }}</span>
                <span class="item-name">{{ item.name }}</span>
                <span class="status-badge" [ngClass]="getStatusClass(item.status)">
                  {{ getStatusLabel(item.status) }}
                </span>
                <span class="category-badge" *ngIf="item.categoryName">üìÅ {{ item.categoryName }}</span>
                <span class="quotes-count">üìã {{ item.quoteCount || 0 }}</span>
              </div>
              <div class="item-actions">
                <button
                  class="btn-icon expand-btn"
                  [title]="selectedItem?.id === item.id ? 'Collapse' : 'Expand'"
                  (click)="toggleItemDetails(item); $event.stopPropagation()"
                >
                  {{ selectedItem?.id === item.id ? '‚ñ≤' : '‚ñº' }}
                </button>
                <button
                  class="btn-icon btn-edit"
                  title="Edit"
                  *ngIf="canWrite && editingItemId !== item.id"
                  (click)="startEditProcurementItem(item); $event.stopPropagation()"
                >
                  ‚úèÔ∏è
                </button>
                <button
                  class="btn-icon btn-danger"
                  title="Delete"
                  *ngIf="canWrite"
                  (click)="deleteProcurementItem(item); $event.stopPropagation()"
                >
                  üóëÔ∏è
                </button>
              </div>
            </div>

            <!-- Expanded Details Section -->
            <div class="item-details" *ngIf="selectedItem?.id === item.id">
              <div class="details-content">
                <!-- Item Info View Mode -->
                <div class="info-section" *ngIf="editingItemId !== item.id">
                  <div class="info-grid">
                    <div class="info-item">
                      <label>Purchase Requisition (PR)</label>
                      <span>{{ item.purchaseRequisition }}</span>
                    </div>
                    <div class="info-item">
                      <label>Purchase Order (PO)</label>
                      <span>{{ item.purchaseOrder || '-' }}</span>
                    </div>
                    <div class="info-item">
                      <label>Currency</label>
                      <span class="currency-badge" [class.foreign-currency]="item.currency !== 'CAD'">
                        {{ getCurrencyFlag(item.currency) }} {{ item.currency }}
                      </span>
                      <span class="exchange-rate" *ngIf="item.currency !== 'CAD' && item.exchangeRate">
                        (1 {{ item.currency }} = {{ item.exchangeRate }} CAD)
                      </span>
                    </div>
                    <div class="info-item">
                      <label>Status</label>
                      <span class="status-badge" [ngClass]="getStatusClass(item.status)">
                        {{ getStatusLabel(item.status) }}
                      </span>
                    </div>
                    <div class="info-item" *ngIf="item.preferredVendor">
                      <label>Preferred Vendor</label>
                      <span>{{ item.preferredVendor }}</span>
                    </div>
                    <div class="info-item" *ngIf="item.contractNumber">
                      <label>Contract Number</label>
                      <span>{{ item.contractNumber }}</span>
                    </div>
                    <div class="info-item" *ngIf="item.contractStartDate || item.contractEndDate">
                      <label>Contract Period</label>
                      <span>
                        {{ item.contractStartDate | date:'mediumDate' }}
                        <ng-container *ngIf="item.contractStartDate && item.contractEndDate"> - </ng-container>
                        {{ item.contractEndDate | date:'mediumDate' }}
                      </span>
                    </div>
                    <div class="info-item">
                      <label>Procurement Completed</label>
                      <span class="completion-badge" [class.completed]="item.procurementCompleted">
                        {{ item.procurementCompleted ? '‚úÖ Yes' : '‚è≥ No' }}
                      </span>
                      <span *ngIf="item.procurementCompleted && item.procurementCompletedDate" class="completion-date">
                        ({{ item.procurementCompletedDate | date:'mediumDate' }})
                      </span>
                    </div>
                    <div class="info-item">
                      <label>Created</label>
                      <span>{{ item.createdAt | date:'medium' }}</span>
                    </div>
                  </div>
                  <div class="description" *ngIf="item.description">
                    <label>Description</label>
                    <p>{{ item.description }}</p>
                  </div>
                </div>

                <!-- Edit Mode -->
                <div class="edit-form" *ngIf="editingItemId === item.id">
                  <h4>Edit Procurement Item</h4>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="editItemPR">Purchase Requisition (PR) <span class="required">*</span></label>
                      <input
                        id="editItemPR"
                        type="text"
                        [(ngModel)]="editItemPR"
                        placeholder="e.g., PR-2026-001"
                        [disabled]="isUpdatingItem"
                        required
                      />
                    </div>
                    <div class="form-group">
                      <label for="editItemPO">Purchase Order (PO)</label>
                      <input
                        id="editItemPO"
                        type="text"
                        [(ngModel)]="editItemPO"
                        placeholder="e.g., PO-2026-001"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="editItemName">Name <span class="required">*</span></label>
                    <input
                      id="editItemName"
                      type="text"
                      [(ngModel)]="editItemName"
                      placeholder="Brief name for this procurement"
                      [disabled]="isUpdatingItem"
                      required
                    />
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="editItemCategory">Category</label>
                      <select id="editItemCategory" [(ngModel)]="editItemCategoryId" [disabled]="isUpdatingItem">
                        <option [ngValue]="null">-- No Category --</option>
                        <option *ngFor="let category of categories" [ngValue]="category.id">
                          {{ category.name }}
                        </option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label for="editItemStatus">Status <span class="required">*</span></label>
                      <select id="editItemStatus" [(ngModel)]="editItemStatus" [disabled]="isUpdatingItem" required>
                        <option *ngFor="let status of procurementStatuses" [value]="status">
                          {{ getStatusLabel(status) }}
                        </option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="editItemDescription">Description</label>
                    <textarea
                      id="editItemDescription"
                      [(ngModel)]="editItemDescription"
                      placeholder="Detailed description..."
                      [disabled]="isUpdatingItem"
                      rows="3"
                    ></textarea>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="editItemCurrency">Currency</label>
                      <select id="editItemCurrency" [(ngModel)]="editItemCurrency" [disabled]="isUpdatingItem">
                        <option *ngFor="let currency of currencies" [value]="currency.code">
                          {{ getCurrencyFlag(currency.code) }} {{ currency.code }} - {{ currency.name }}
                        </option>
                      </select>
                    </div>
                    <div class="form-group" *ngIf="editItemCurrency !== 'CAD'">
                      <label for="editItemExchangeRate">Exchange Rate to CAD</label>
                      <input
                        id="editItemExchangeRate"
                        type="number"
                        [(ngModel)]="editItemExchangeRate"
                        step="0.0001"
                        min="0"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="editItemPreferredVendor">Preferred Vendor</label>
                      <input
                        id="editItemPreferredVendor"
                        type="text"
                        [(ngModel)]="editItemPreferredVendor"
                        placeholder="Vendor name"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                    <div class="form-group">
                      <label for="editItemContractNumber">Contract Number</label>
                      <input
                        id="editItemContractNumber"
                        type="text"
                        [(ngModel)]="editItemContractNumber"
                        placeholder="Contract number"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="editItemContractStartDate">Contract Start Date</label>
                      <input
                        id="editItemContractStartDate"
                        type="date"
                        [(ngModel)]="editItemContractStartDate"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                    <div class="form-group">
                      <label for="editItemContractEndDate">Contract End Date</label>
                      <input
                        id="editItemContractEndDate"
                        type="date"
                        [(ngModel)]="editItemContractEndDate"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="checkbox-label">
                        <input
                          type="checkbox"
                          [(ngModel)]="editItemProcurementCompleted"
                          [disabled]="isUpdatingItem"
                        />
                        Procurement Completed
                      </label>
                    </div>
                    <div class="form-group" *ngIf="editItemProcurementCompleted">
                      <label for="editItemProcurementCompletedDate">Completion Date</label>
                      <input
                        id="editItemProcurementCompletedDate"
                        type="date"
                        [(ngModel)]="editItemProcurementCompletedDate"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                  </div>
                  <div class="form-actions">
                    <button 
                      type="button"
                      class="btn-secondary" 
                      (click)="cancelEditProcurementItem()"
                      [disabled]="isUpdatingItem"
                    >
                      Cancel
                    </button>
                    <button 
                      type="button"
                      class="btn-primary" 
                      (click)="updateProcurementItem()"
                      [disabled]="isUpdatingItem || !editItemPR.trim() || !editItemName.trim()"
                    >
                      <span *ngIf="isUpdatingItem">Updating...</span>
                      <span *ngIf="!isUpdatingItem">Update Item</span>
                    </button>
                  </div>
                </div>

                <!-- Quotes Section -->
                <div class="quotes-section">
                  <div class="section-header">
                    <h3>Quotes ({{ quotes.length }})</h3>
                    <button class="btn-primary" (click)="showCreateQuote()" *ngIf="canWrite && !showCreateQuoteForm">
                      ‚ûï Add Quote
                    </button>
                  </div>

                  <!-- Create Quote Form -->
                  <div class="create-form" *ngIf="showCreateQuoteForm">
                    <h4>Add New Quote</h4>
                    <form (ngSubmit)="createQuote()">
                      <div class="form-row">
                        <div class="form-group">
                          <label for="newQuoteVendorName">Vendor Name *</label>
                          <input
                            type="text"
                            id="newQuoteVendorName"
                            [(ngModel)]="newQuoteVendorName"
                            name="newQuoteVendorName"
                            required
                          />
                        </div>
                        <div class="form-group">
                          <label for="newQuoteVendorContact">Vendor Contact</label>
                          <input
                            type="text"
                            id="newQuoteVendorContact"
                            [(ngModel)]="newQuoteVendorContact"
                            name="newQuoteVendorContact"
                          />
                        </div>
                      </div>
                      <div class="form-row">
                        <div class="form-group">
                          <label for="newQuoteReference">Quote Reference</label>
                          <input
                            type="text"
                            id="newQuoteReference"
                            [(ngModel)]="newQuoteReference"
                            name="newQuoteReference"
                          />
                        </div>
                        <div class="form-group">
                          <label for="newQuoteAmount">Amount</label>
                          <div class="amount-input">
                            <select [(ngModel)]="newQuoteCurrency" name="newQuoteCurrency">
                              <option *ngFor="let currency of currencies" [value]="currency.code">
                                {{ getCurrencyFlag(currency.code) }} {{ currency.code }}
                              </option>
                            </select>
                            <input
                              type="number"
                              id="newQuoteAmount"
                              [(ngModel)]="newQuoteAmount"
                              name="newQuoteAmount"
                              min="0"
                              step="0.01"
                            />
                          </div>
                        </div>
                      </div>
                      <div class="form-row">
                        <div class="form-group">
                          <label for="newQuoteReceivedDate">Received Date</label>
                          <input
                            type="date"
                            id="newQuoteReceivedDate"
                            [(ngModel)]="newQuoteReceivedDate"
                            name="newQuoteReceivedDate"
                          />
                        </div>
                        <div class="form-group">
                          <label for="newQuoteExpiryDate">Expiry Date</label>
                          <input
                            type="date"
                            id="newQuoteExpiryDate"
                            [(ngModel)]="newQuoteExpiryDate"
                            name="newQuoteExpiryDate"
                          />
                        </div>
                      </div>
                      <div class="form-group">
                        <label for="newQuoteNotes">Notes</label>
                        <textarea
                          id="newQuoteNotes"
                          [(ngModel)]="newQuoteNotes"
                          name="newQuoteNotes"
                          rows="2"
                        ></textarea>
                      </div>
                      <!-- Attach File Section -->
                      <div class="form-group file-attach-section">
                        <label for="newQuoteFile">Attach File (Optional)</label>
                        <div class="file-input-wrapper">
                          <input
                            type="file"
                            id="newQuoteFile"
                            (change)="onQuoteFileSelected($event)"
                            accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.xls,.xlsx,.txt,.csv"
                          />
                          <span class="file-hint">PDF, images, documents up to 10MB</span>
                        </div>
                        <div *ngIf="newQuoteFile" class="selected-file-info">
                          <span class="file-icon">üìé</span>
                          <span class="file-name">{{ newQuoteFile.name }}</span>
                          <span class="file-size">({{ formatFileSize(newQuoteFile.size) }})</span>
                          <button type="button" class="btn-remove-file" (click)="removeQuoteFile()">‚úï</button>
                        </div>
                        <div class="form-group file-description" *ngIf="newQuoteFile">
                          <label for="newQuoteFileDescription">File Description</label>
                          <input
                            type="text"
                            id="newQuoteFileDescription"
                            [(ngModel)]="newQuoteFileDescription"
                            name="newQuoteFileDescription"
                            placeholder="Brief description of the attached file"
                          />
                        </div>
                      </div>
                      <div class="form-actions">
                        <button type="button" class="btn-secondary" (click)="cancelCreateQuote()">Cancel</button>
                        <button
                          type="submit"
                          class="btn-primary"
                          [disabled]="isCreatingQuote || !newQuoteVendorName.trim()"
                        >
                          {{ isCreatingQuote ? 'Adding...' : 'Add Quote' }}
                        </button>
                      </div>
                    </form>
                  </div>

                  <!-- Quotes List -->
                  <div class="quotes-list">
                    <div class="loading" *ngIf="isLoadingQuotes">
                      <span class="spinner"></span> Loading quotes...
                    </div>

                    <div class="quote-card" *ngFor="let quote of quotes" [class.selected]="quote.selected">
                      <div class="quote-header">
                        <div class="vendor-info">
                          <span class="vendor-name">{{ quote.vendorName }}</span>
                          <span class="quote-ref" *ngIf="quote.quoteReference">#{{ quote.quoteReference }}</span>
                        </div>
                        <span class="status-badge" [ngClass]="getQuoteStatusClass(quote.status)">
                          {{ getQuoteStatusLabel(quote.status) }}
                        </span>
                      </div>
                      <div class="quote-body">
                        <div class="quote-amount" *ngIf="quote.amount !== null && quote.amount !== undefined">
                          <span class="currency-flag">{{ getCurrencyFlag(quote.currency) }}</span>
                          {{ formatCurrency(quote.amount, quote.currency) }}
                        </div>
                        <div class="quote-dates">
                          <span *ngIf="quote.receivedDate">Received: {{ quote.receivedDate | date:'shortDate' }}</span>
                          <span *ngIf="quote.expiryDate">Expires: {{ quote.expiryDate | date:'shortDate' }}</span>
                        </div>
                        <p class="quote-notes" *ngIf="quote.notes">{{ quote.notes }}</p>
                      </div>
                      <div class="quote-actions">
                        <button class="btn-icon" title="View Files" (click)="viewQuoteFiles(quote)">
                          üìÅ Files ({{ quote.fileCount || 0 }})
                        </button>
                        <button
                          class="btn-icon btn-select"
                          title="Select Quote (Coming Soon)"
                          *ngIf="canWrite && !quote.selected && quote.status !== 'REJECTED'"
                          disabled
                          [class.disabled]="true"
                        >
                          ‚úÖ Select
                        </button>
                        <button
                          class="btn-icon btn-danger"
                          title="Delete"
                          *ngIf="canWrite"
                          (click)="deleteQuote(quote)"
                        >
                          üóëÔ∏è
                        </button>
                      </div>
                      <div class="selected-badge" *ngIf="quote.selected">
                        ‚úì Selected Quote
                      </div>
                    </div>

                    <div class="empty-state" *ngIf="!isLoadingQuotes && quotes.length === 0">
                      <p>No quotes added yet.</p>
                      <p *ngIf="canWrite">Click "Add Quote" to add one.</p>
                    </div>
                  </div>
                </div>

                <!-- Procurement Events/Tracking Section -->
                <div class="events-section">
                  <div class="section-header">
                    <h3>üìã Procurement Tracking ({{ events.length }})</h3>
                    <div class="section-actions">
                      <button 
                        class="btn-toggle" 
                        (click)="toggleEventsPanel()"
                        [class.active]="showEventsPanel">
                        {{ showEventsPanel ? '‚ñº Hide' : '‚ñ∂ Show' }}
                      </button>
                      <button 
                        class="btn-primary" 
                        (click)="showCreateEvent()" 
                        *ngIf="canWrite && showEventsPanel && !showCreateEventForm">
                        ‚ûï Add Event
                      </button>
                    </div>
                  </div>

                  <div class="events-content" *ngIf="showEventsPanel">
                    <!-- Create/Edit Event Form -->
                    <div class="create-form event-form" *ngIf="showCreateEventForm">
                      <h4>{{ editingEvent ? 'Edit Event' : 'Add New Event' }}</h4>
                      <form (ngSubmit)="editingEvent ? updateEvent() : createEvent()">
                        <div class="form-row">
                          <div class="form-group">
                            <label for="newEventType">Event Type *</label>
                            <select 
                              id="newEventType" 
                              [(ngModel)]="newEventType" 
                              name="newEventType"
                              required>
                              <option *ngFor="let type of eventTypeOptions" [value]="type">
                                {{ getEventTypeIcon(type) }} {{ getEventTypeLabel(type) }}
                              </option>
                            </select>
                          </div>
                          <div class="form-group">
                            <label for="newEventDate">Date *</label>
                            <input
                              type="date"
                              id="newEventDate"
                              [(ngModel)]="newEventDate"
                              name="newEventDate"
                              required
                            />
                          </div>
                        </div>
                        <div class="form-group">
                          <label for="newEventComment">Comment/Notes</label>
                          <textarea
                            id="newEventComment"
                            [(ngModel)]="newEventComment"
                            name="newEventComment"
                            rows="2"
                            placeholder="Optional comment or description..."
                          ></textarea>
                        </div>
                        <div class="form-actions">
                          <button type="button" class="btn-secondary" (click)="cancelEventForm()">Cancel</button>
                          <button
                            type="submit"
                            class="btn-primary"
                            [disabled]="isCreatingEvent || !newEventDate">
                            {{ isCreatingEvent ? (editingEvent ? 'Updating...' : 'Adding...') : (editingEvent ? 'Update' : 'Add Event') }}
                          </button>
                        </div>
                      </form>
                    </div>

                    <!-- Events Timeline -->
                    <div class="events-timeline">
                      <div class="loading" *ngIf="isLoadingEvents">
                        <span class="spinner"></span> Loading events...
                      </div>

                      <div class="event-item" 
                           *ngFor="let event of events" 
                           [ngClass]="getEventTypeClass(event.eventType)">
                        <div class="event-icon">{{ getEventTypeIcon(event.eventType) }}</div>
                        <div class="event-content">
                          <div class="event-header">
                            <span class="event-type">{{ getEventTypeLabel(event.eventType) }}</span>
                            <span class="event-date">{{ event.eventDate | date:'mediumDate' }}</span>
                          </div>
                          <p class="event-comment" *ngIf="event.comment">{{ event.comment }}</p>
                          <div class="event-status-change" *ngIf="event.oldStatus && event.newStatus">
                            <span class="old-status">{{ event.oldStatus }}</span>
                            <span class="arrow">‚Üí</span>
                            <span class="new-status">{{ event.newStatus }}</span>
                          </div>
                          <div class="event-meta">
                            <span class="created-by" *ngIf="event.createdBy">By: {{ event.createdBy }}</span>
                            <span class="created-at" *ngIf="event.createdAt">{{ event.createdAt | date:'short' }}</span>
                          </div>
                        </div>
                        <div class="event-actions" *ngIf="canWrite">
                          <button class="btn-icon" title="Edit" (click)="editEvent(event)">‚úèÔ∏è</button>
                          <button class="btn-icon btn-danger" title="Delete" (click)="deleteEvent(event)">üóëÔ∏è</button>
                        </div>
                      </div>

                      <div class="empty-state" *ngIf="!isLoadingEvents && events.length === 0">
                        <p>No tracking events recorded yet.</p>
                        <p *ngIf="canWrite">Click "Add Event" to add one.</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Empty State - No items match filter -->
        <div class="empty-state" *ngIf="!isLoadingItems && procurementItems.length > 0 && filteredProcurementItems.length === 0">
          <div class="empty-icon">üîç</div>
          <h3>No Matching Items</h3>
          <p>No procurement items match the current filter(s). Try adjusting your search or category filter.</p>
          <button class="btn-secondary" (click)="clearSearch(); selectedCategoryId = null">
            Clear Filters
          </button>
        </div>

        <!-- Empty State - No items exist -->
        <div class="empty-state" *ngIf="!isLoadingItems && procurementItems.length === 0">
          <div class="empty-icon">üõí</div>
          <h3>No Procurement Items Yet</h3>
          <p>Get started by creating your first procurement item for this fiscal year.</p>
          <button class="btn-primary" (click)="showCreateItem()" *ngIf="canWrite">
            Create First Procurement Item
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Files Modal -->
  <div class="modal-overlay" *ngIf="selectedQuote" (click)="closeQuoteFiles()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Files for Quote: {{ selectedQuote.vendorName }}</h3>
        <button class="btn-close" (click)="closeQuoteFiles()">‚úï</button>
      </div>
      <div class="modal-body">
        <!-- Upload Form -->
        <div class="upload-section" *ngIf="canWrite">
          <button class="btn-primary" (click)="showFileUploadForm()" *ngIf="!showFileUpload">
            üìé Upload File
          </button>

          <div class="upload-form" *ngIf="showFileUpload">
            <div class="form-group">
              <label for="fileInput">Select File</label>
              <input
                type="file"
                id="fileInput"
                (change)="onFileSelected($event)"
                accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.xls,.xlsx,.txt,.csv"
              />
            </div>
            <div class="form-group">
              <label for="fileDescription">Description (optional)</label>
              <input
                type="text"
                id="fileDescription"
                [(ngModel)]="fileDescription"
                placeholder="Brief description of the file"
              />
            </div>
            <div class="form-actions">
              <button type="button" class="btn-secondary" (click)="cancelFileUpload()">Cancel</button>
              <button
                type="button"
                class="btn-primary"
                [disabled]="isUploadingFile || !selectedFile"
                (click)="uploadFile()"
              >
                {{ isUploadingFile ? 'Uploading...' : 'Upload' }}
              </button>
            </div>
          </div>
        </div>

        <!-- Files List -->
        <div class="files-list">
          <div class="loading" *ngIf="isLoadingFiles">
            <span class="spinner"></span> Loading files...
          </div>

          <div class="file-item" *ngFor="let file of files">
            <span class="file-icon">{{ getFileIcon(file.contentType) }}</span>
            <div class="file-info">
              <span class="file-name">{{ file.fileName }}</span>
              <span class="file-meta">{{ file.fileSize | number }} bytes</span>
              <span class="file-desc" *ngIf="file.description">{{ file.description }}</span>
            </div>
            <div class="file-actions">
              <button class="btn-icon" title="Preview" (click)="previewFile(file)" *ngIf="isPreviewable(file.contentType)">üëÅÔ∏è</button>
              <button class="btn-icon" title="Open in New Tab" (click)="viewFile(file)">üîó</button>
              <button class="btn-icon" title="Download" (click)="downloadFile(file)">‚¨áÔ∏è</button>
              <button
                class="btn-icon btn-danger"
                title="Delete"
                *ngIf="canWrite"
                (click)="deleteFile(file)"
              >
                üóëÔ∏è
              </button>
            </div>
          </div>

          <div class="empty-state" *ngIf="!isLoadingFiles && files.length === 0">
            <p>No files uploaded.</p>
            <p *ngIf="canWrite">Click "Upload File" to add one.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- File Preview Modal -->
  <div class="preview-overlay" *ngIf="previewingFile" (click)="closePreview()">
    <div class="preview-modal" (click)="$event.stopPropagation()">
      <div class="preview-header">
        <h3>{{ previewingFile.fileName }}</h3>
        <div class="preview-actions">
          <button class="btn-icon" title="Open in New Tab" (click)="viewFile(previewingFile)">üîó</button>
          <button class="btn-icon" title="Download" (click)="downloadFile(previewingFile)">‚¨áÔ∏è</button>
          <button class="btn-close" (click)="closePreview()">‚úï</button>
        </div>
      </div>
      <div class="preview-content">
        <div class="loading" *ngIf="isLoadingPreview">
          <span class="spinner"></span> Loading preview...
        </div>
        <iframe 
          *ngIf="!isLoadingPreview && previewUrl && previewingFile.contentType === 'application/pdf'" 
          [src]="previewUrl" 
          class="pdf-preview"
          title="PDF Preview">
        </iframe>
        <img 
          *ngIf="!isLoadingPreview && previewUrl && previewingFile.contentType.startsWith('image/')" 
          [src]="previewUrl" 
          class="image-preview"
          alt="Image Preview"
        />
        <div class="text-preview" *ngIf="!isLoadingPreview && previewUrl && previewingFile.contentType.startsWith('text/')">
          <pre>{{ previewTextContent }}</pre>
        </div>
      </div>
    </div>
  </div>
</div>
