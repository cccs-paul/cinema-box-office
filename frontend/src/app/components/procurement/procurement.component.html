<!--
  myRC - Procurement Component Template
  Copyright (c) 2026 myRC Team
  Licensed under MIT License
-->
<div class="procurement-container">
  <!-- Action Bar -->
  <div class="action-bar" *ngIf="canWrite && !showCreateItemForm">
    <button class="btn btn-primary" (click)="showCreateItem()">
      + {{ 'procurement.addItem' | translate }}
    </button>
  </div>

  <!-- Messages -->
  <div class="messages" *ngIf="errorMessage || successMessage">
    <div class="alert alert-error" *ngIf="errorMessage">
      <span>‚ùå</span> {{ errorMessage }}
    </div>
    <div class="alert alert-success" *ngIf="successMessage">
      <span>‚úÖ</span> {{ successMessage }}
    </div>
  </div>

  <!-- Main Content -->
  <div class="content-wrapper">
    <!-- Items Panel -->
    <div class="items-panel">
      <!-- Search and Category Filter -->
      <div class="filters-bar" [class.collapsed]="!filtersExpanded" *ngIf="!showCreateItemForm && selectedFY?.showSearchBox !== false">
        <div class="filters-header">
          <button 
            class="btn-toggle-filters" 
            (click)="toggleFilters()"
            [title]="(filtersExpanded ? 'procurement.hideFilters' : 'procurement.showFilters') | translate">
            <span class="toggle-icon" [class.collapsed]="!filtersExpanded">‚ñº</span>
            <span class="toggle-label">{{ (filtersExpanded ? 'procurement.hideFilters' : 'procurement.showFilters') | translate }}</span>
          </button>
        </div>
        <div class="filters-content" *ngIf="filtersExpanded">
          <!-- Search Box -->
          <div class="search-box">
            <input
              type="text"
              [(ngModel)]="searchTerm"
              [placeholder]="'procurement.searchPlaceholder' | translate"
              class="search-input"
            />
            <button 
              class="btn-clear" 
              *ngIf="searchTerm" 
              (click)="clearSearch()"
              [title]="'common.clear' | translate">
              ‚úï
            </button>
          </div>

          <!-- Category Filter -->
          <div class="category-filter" *ngIf="categories.length > 0 && selectedFY?.showCategoryFilter !== false">
            <span class="filter-label">{{ 'common.category' | translate }}:</span>
            <button 
              class="filter-btn"
              [class.active]="selectedCategoryId === null"
              (click)="filterByCategory(null)">
              {{ 'common.all' | translate }}
            </button>
            <button 
              *ngFor="let category of categories"
              class="filter-btn"
              [class.active]="selectedCategoryId === category.id"
              (click)="filterByCategory(category.id)">
              {{ category.name }}
            </button>
          </div>
        </div>
      </div>

      <!-- Create Item Form -->
      <div class="create-form" *ngIf="showCreateItemForm">
        <h3>{{ 'procurement.createTitle' | translate }}</h3>
        <form (ngSubmit)="createProcurementItem()">
          <div class="form-row">
            <div class="form-group">
              <label for="newItemPR">{{ 'procurement.purchaseRequisition' | translate }}</label>
              <input
                type="text"
                id="newItemPR"
                [(ngModel)]="newItemPR"
                name="newItemPR"
                [placeholder]="'procurement.enterPrPlaceholder' | translate"
              />
            </div>
            <div class="form-group">
              <label for="newItemPO">{{ 'procurement.purchaseOrder' | translate }}</label>
              <input
                type="text"
                id="newItemPO"
                [(ngModel)]="newItemPO"
                name="newItemPO"
                [placeholder]="'procurement.enterPoPlaceholder' | translate"
              />
            </div>
          </div>
          <div class="form-group">
            <label for="newItemName">{{ 'common.name' | translate }} *</label>
            <input
              type="text"
              id="newItemName"
              [(ngModel)]="newItemName"
              name="newItemName"
              required
              [placeholder]="'procurement.enterName' | translate"
            />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="newItemCategory">{{ 'common.category' | translate }}</label>
              <select id="newItemCategory" [(ngModel)]="newItemCategoryId" name="newItemCategory">
                <option [ngValue]="null">-- {{ 'procurement.noCategory' | translate }} --</option>
                <option *ngFor="let category of categories" [ngValue]="category.id">
                  {{ category.name }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="newItemDescription">{{ 'common.description' | translate }}</label>
            <textarea
              id="newItemDescription"
              [(ngModel)]="newItemDescription"
              name="newItemDescription"
              [placeholder]="'procurement.enterDescription' | translate"
              rows="3"
            ></textarea>
          </div>
          
          <!-- Vendor & Contract Fields -->
          <div class="form-row">
            <div class="form-group">
              <label for="newItemVendor">{{ 'procurement.vendor' | translate }}</label>
              <input
                type="text"
                id="newItemVendor"
                [(ngModel)]="newItemVendor"
                name="newItemVendor"
                [placeholder]="'procurement.vendorPlaceholder' | translate"
              />
            </div>
            <div class="form-group">
              <label for="newItemContractNumber">{{ 'procurement.contractNumber' | translate }}</label>
              <input
                type="text"
                id="newItemContractNumber"
                [(ngModel)]="newItemContractNumber"
                name="newItemContractNumber"
                [placeholder]="'procurement.contractPlaceholder' | translate"
              />
            </div>
          </div>

          <!-- Quoted/Estimated Price Fields -->
          <div class="form-row">
            <div class="form-group">
              <label for="newItemQuotedPrice">{{ 'procurement.quotedPrice' | translate }}</label>
              <input
                type="number"
                id="newItemQuotedPrice"
                [(ngModel)]="newItemQuotedPrice"
                name="newItemQuotedPrice"
                step="0.01"
                min="0"
                [placeholder]="'procurement.quotedPricePlaceholder' | translate"
              />
            </div>
            <div class="form-group">
              <label for="newItemQuotedPriceCurrency">{{ 'procurement.quotedPriceCurrency' | translate }}</label>
              <select id="newItemQuotedPriceCurrency" [(ngModel)]="newItemQuotedPriceCurrency" name="newItemQuotedPriceCurrency">
                <option *ngFor="let currency of currencies" [value]="currency.code">
                  {{ getCurrencyFlag(currency.code) }} {{ currency.code }} - {{ currency.name }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row" *ngIf="newItemQuotedPriceCurrency !== 'CAD'">
            <div class="form-group">
              <label for="newItemQuotedPriceExchangeRate">{{ 'procurement.exchangeRateToCad' | translate }}</label>
              <input
                type="number"
                id="newItemQuotedPriceExchangeRate"
                [(ngModel)]="newItemQuotedPriceExchangeRate"
                name="newItemQuotedPriceExchangeRate"
                step="0.0001"
                min="0"
                [placeholder]="'procurement.exchangeRatePlaceholder' | translate"
              />
            </div>
            <div class="form-group">
              <label for="newItemQuotedPriceCad">{{ 'procurement.quotedPriceCad' | translate }}</label>
              <input
                type="number"
                id="newItemQuotedPriceCad"
                [(ngModel)]="newItemQuotedPriceCad"
                name="newItemQuotedPriceCad"
                step="0.01"
                min="0"
                [placeholder]="'procurement.cadEquivalent' | translate"
              />
            </div>
          </div>

          <!-- Final Price Fields -->
          <div class="form-row">
            <div class="form-group">
              <label for="newItemFinalPrice">{{ 'procurement.finalPrice' | translate }}</label>
              <input
                type="number"
                id="newItemFinalPrice"
                [(ngModel)]="newItemFinalPrice"
                name="newItemFinalPrice"
                step="0.01"
                min="0"
                [placeholder]="'procurement.finalPricePlaceholder' | translate"
              />
            </div>
            <div class="form-group">
              <label for="newItemFinalPriceCurrency">{{ 'procurement.finalPriceCurrency' | translate }}</label>
              <select id="newItemFinalPriceCurrency" [(ngModel)]="newItemFinalPriceCurrency" name="newItemFinalPriceCurrency">
                <option *ngFor="let currency of currencies" [value]="currency.code">
                  {{ getCurrencyFlag(currency.code) }} {{ currency.code }} - {{ currency.name }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row" *ngIf="newItemFinalPriceCurrency !== 'CAD'">
            <div class="form-group">
              <label for="newItemFinalPriceExchangeRate">{{ 'procurement.exchangeRateToCad' | translate }}</label>
              <input
                type="number"
                id="newItemFinalPriceExchangeRate"
                [(ngModel)]="newItemFinalPriceExchangeRate"
                name="newItemFinalPriceExchangeRate"
                step="0.0001"
                min="0"
                [placeholder]="'procurement.exchangeRatePlaceholder' | translate"
              />
            </div>
            <div class="form-group">
              <label for="newItemFinalPriceCad">{{ 'procurement.finalPriceCad' | translate }}</label>
              <input
                type="number"
                id="newItemFinalPriceCad"
                [(ngModel)]="newItemFinalPriceCad"
                name="newItemFinalPriceCad"
                step="0.01"
                min="0"
                [placeholder]="'procurement.cadEquivalent' | translate"
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="newItemContractStartDate">{{ 'procurement.contractStartDate' | translate }}</label>
              <input
                type="date"
                id="newItemContractStartDate"
                [(ngModel)]="newItemContractStartDate"
                name="newItemContractStartDate"
              />
            </div>
            <div class="form-group">
              <label for="newItemContractEndDate">{{ 'procurement.contractEndDate' | translate }}</label>
              <input
                type="date"
                id="newItemContractEndDate"
                [(ngModel)]="newItemContractEndDate"
                name="newItemContractEndDate"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group form-checkbox">
              <input
                type="checkbox"
                id="newItemProcurementCompleted"
                [(ngModel)]="newItemProcurementCompleted"
                name="newItemProcurementCompleted"
              />
              <label for="newItemProcurementCompleted">{{ 'procurement.procurementCompleted' | translate }}</label>
            </div>
            <div class="form-group" *ngIf="newItemProcurementCompleted">
              <label for="newItemProcurementCompletedDate">{{ 'procurement.completionDate' | translate }}</label>
              <input
                type="date"
                id="newItemProcurementCompletedDate"
                [(ngModel)]="newItemProcurementCompletedDate"
                name="newItemProcurementCompletedDate"
              />
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="cancelCreateItem()">{{ 'common.cancel' | translate }}</button>
            <button
              type="submit"
              class="btn btn-primary"
              [disabled]="isCreatingItem || !newItemName.trim()"
            >
              {{ isCreatingItem ? ('procurement.creating' | translate) : ('common.create' | translate) }}
            </button>
          </div>
        </form>
      </div>

      <!-- Items List -->
      <div class="items-list-container">
        <div class="loading" *ngIf="isLoadingItems">
          <span class="spinner"></span> {{ 'common.loading' | translate }}
        </div>

        <!-- Grouped View -->
        <div class="items-list grouped" *ngIf="!isLoadingItems && filteredProcurementItems.length > 0 && selectedFY?.groupByCategory">
          <ng-container *ngFor="let group of groupedProcurementItems; trackBy: trackByGroupName">
            <div class="category-group-header">
              <span class="category-group-name">{{ group.categoryName }}</span>
              <span class="category-group-count">({{ group.items.length }} {{ group.items.length === 1 ? ('common.item' | translate) : ('common.items' | translate) }})</span>
            </div>
            <div class="item-card" *ngFor="let item of group.items; trackBy: trackByItemId" [class.expanded]="selectedItem?.id === item.id">
              <ng-container *ngTemplateOutlet="procurementItemTemplate; context: { item: item }"></ng-container>
            </div>
          </ng-container>
        </div>

        <!-- Flat View -->
        <div class="items-list" *ngIf="!isLoadingItems && filteredProcurementItems.length > 0 && !selectedFY?.groupByCategory">
          <div class="item-card" *ngFor="let item of filteredProcurementItems; trackBy: trackByItemId" [class.expanded]="selectedItem?.id === item.id">
            <ng-container *ngTemplateOutlet="procurementItemTemplate; context: { item: item }"></ng-container>
          </div>
        </div>

        <!-- Procurement Item Template -->
        <ng-template #procurementItemTemplate let-item="item">
          <!-- Item Summary Row -->
          <div class="item-summary" (click)="toggleItemDetails(item)">
            <div class="item-info">
              <span class="item-pr">{{ item.purchaseRequisition }}</span>
              <span class="item-po" *ngIf="item.purchaseOrder">/ {{ item.purchaseOrder }}</span>
              <span class="item-name">{{ item.name }}</span>
              <span class="status-badge" [ngClass]="getStatusClass(item.currentStatus)">
                {{ getStatusLabel(item.currentStatus) }}
              </span>
              <span class="category-badge" *ngIf="item.categoryName && !selectedFY?.groupByCategory">üìÅ {{ item.categoryName }}</span>
              <span class="quotes-count">üìã {{ item.quoteCount || 0 }}</span>
            </div>
            <div class="item-actions">
              <button
                class="btn-icon expand-btn"
                [title]="(selectedItem?.id === item.id ? 'common.collapse' : 'common.expand') | translate"
                (click)="toggleItemDetails(item); $event.stopPropagation()"
              >
                {{ selectedItem?.id === item.id ? '‚ñ≤' : '‚ñº' }}
              </button>
              <button
                class="btn-icon btn-edit"
                [title]="'common.edit' | translate"
                *ngIf="canWrite && editingItemId !== item.id"
                (click)="startEditProcurementItem(item); $event.stopPropagation()"
              >
                ‚úèÔ∏è
              </button>
              <button
                class="btn-icon btn-danger"
                [title]="'common.delete' | translate"
                *ngIf="canWrite"
                (click)="deleteProcurementItem(item); $event.stopPropagation()"
              >
                üóëÔ∏è
              </button>
            </div>
          </div>

          <!-- Expanded Details Section -->
          <div class="item-details" *ngIf="selectedItem?.id === item.id">
              <div class="details-content">
                <!-- Item Info View Mode -->
                <div class="info-section" *ngIf="editingItemId !== item.id">
                  <div class="info-grid">
                    <div class="info-item">
                      <label>{{ 'procurement.purchaseRequisition' | translate }}</label>
                      <span>{{ item.purchaseRequisition }}</span>
                    </div>
                    <div class="info-item">
                      <label>{{ 'procurement.purchaseOrder' | translate }}</label>
                      <span>{{ item.purchaseOrder || '-' }}</span>
                    </div>
                    <div class="info-item">
                      <label>{{ 'common.status' | translate }}</label>
                      <span class="status-badge" [ngClass]="getStatusClass(item.currentStatus)">
                        {{ getStatusLabel(item.currentStatus) }}
                      </span>
                    </div>
                    <div class="info-item" *ngIf="item.vendor">
                      <label>{{ 'procurement.vendor' | translate }}</label>
                      <span>{{ item.vendor }}</span>
                    </div>
                    <div class="info-item" *ngIf="item.quotedPrice">
                      <label>{{ 'procurement.quotedPrice' | translate }}</label>
                      <span class="quoted-price">
                        {{ item.quotedPrice | number:'1.2-2' }} {{ item.quotedPriceCurrency || 'CAD' }}
                      </span>
                      <span class="quoted-price-cad" *ngIf="item.quotedPriceCurrency !== 'CAD' && item.quotedPriceCad">
                        ({{ item.quotedPriceCad | number:'1.2-2' }} CAD)
                      </span>
                    </div>
                    <div class="info-item" *ngIf="item.finalPrice">
                      <label>{{ 'procurement.finalPrice' | translate }}</label>
                      <span class="final-price">
                        {{ item.finalPrice | number:'1.2-2' }} {{ item.finalPriceCurrency || 'CAD' }}
                      </span>
                      <span class="final-price-cad" *ngIf="item.finalPriceCurrency !== 'CAD' && item.finalPriceCad">
                        ({{ item.finalPriceCad | number:'1.2-2' }} CAD)
                      </span>
                    </div>
                    <div class="info-item" *ngIf="item.contractNumber">
                      <label>{{ 'procurement.contractNumber' | translate }}</label>
                      <span>{{ item.contractNumber }}</span>
                    </div>
                    <div class="info-item" *ngIf="item.contractStartDate || item.contractEndDate">
                      <label>{{ 'procurement.contractPeriod' | translate }}</label>
                      <span>
                        {{ item.contractStartDate | date:'mediumDate' }}
                        <ng-container *ngIf="item.contractStartDate && item.contractEndDate"> - </ng-container>
                        {{ item.contractEndDate | date:'mediumDate' }}
                      </span>
                    </div>
                    <div class="info-item">
                      <label>{{ 'procurement.procurementCompleted' | translate }}</label>
                      <span class="completion-badge" [class.completed]="item.procurementCompleted">
                        {{ item.procurementCompleted ? ('common.yes' | translate) + ' ‚úÖ' : ('common.no' | translate) + ' ‚è≥' }}
                      </span>
                      <span *ngIf="item.procurementCompleted && item.procurementCompletedDate" class="completion-date">
                        ({{ item.procurementCompletedDate | date:'mediumDate' }})
                      </span>
                    </div>
                    <div class="info-item">
                      <label>{{ 'procurement.created' | translate }}</label>
                      <span>{{ item.createdAt | date:'medium' }}</span>
                    </div>
                  </div>
                  <div class="description" *ngIf="item.description">
                    <label>{{ 'common.description' | translate }}</label>
                    <p>{{ item.description }}</p>
                  </div>
                </div>

                <!-- Edit Mode -->
                <div class="edit-form" *ngIf="editingItemId === item.id">
                  <h4>{{ 'procurement.editTitle' | translate }}</h4>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="editItemPR">{{ 'procurement.purchaseRequisition' | translate }}</label>
                      <input
                        id="editItemPR"
                        type="text"
                        [(ngModel)]="editItemPR"
                        [placeholder]="'procurement.enterPrPlaceholder' | translate"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                    <div class="form-group">
                      <label for="editItemPO">{{ 'procurement.purchaseOrder' | translate }}</label>
                      <input
                        id="editItemPO"
                        type="text"
                        [(ngModel)]="editItemPO"
                        [placeholder]="'procurement.enterPoPlaceholder' | translate"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="editItemName">{{ 'common.name' | translate }} <span class="required">*</span></label>
                    <input
                      id="editItemName"
                      type="text"
                      [(ngModel)]="editItemName"
                      [placeholder]="'procurement.enterName' | translate"
                      [disabled]="isUpdatingItem"
                      required
                    />
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="editItemCategory">{{ 'common.category' | translate }}</label>
                      <select id="editItemCategory" [(ngModel)]="editItemCategoryId" [disabled]="isUpdatingItem">
                        <option [ngValue]="null">-- {{ 'procurement.noCategory' | translate }} --</option>
                        <option *ngFor="let category of categories" [ngValue]="category.id">
                          {{ category.name }}
                        </option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="editItemDescription">{{ 'common.description' | translate }}</label>
                    <textarea
                      id="editItemDescription"
                      [(ngModel)]="editItemDescription"
                      [placeholder]="'procurement.enterDescription' | translate"
                      [disabled]="isUpdatingItem"
                      rows="3"
                    ></textarea>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="editItemVendor">{{ 'procurement.vendor' | translate }}</label>
                      <input
                        id="editItemVendor"
                        type="text"
                        [(ngModel)]="editItemVendor"
                        [placeholder]="'procurement.vendorPlaceholder' | translate"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                    <div class="form-group">
                      <label for="editItemContractNumber">{{ 'procurement.contractNumber' | translate }}</label>
                      <input
                        id="editItemContractNumber"
                        type="text"
                        [(ngModel)]="editItemContractNumber"
                        [placeholder]="'procurement.contractPlaceholder' | translate"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                  </div>

                  <!-- Quoted/Estimated Price Fields -->
                  <div class="form-row">
                    <div class="form-group">
                      <label for="editItemQuotedPrice">{{ 'procurement.quotedPrice' | translate }}</label>
                      <input
                        id="editItemQuotedPrice"
                        type="number"
                        [(ngModel)]="editItemQuotedPrice"
                        step="0.01"
                        min="0"
                        [placeholder]="'procurement.quotedPricePlaceholder' | translate"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                    <div class="form-group">
                      <label for="editItemQuotedPriceCurrency">{{ 'procurement.quotedPriceCurrency' | translate }}</label>
                      <select id="editItemQuotedPriceCurrency" [(ngModel)]="editItemQuotedPriceCurrency" [disabled]="isUpdatingItem">
                        <option *ngFor="let currency of currencies" [value]="currency.code">
                          {{ getCurrencyFlag(currency.code) }} {{ currency.code }} - {{ currency.name }}
                        </option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row" *ngIf="editItemQuotedPriceCurrency !== 'CAD'">
                    <div class="form-group">
                      <label for="editItemQuotedPriceExchangeRate">{{ 'procurement.exchangeRateToCad' | translate }}</label>
                      <input
                        id="editItemQuotedPriceExchangeRate"
                        type="number"
                        [(ngModel)]="editItemQuotedPriceExchangeRate"
                        step="0.0001"
                        min="0"
                        [placeholder]="'procurement.exchangeRatePlaceholder' | translate"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                    <div class="form-group">
                      <label for="editItemQuotedPriceCad">{{ 'procurement.quotedPriceCad' | translate }}</label>
                      <input
                        id="editItemQuotedPriceCad"
                        type="number"
                        [(ngModel)]="editItemQuotedPriceCad"
                        step="0.01"
                        min="0"
                        [placeholder]="'procurement.cadEquivalent' | translate"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                  </div>

                  <!-- Final Price Fields -->
                  <div class="form-row">
                    <div class="form-group">
                      <label for="editItemFinalPrice">{{ 'procurement.finalPrice' | translate }}</label>
                      <input
                        id="editItemFinalPrice"
                        type="number"
                        [(ngModel)]="editItemFinalPrice"
                        step="0.01"
                        min="0"
                        [placeholder]="'procurement.finalPricePlaceholder' | translate"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                    <div class="form-group">
                      <label for="editItemFinalPriceCurrency">{{ 'procurement.finalPriceCurrency' | translate }}</label>
                      <select id="editItemFinalPriceCurrency" [(ngModel)]="editItemFinalPriceCurrency" [disabled]="isUpdatingItem">
                        <option *ngFor="let currency of currencies" [value]="currency.code">
                          {{ getCurrencyFlag(currency.code) }} {{ currency.code }} - {{ currency.name }}
                        </option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row" *ngIf="editItemFinalPriceCurrency !== 'CAD'">
                    <div class="form-group">
                      <label for="editItemFinalPriceExchangeRate">{{ 'procurement.exchangeRateToCad' | translate }}</label>
                      <input
                        id="editItemFinalPriceExchangeRate"
                        type="number"
                        [(ngModel)]="editItemFinalPriceExchangeRate"
                        step="0.0001"
                        min="0"
                        [placeholder]="'procurement.exchangeRatePlaceholder' | translate"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                    <div class="form-group">
                      <label for="editItemFinalPriceCad">{{ 'procurement.finalPriceCad' | translate }}</label>
                      <input
                        id="editItemFinalPriceCad"
                        type="number"
                        [(ngModel)]="editItemFinalPriceCad"
                        step="0.01"
                        min="0"
                        [placeholder]="'procurement.cadEquivalent' | translate"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label for="editItemContractStartDate">{{ 'procurement.contractStartDate' | translate }}</label>
                      <input
                        id="editItemContractStartDate"
                        type="date"
                        [(ngModel)]="editItemContractStartDate"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                    <div class="form-group">
                      <label for="editItemContractEndDate">{{ 'procurement.contractEndDate' | translate }}</label>
                      <input
                        id="editItemContractEndDate"
                        type="date"
                        [(ngModel)]="editItemContractEndDate"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="checkbox-label">
                        <input
                          type="checkbox"
                          [(ngModel)]="editItemProcurementCompleted"
                          [disabled]="isUpdatingItem"
                        />
                        {{ 'procurement.procurementCompleted' | translate }}
                      </label>
                    </div>
                    <div class="form-group" *ngIf="editItemProcurementCompleted">
                      <label for="editItemProcurementCompletedDate">{{ 'procurement.completionDate' | translate }}</label>
                      <input
                        id="editItemProcurementCompletedDate"
                        type="date"
                        [(ngModel)]="editItemProcurementCompletedDate"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                  </div>
                  <div class="form-actions">
                    <button 
                      type="button"
                      class="btn-secondary" 
                      (click)="cancelEditProcurementItem()"
                      [disabled]="isUpdatingItem"
                    >
                      {{ 'common.cancel' | translate }}
                    </button>
                    <button 
                      type="button"
                      class="btn-primary" 
                      (click)="updateProcurementItem()"
                      [disabled]="isUpdatingItem || !editItemPR.trim() || !editItemName.trim()"
                    >
                      <span *ngIf="isUpdatingItem">{{ 'procurement.updating' | translate }}</span>
                      <span *ngIf="!isUpdatingItem">{{ 'procurement.updateItem' | translate }}</span>
                    </button>
                  </div>
                </div>

                <!-- Quotes Section -->
                <div class="quotes-section">
                  <div class="section-header">
                    <h3>{{ 'procurement.quotes' | translate }} ({{ quotes.length }})</h3>
                    <button class="btn-primary" (click)="showCreateQuote()" *ngIf="canWrite && !showCreateQuoteForm">
                      ‚ûï {{ 'procurement.addQuote' | translate }}
                    </button>
                  </div>

                  <!-- Create Quote Form -->
                  <div class="create-form" *ngIf="showCreateQuoteForm">
                    <h4>{{ 'procurement.addNewQuote' | translate }}</h4>
                    <form (ngSubmit)="createQuote()">
                      <div class="form-row">
                        <div class="form-group">
                          <label for="newQuoteVendorName">{{ 'procurement.vendorName' | translate }} *</label>
                          <input
                            type="text"
                            id="newQuoteVendorName"
                            [(ngModel)]="newQuoteVendorName"
                            name="newQuoteVendorName"
                            required
                          />
                        </div>
                        <div class="form-group">
                          <label for="newQuoteVendorContact">{{ 'procurement.vendorContact' | translate }}</label>
                          <input
                            type="text"
                            id="newQuoteVendorContact"
                            [(ngModel)]="newQuoteVendorContact"
                            name="newQuoteVendorContact"
                          />
                        </div>
                      </div>
                      <div class="form-row">
                        <div class="form-group">
                          <label for="newQuoteReference">{{ 'procurement.quoteReference' | translate }}</label>
                          <input
                            type="text"
                            id="newQuoteReference"
                            [(ngModel)]="newQuoteReference"
                            name="newQuoteReference"
                          />
                        </div>
                        <div class="form-group">
                          <label for="newQuoteCurrency">{{ 'procurement.quoteCurrency' | translate }}</label>
                          <select id="newQuoteCurrency" [(ngModel)]="newQuoteCurrency" name="newQuoteCurrency">
                            <option *ngFor="let currency of currencies" [value]="currency.code">
                              {{ getCurrencyFlag(currency.code) }} {{ currency.code }}
                            </option>
                          </select>
                        </div>
                      </div>
                      <!-- CAP Amount (only if category allows CAP) -->
                      <div class="form-row" *ngIf="selectedItemAllowsCap">
                        <div class="form-group">
                          <label for="newQuoteAmountCap">{{ 'procurement.quoteAmountCap' | translate }} ({{ newQuoteCurrency }})</label>
                          <input
                            type="number"
                            id="newQuoteAmountCap"
                            [(ngModel)]="newQuoteAmountCap"
                            name="newQuoteAmountCap"
                            min="0"
                            step="0.01"
                            [placeholder]="'procurement.quoteAmountCapPlaceholder' | translate"
                          />
                        </div>
                        <div class="form-group" *ngIf="newQuoteCurrency !== 'CAD'">
                          <label for="newQuoteAmountCapCad">{{ 'procurement.quoteAmountCapCad' | translate }}</label>
                          <input
                            type="number"
                            id="newQuoteAmountCapCad"
                            [(ngModel)]="newQuoteAmountCapCad"
                            name="newQuoteAmountCapCad"
                            min="0"
                            step="0.01"
                            [placeholder]="'procurement.quoteAmountCapCadPlaceholder' | translate"
                          />
                        </div>
                      </div>
                      <!-- OM Amount (only if category allows OM) -->
                      <div class="form-row" *ngIf="selectedItemAllowsOm">
                        <div class="form-group">
                          <label for="newQuoteAmountOm">{{ 'procurement.quoteAmountOm' | translate }} ({{ newQuoteCurrency }})</label>
                          <input
                            type="number"
                            id="newQuoteAmountOm"
                            [(ngModel)]="newQuoteAmountOm"
                            name="newQuoteAmountOm"
                            min="0"
                            step="0.01"
                            [placeholder]="'procurement.quoteAmountOmPlaceholder' | translate"
                          />
                        </div>
                        <div class="form-group" *ngIf="newQuoteCurrency !== 'CAD'">
                          <label for="newQuoteAmountOmCad">{{ 'procurement.quoteAmountOmCad' | translate }}</label>
                          <input
                            type="number"
                            id="newQuoteAmountOmCad"
                            [(ngModel)]="newQuoteAmountOmCad"
                            name="newQuoteAmountOmCad"
                            min="0"
                            step="0.01"
                            [placeholder]="'procurement.quoteAmountOmCadPlaceholder' | translate"
                          />
                        </div>
                      </div>
                      <!-- Exchange Rate (only if currency is not CAD) -->
                      <div class="form-row" *ngIf="newQuoteCurrency !== 'CAD'">
                        <div class="form-group">
                          <label for="newQuoteExchangeRate">{{ 'procurement.quoteExchangeRate' | translate }}</label>
                          <input
                            type="number"
                            id="newQuoteExchangeRate"
                            [(ngModel)]="newQuoteExchangeRate"
                            name="newQuoteExchangeRate"
                            min="0"
                            step="0.000001"
                            [placeholder]="'procurement.quoteExchangeRatePlaceholder' | translate"
                          />
                        </div>
                      </div>
                      <div class="form-row">
                        <div class="form-group">
                          <label for="newQuoteReceivedDate">{{ 'procurement.receivedDate' | translate }}</label>
                          <input
                            type="date"
                            id="newQuoteReceivedDate"
                            [(ngModel)]="newQuoteReceivedDate"
                            name="newQuoteReceivedDate"
                          />
                        </div>
                        <div class="form-group">
                          <label for="newQuoteExpiryDate">{{ 'procurement.expiryDate' | translate }}</label>
                          <input
                            type="date"
                            id="newQuoteExpiryDate"
                            [(ngModel)]="newQuoteExpiryDate"
                            name="newQuoteExpiryDate"
                          />
                        </div>
                      </div>
                      <div class="form-group">
                        <label for="newQuoteNotes">{{ 'procurement.notes' | translate }}</label>
                        <textarea
                          id="newQuoteNotes"
                          [(ngModel)]="newQuoteNotes"
                          name="newQuoteNotes"
                          rows="2"
                        ></textarea>
                      </div>
                      <!-- Attach File Section -->
                      <div class="form-group file-attach-section">
                        <label for="newQuoteFile">{{ 'procurement.attachFile' | translate }}</label>
                        <div class="file-input-wrapper">
                          <input
                            type="file"
                            id="newQuoteFile"
                            (change)="onQuoteFileSelected($event)"
                            accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.xls,.xlsx,.txt,.csv"
                          />
                          <span class="file-hint">{{ 'procurement.fileHint' | translate }}</span>
                        </div>
                        <div *ngIf="newQuoteFile" class="selected-file-info">
                          <span class="file-icon">üìé</span>
                          <span class="file-name">{{ newQuoteFile.name }}</span>
                          <span class="file-size">({{ formatFileSize(newQuoteFile.size) }})</span>
                          <button type="button" class="btn-remove-file" (click)="removeQuoteFile()">‚úï</button>
                        </div>
                        <div class="form-group file-description" *ngIf="newQuoteFile">
                          <label for="newQuoteFileDescription">{{ 'procurement.fileDescription' | translate }}</label>
                          <input
                            type="text"
                            id="newQuoteFileDescription"
                            [(ngModel)]="newQuoteFileDescription"
                            name="newQuoteFileDescription"
                            [placeholder]="'procurement.fileDescriptionPlaceholder' | translate"
                          />
                        </div>
                      </div>
                      <div class="form-actions">
                        <button type="button" class="btn-secondary" (click)="cancelCreateQuote()">{{ 'common.cancel' | translate }}</button>
                        <button
                          type="submit"
                          class="btn-primary"
                          [disabled]="isCreatingQuote || !newQuoteVendorName.trim()"
                        >
                          {{ isCreatingQuote ? ('procurement.adding' | translate) : ('procurement.addQuote' | translate) }}
                        </button>
                      </div>
                    </form>
                  </div>

                  <!-- Quotes List -->
                  <div class="quotes-list">
                    <div class="loading" *ngIf="isLoadingQuotes">
                      <span class="spinner"></span> {{ 'procurement.loadingQuotes' | translate }}
                    </div>

                    <div class="quote-card" *ngFor="let quote of quotes" [class.selected]="quote.selected">
                      <div class="quote-header">
                        <div class="vendor-info">
                          <span class="vendor-name">{{ quote.vendorName }}</span>
                          <span class="quote-ref" *ngIf="quote.quoteReference">#{{ quote.quoteReference }}</span>
                        </div>
                        <span class="status-badge" [ngClass]="getQuoteStatusClass(quote.status)">
                          {{ getQuoteStatusLabel(quote.status) }}
                        </span>
                      </div>
                      <div class="quote-body">
                        <div class="quote-amount" *ngIf="quote.amount !== null && quote.amount !== undefined">
                          <span class="currency-flag">{{ getCurrencyFlag(quote.currency) }}</span>
                          {{ formatCurrency(quote.amount, quote.currency) }}
                        </div>
                        <div class="quote-dates">
                          <span *ngIf="quote.receivedDate">{{ 'procurement.received' | translate }}: {{ quote.receivedDate | date:'shortDate' }}</span>
                          <span *ngIf="quote.expiryDate">{{ 'procurement.expires' | translate }}: {{ quote.expiryDate | date:'shortDate' }}</span>
                        </div>
                        <p class="quote-notes" *ngIf="quote.notes">{{ quote.notes }}</p>
                      </div>
                      <div class="quote-actions">
                        <button class="btn-icon" [title]="'procurement.viewFiles' | translate" (click)="viewQuoteFiles(quote)">
                          üìÅ {{ 'procurement.files' | translate }} ({{ quote.fileCount || 0 }})
                        </button>
                        <button
                          class="btn-icon btn-select"
                          [title]="'procurement.selectQuoteComingSoon' | translate"
                          *ngIf="canWrite && !quote.selected && quote.status !== 'REJECTED'"
                          disabled
                          [class.disabled]="true"
                        >
                          ‚úÖ {{ 'procurement.select' | translate }}
                        </button>
                        <button
                          class="btn-icon btn-danger"
                          [title]="'common.delete' | translate"
                          *ngIf="canWrite"
                          (click)="deleteQuote(quote)"
                        >
                          üóëÔ∏è
                        </button>
                      </div>
                      <div class="selected-badge" *ngIf="quote.selected">
                        ‚úì {{ 'procurement.selectedQuote' | translate }}
                      </div>
                    </div>

                    <div class="empty-state" *ngIf="!isLoadingQuotes && quotes.length === 0">
                      <p>{{ 'procurement.noQuotes' | translate }}</p>
                      <p *ngIf="canWrite">{{ 'procurement.clickAddQuote' | translate }}</p>
                    </div>
                  </div>
                </div>

                <!-- Procurement Events/Tracking Section -->
                <div class="events-section">
                  <div class="section-header">
                    <h3>üìã {{ 'procurement.tracking' | translate }} ({{ events.length }})</h3>
                    <div class="section-actions">
                      <button 
                        class="btn-toggle" 
                        (click)="toggleEventsPanel()"
                        [class.active]="showEventsPanel">
                        {{ showEventsPanel ? ('procurement.hide' | translate) + ' ‚ñº' : ('procurement.show' | translate) + ' ‚ñ∂' }}
                      </button>
                      <button 
                        class="btn-primary" 
                        (click)="showCreateEvent()" 
                        *ngIf="canWrite && showEventsPanel && !showCreateEventForm">
                        ‚ûï {{ 'procurement.addEvent' | translate }}
                      </button>
                    </div>
                  </div>

                  <!-- Collapsed View - Show only the most recent event -->
                  <div class="events-collapsed" *ngIf="!showEventsPanel && mostRecentEvent">
                    <div class="event-item collapsed-event" [ngClass]="getEventTypeClass(mostRecentEvent.eventType)">
                      <div class="event-icon">{{ getEventTypeIcon(mostRecentEvent.eventType) }}</div>
                      <div class="event-content">
                        <div class="event-header">
                          <span class="event-type">{{ getEventTypeLabel(mostRecentEvent.eventType) }}</span>
                          <span class="event-date">{{ mostRecentEvent.eventDate | date:'mediumDate' }}</span>
                          <span class="status-badge small" *ngIf="mostRecentEvent.newStatus" [ngClass]="getEventStatusClass(mostRecentEvent.newStatus)">
                            {{ getEventStatusLabel(mostRecentEvent.newStatus) }}
                          </span>
                        </div>
                        <p class="event-comment" *ngIf="mostRecentEvent.comment">{{ mostRecentEvent.comment }}</p>
                      </div>
                    </div>
                  </div>
                  <div class="events-collapsed empty" *ngIf="!showEventsPanel && !mostRecentEvent && !isLoadingEvents">
                    <p class="no-events-message">{{ 'procurement.noEvents' | translate }}</p>
                  </div>

                  <div class="events-content" *ngIf="showEventsPanel">
                    <!-- Create/Edit Event Form -->
                    <div class="create-form event-form" *ngIf="showCreateEventForm">
                      <h4>{{ editingEvent ? ('procurement.editEvent' | translate) : ('procurement.addNewEvent' | translate) }}</h4>
                      <form (ngSubmit)="editingEvent ? updateEvent() : createEvent()">
                        <div class="form-row">
                          <div class="form-group">
                            <label for="newEventType">{{ 'procurement.eventType' | translate }} *</label>
                            <select 
                              id="newEventType" 
                              [(ngModel)]="newEventType" 
                              name="newEventType"
                              required>
                              <option *ngFor="let type of eventTypeOptions" [value]="type">
                                {{ getEventTypeIcon(type) }} {{ getEventTypeLabel(type) }}
                              </option>
                            </select>
                          </div>
                          <div class="form-group">
                            <label for="newEventDate">{{ 'common.date' | translate }} *</label>
                            <input
                              type="date"
                              id="newEventDate"
                              [(ngModel)]="newEventDate"
                              name="newEventDate"
                              required
                            />
                          </div>
                        </div>
                        <div class="form-group">
                          <label for="newEventComment">{{ 'procurement.commentNotes' | translate }}</label>
                          <textarea
                            id="newEventComment"
                            [(ngModel)]="newEventComment"
                            name="newEventComment"
                            rows="2"
                            [placeholder]="'procurement.optionalComment' | translate"
                          ></textarea>
                        </div>
                        <div class="form-actions">
                          <button type="button" class="btn-secondary" (click)="cancelEventForm()">{{ 'common.cancel' | translate }}</button>
                          <button
                            type="submit"
                            class="btn-primary"
                            [disabled]="isCreatingEvent || !newEventDate">
                            {{ isCreatingEvent ? (editingEvent ? ('procurement.updating' | translate) : ('procurement.adding' | translate)) : (editingEvent ? ('common.edit' | translate) : ('procurement.addEvent' | translate)) }}
                          </button>
                        </div>
                      </form>
                    </div>

                    <!-- Events Timeline -->
                    <div class="events-timeline">
                      <div class="loading" *ngIf="isLoadingEvents">
                        <span class="spinner"></span> {{ 'procurement.loadingEvents' | translate }}
                      </div>

                      <div class="event-item" 
                           *ngFor="let event of events" 
                           [ngClass]="getEventTypeClass(event.eventType)">
                        <div class="event-icon">{{ getEventTypeIcon(event.eventType) }}</div>
                        <div class="event-content">
                          <div class="event-header">
                            <span class="event-type">{{ getEventTypeLabel(event.eventType) }}</span>
                            <span class="event-date">{{ event.eventDate | date:'mediumDate' }}</span>
                            <span class="status-badge small" *ngIf="event.newStatus" [ngClass]="getEventStatusClass(event.newStatus)">
                              {{ getEventStatusLabel(event.newStatus) }}
                            </span>
                          </div>
                          <p class="event-comment" *ngIf="event.comment">{{ event.comment }}</p>
                          <div class="event-meta">
                            <span class="created-by" *ngIf="event.createdBy">{{ 'procurement.by' | translate }}: {{ event.createdBy }}</span>
                            <span class="created-at" *ngIf="event.createdAt">{{ event.createdAt | date:'short' }}</span>
                          </div>
                        </div>
                        <div class="event-actions" *ngIf="canWrite">
                          <button class="btn-icon" [title]="'common.edit' | translate" (click)="editEvent(event)">‚úèÔ∏è</button>
                          <button class="btn-icon btn-danger" [title]="'common.delete' | translate" (click)="deleteEvent(event)">üóëÔ∏è</button>
                        </div>
                      </div>

                      <div class="empty-state" *ngIf="!isLoadingEvents && events.length === 0">
                        <p>{{ 'procurement.noEvents' | translate }}</p>
                        <p *ngIf="canWrite">{{ 'procurement.clickAddEvent' | translate }}</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
        </ng-template>

        <!-- Empty State - No items match filter -->
        <div class="empty-state" *ngIf="!isLoadingItems && procurementItems.length > 0 && filteredProcurementItems.length === 0">
          <div class="empty-icon">üîç</div>
          <h3>{{ 'procurement.noMatchingItems' | translate }}</h3>
          <p>{{ 'procurement.noMatchingItemsDesc' | translate }}</p>
          <button class="btn-secondary" (click)="clearSearch(); selectedCategoryId = null">
            {{ 'procurement.clearFilters' | translate }}
          </button>
        </div>

        <!-- Empty State - No items exist -->
        <div class="empty-state" *ngIf="!isLoadingItems && procurementItems.length === 0">
          <div class="empty-icon">üõí</div>
          <h3>{{ 'procurement.noItems' | translate }}</h3>
          <p>{{ 'procurement.createFirst' | translate }}</p>
          <button class="btn btn-primary" (click)="showCreateItem()" *ngIf="canWrite">
            {{ 'procurement.createFirstItem' | translate }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Files Modal -->
  <div class="modal-overlay" *ngIf="selectedQuote" (click)="closeQuoteFiles()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ 'procurement.filesForQuote' | translate }}: {{ selectedQuote.vendorName }}</h3>
        <button class="btn-close" (click)="closeQuoteFiles()">‚úï</button>
      </div>
      <div class="modal-body">
        <!-- Upload Form -->
        <div class="upload-section" *ngIf="canWrite">
          <button class="btn-primary" (click)="showFileUploadForm()" *ngIf="!showFileUpload">
            üìé {{ 'procurement.uploadFile' | translate }}
          </button>

          <div class="upload-form" *ngIf="showFileUpload">
            <div class="form-group">
              <label for="fileInput">{{ 'procurement.selectFile' | translate }}</label>
              <input
                type="file"
                id="fileInput"
                (change)="onFileSelected($event)"
                accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.xls,.xlsx,.txt,.csv"
              />
            </div>
            <div class="form-group">
              <label for="fileDescription">{{ 'procurement.descriptionOptional' | translate }}</label>
              <input
                type="text"
                id="fileDescription"
                [(ngModel)]="fileDescription"
                [placeholder]="'procurement.fileDescriptionPlaceholder' | translate"
              />
            </div>
            <div class="form-actions">
              <button type="button" class="btn-secondary" (click)="cancelFileUpload()">{{ 'common.cancel' | translate }}</button>
              <button
                type="button"
                class="btn-primary"
                [disabled]="isUploadingFile || !selectedFile"
                (click)="uploadFile()"
              >
                {{ isUploadingFile ? ('common.uploading' | translate) : ('common.upload' | translate) }}
              </button>
            </div>
          </div>
        </div>

        <!-- Files List -->
        <div class="files-list">
          <div class="loading" *ngIf="isLoadingFiles">
            <span class="spinner"></span> {{ 'procurement.loadingFiles' | translate }}
          </div>

          <div class="file-item" *ngFor="let file of files">
            <span class="file-icon">{{ getFileIcon(file.contentType) }}</span>
            <div class="file-info">
              <span class="file-name">{{ file.fileName }}</span>
              <span class="file-meta">{{ file.fileSize | number }} {{ 'procurement.bytes' | translate }}</span>
              <span class="file-desc" *ngIf="file.description">{{ file.description }}</span>
            </div>
            <div class="file-actions">
              <button class="btn-icon" [title]="'procurement.preview' | translate" (click)="previewFile(file)" *ngIf="isPreviewable(file.contentType)">üëÅÔ∏è</button>
              <button class="btn-icon" [title]="'procurement.openInNewTab' | translate" (click)="viewFile(file)">üîó</button>
              <button class="btn-icon" [title]="'common.download' | translate" (click)="downloadFile(file)">‚¨áÔ∏è</button>
              <button
                class="btn-icon btn-danger"
                [title]="'common.delete' | translate"
                *ngIf="canWrite"
                (click)="deleteFile(file)"
              >
                üóëÔ∏è
              </button>
            </div>
          </div>

          <div class="empty-state" *ngIf="!isLoadingFiles && files.length === 0">
            <p>{{ 'procurement.noFilesUploaded' | translate }}</p>
            <p *ngIf="canWrite">{{ 'procurement.clickUploadFile' | translate }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- File Preview Modal -->
  <div class="preview-overlay" *ngIf="previewingFile" (click)="closePreview()">
    <div class="preview-modal" (click)="$event.stopPropagation()">
      <div class="preview-header">
        <h3>{{ previewingFile.fileName }}</h3>
        <div class="preview-actions">
          <button class="btn-icon" [title]="'procurement.openInNewTab' | translate" (click)="viewFile(previewingFile)">üîó</button>
          <button class="btn-icon" [title]="'common.download' | translate" (click)="downloadFile(previewingFile)">‚¨áÔ∏è</button>
          <button class="btn-close" (click)="closePreview()">‚úï</button>
        </div>
      </div>
      <div class="preview-content">
        <div class="loading" *ngIf="isLoadingPreview">
          <span class="spinner"></span> {{ 'procurement.loadingPreview' | translate }}
        </div>
        <iframe 
          *ngIf="!isLoadingPreview && previewUrl && previewingFile.contentType === 'application/pdf'" 
          [src]="previewUrl" 
          class="pdf-preview"
          [title]="'procurement.pdfPreview' | translate">
        </iframe>
        <img 
          *ngIf="!isLoadingPreview && previewUrl && previewingFile.contentType.startsWith('image/')" 
          [src]="previewUrl" 
          class="image-preview"
          [alt]="'procurement.imagePreview' | translate"
        />
        <div class="text-preview" *ngIf="!isLoadingPreview && previewUrl && previewingFile.contentType.startsWith('text/')">
          <pre>{{ previewTextContent }}</pre>
        </div>
      </div>
    </div>
  </div>
</div>
