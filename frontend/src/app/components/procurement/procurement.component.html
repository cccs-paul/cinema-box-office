<!--
  myRC - Procurement Component Template
  Copyright (c) 2026 myRC Team
  Licensed under MIT License
-->
<div class="procurement-container">
  <!-- Messages -->
  <div class="messages" *ngIf="errorMessage || successMessage">
    <div class="alert alert-error" *ngIf="errorMessage">
      <span>‚ùå</span> {{ errorMessage }}
    </div>
    <div class="alert alert-success" *ngIf="successMessage">
      <span>‚úÖ</span> {{ successMessage }}
    </div>
  </div>

  <!-- Main Content -->
  <div class="content-wrapper">
    <!-- Items Panel -->
    <div class="items-panel">
      <!-- Search and Category Filter -->
      <div class="filters-bar" [class.collapsed]="!filtersExpanded" *ngIf="!showCreateItemForm && selectedFY?.showSearchBox !== false">
        <!-- Search Box - Always Visible -->
        <div class="search-box-always-visible">
          <input
            type="text"
            [(ngModel)]="searchTerm"
            [placeholder]="'procurement.searchPlaceholder' | translate"
            class="search-input"
          />
          <button 
            class="btn-clear" 
            *ngIf="searchTerm" 
            (click)="clearSearch()"
            [title]="'common.clear' | translate">
            ‚úï
          </button>
          <button 
            class="btn-toggle-filters" 
            (click)="toggleFilters()"
            [title]="(filtersExpanded ? 'procurement.hideFilters' : 'procurement.showFilters') | translate">
            <span class="toggle-icon" [class.collapsed]="!filtersExpanded">‚ñº</span>
            <span class="toggle-label">{{ (filtersExpanded ? 'procurement.hideFilters' : 'procurement.showFilters') | translate }}</span>
          </button>
        </div>
        <div class="filters-content" *ngIf="filtersExpanded">
          <!-- Category Filter -->
          <div class="category-filter" *ngIf="categories.length > 0 && selectedFY?.showCategoryFilter !== false">
            <span class="filter-label">{{ 'common.category' | translate }}:</span>
            <button 
              class="filter-btn"
              [class.active]="selectedCategoryId === null"
              (click)="filterByCategory(null)">
              {{ 'common.all' | translate }}
            </button>
            <button 
              *ngFor="let category of categories"
              class="filter-btn"
              [class.active]="selectedCategoryId === category.id"
              (click)="filterByCategory(category.id)">
              {{ getCategoryDisplayName(category) }}
            </button>
          </div>

          <!-- Tracking Status Filter -->
          <div class="tracking-status-filter">
            <span class="filter-label">{{ 'procurement.trackingStatus' | translate }}:</span>
            <button 
              class="filter-btn"
              [class.active]="selectedTrackingStatus === null"
              (click)="filterByTrackingStatus(null)">
              {{ 'common.all' | translate }}
            </button>
            <button 
              *ngFor="let status of trackingStatusOptions"
              class="filter-btn"
              [class.active]="selectedTrackingStatus === status"
              [ngClass]="getTrackingStatusClass(status)"
              (click)="filterByTrackingStatus(status)">
              <span class="status-icon">{{ getTrackingStatusIcon(status) }}</span>
              {{ getTrackingStatusLabel(status) }}
            </button>
          </div>

          <!-- Procurement Type Filter -->
          <div class="procurement-type-filter">
            <span class="filter-label">{{ 'procurement.procurementType' | translate }}:</span>
            <button 
              class="filter-btn"
              [class.active]="selectedProcurementType === null"
              (click)="filterByProcurementType(null)">
              {{ 'common.all' | translate }}
            </button>
            <button 
              *ngFor="let pt of procurementTypeOptions"
              class="filter-btn"
              [class.active]="selectedProcurementType === pt"
              [ngClass]="getProcurementTypeClass(pt)"
              (click)="filterByProcurementType(pt)">
              <span class="type-icon">{{ getProcurementTypeIcon(pt) }}</span>
              {{ getProcurementTypeLabel(pt) }}
            </button>
          </div>
        </div>
      </div>

      <!-- Create Item Form -->
      <div class="create-form" *ngIf="showCreateItemForm">
        <h3>{{ 'procurement.createTitle' | translate }}</h3>
        <form (ngSubmit)="createProcurementItem()">
          <div class="form-row">
            <div class="form-group">
              <label for="newItemPR">{{ 'procurement.pr' | translate }}</label>
              <input
                type="text"
                id="newItemPR"
                [(ngModel)]="newItemPR"
                name="newItemPR"
                [placeholder]="'procurement.enterPrPlaceholder' | translate"
              />
            </div>
            <div class="form-group">
              <label for="newItemPO">{{ 'procurement.po' | translate }}</label>
              <input
                type="text"
                id="newItemPO"
                [(ngModel)]="newItemPO"
                name="newItemPO"
                [placeholder]="'procurement.enterPoPlaceholder' | translate"
              />
            </div>
            <div class="form-group">
              <label for="newItemProcurementType">{{ 'procurement.procurementType' | translate }}</label>
              <select id="newItemProcurementType" [(ngModel)]="newItemProcurementType" name="newItemProcurementType">
                <option *ngFor="let pt of procurementTypeOptions" [value]="pt">
                  {{ getProcurementTypeIcon(pt) }} {{ getProcurementTypeLabel(pt) }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="newItemName">{{ 'common.name' | translate }} *</label>
            <input
              type="text"
              id="newItemName"
              [(ngModel)]="newItemName"
              name="newItemName"
              required
              [placeholder]="'procurement.enterName' | translate"
            />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="newItemCategory">{{ 'common.category' | translate }}</label>
              <select id="newItemCategory" [(ngModel)]="newItemCategoryId" name="newItemCategory">
                <option [ngValue]="null">-- {{ 'procurement.noCategory' | translate }} --</option>
                <option *ngFor="let category of categories" [ngValue]="category.id">
                  {{ getCategoryDisplayName(category) }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="newItemDescription">{{ 'common.description' | translate }}</label>
            <textarea
              id="newItemDescription"
              [(ngModel)]="newItemDescription"
              name="newItemDescription"
              [placeholder]="'procurement.enterDescription' | translate"
              rows="3"
            ></textarea>
          </div>
          
          <!-- Vendor & Contract Fields -->
          <div class="form-row">
            <div class="form-group">
              <label for="newItemVendor">{{ 'procurement.vendor' | translate }}</label>
              <input
                type="text"
                id="newItemVendor"
                [(ngModel)]="newItemVendor"
                name="newItemVendor"
                [placeholder]="'procurement.vendorPlaceholder' | translate"
              />
            </div>
            <div class="form-group">
              <label for="newItemContractNumber">{{ 'procurement.contractNumber' | translate }}</label>
              <input
                type="text"
                id="newItemContractNumber"
                [(ngModel)]="newItemContractNumber"
                name="newItemContractNumber"
                [placeholder]="'procurement.contractPlaceholder' | translate"
              />
            </div>
          </div>

          <!-- Quoted/Estimated Price Fields -->
          <div class="form-row">
            <div class="form-group">
              <label for="newItemQuotedPrice">{{ 'procurement.quotedPrice' | translate }}</label>
              <input
                type="text"
                currencyInput
                id="newItemQuotedPrice"
                [(ngModel)]="newItemQuotedPrice"
                (ngModelChange)="onNewQuotedPriceChange()"
                name="newItemQuotedPrice"
                [placeholder]="'procurement.quotedPricePlaceholder' | translate"
              />
            </div>
            <div class="form-group">
              <label for="newItemQuotedPriceCurrency">{{ 'procurement.quotedPriceCurrency' | translate }}</label>
              <select id="newItemQuotedPriceCurrency" [(ngModel)]="newItemQuotedPriceCurrency" (ngModelChange)="onNewQuotedPriceChange()" name="newItemQuotedPriceCurrency">
                <option *ngFor="let currency of currencies" [value]="currency.code">
                  {{ getCurrencyFlag(currency.code) }} {{ currency.code }} - {{ currency.name }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row" *ngIf="newItemQuotedPriceCurrency !== 'CAD'">
            <div class="form-group">
              <label for="newItemQuotedPriceExchangeRate">{{ 'procurement.quotedPriceExchangeRate' | translate }}</label>
              <input
                type="number"
                id="newItemQuotedPriceExchangeRate"
                [(ngModel)]="newItemQuotedPriceExchangeRate"
                (ngModelChange)="onNewQuotedPriceChange()"
                name="newItemQuotedPriceExchangeRate"
                step="0.0001"
                min="0"
                [placeholder]="'procurement.exchangeRatePlaceholder' | translate"
              />
            </div>
            <div class="form-group">
              <label for="newItemQuotedPriceCad">{{ 'procurement.quotedPriceCad' | translate }}</label>
              <input
                type="text"
                id="newItemQuotedPriceCad"
                [value]="newItemQuotedPriceCad != null ? formatCurrency(newItemQuotedPriceCad, 'CAD') : ''"
                readonly
                class="computed-field"
                [placeholder]="'procurement.cadEquivalent' | translate"
              />
            </div>
          </div>

          <!-- Final Price Fields -->
          <div class="form-row">
            <div class="form-group">
              <label for="newItemFinalPrice">{{ 'procurement.finalPrice' | translate }}</label>
              <input
                type="text"
                currencyInput
                id="newItemFinalPrice"
                [(ngModel)]="newItemFinalPrice"
                (ngModelChange)="onNewFinalPriceChange()"
                name="newItemFinalPrice"
                [placeholder]="'procurement.finalPricePlaceholder' | translate"
              />
            </div>
            <div class="form-group">
              <label for="newItemFinalPriceCurrency">{{ 'procurement.finalPriceCurrency' | translate }}</label>
              <select id="newItemFinalPriceCurrency" [(ngModel)]="newItemFinalPriceCurrency" (ngModelChange)="onNewFinalPriceChange()" name="newItemFinalPriceCurrency">
                <option *ngFor="let currency of currencies" [value]="currency.code">
                  {{ getCurrencyFlag(currency.code) }} {{ currency.code }} - {{ currency.name }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-row" *ngIf="newItemFinalPriceCurrency !== 'CAD'">
            <div class="form-group">
              <label for="newItemFinalPriceExchangeRate">{{ 'procurement.finalPriceExchangeRate' | translate }}</label>
              <input
                type="number"
                id="newItemFinalPriceExchangeRate"
                [(ngModel)]="newItemFinalPriceExchangeRate"
                (ngModelChange)="onNewFinalPriceChange()"
                name="newItemFinalPriceExchangeRate"
                step="0.0001"
                min="0"
                [placeholder]="'procurement.exchangeRatePlaceholder' | translate"
              />
            </div>
            <div class="form-group">
              <label for="newItemFinalPriceCad">{{ 'procurement.finalPriceCad' | translate }}</label>
              <input
                type="text"
                id="newItemFinalPriceCad"
                [value]="newItemFinalPriceCad != null ? formatCurrency(newItemFinalPriceCad, 'CAD') : ''"
                readonly
                class="computed-field"
                [placeholder]="'procurement.cadEquivalent' | translate"
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="newItemContractStartDate">{{ 'procurement.contractStartDate' | translate }}</label>
              <input
                type="text"
                dateInput
                id="newItemContractStartDate"
                [(ngModel)]="newItemContractStartDate"
                name="newItemContractStartDate"
              />
            </div>
            <div class="form-group">
              <label for="newItemContractEndDate">{{ 'procurement.contractEndDate' | translate }}</label>
              <input
                type="text"
                dateInput
                id="newItemContractEndDate"
                [(ngModel)]="newItemContractEndDate"
                name="newItemContractEndDate"
              />
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="cancelCreateItem()">{{ 'common.cancel' | translate }}</button>
            <button
              type="submit"
              class="btn btn-primary"
              [disabled]="isCreatingItem || !newItemName.trim()"
            >
              {{ isCreatingItem ? ('procurement.creating' | translate) : ('common.create' | translate) }}
            </button>
          </div>
        </form>
      </div>

      <!-- Items List -->
      <div class="items-list-container">
        <div class="loading" *ngIf="isLoadingItems">
          <span class="spinner"></span> {{ 'common.loading' | translate }}
        </div>

        <!-- Grouped View -->
        <div class="items-list grouped" *ngIf="!isLoadingItems && filteredProcurementItems.length > 0 && displayPreferences.groupByCategory">
          <ng-container *ngFor="let group of groupedProcurementItems; trackBy: trackByGroupName">
            <div class="category-group-header">
              <span class="category-group-name">{{ group.categoryName }}</span>
              <span class="category-group-count">({{ group.items.length }} {{ group.items.length === 1 ? ('common.item' | translate) : ('common.items' | translate) }})</span>
            </div>
            <div class="item-card" *ngFor="let item of group.items; trackBy: trackByItemId" 
                 [id]="'procurement-item-' + item.id"
                 [class.expanded]="selectedItem?.id === item.id">
              <ng-container *ngTemplateOutlet="procurementItemTemplate; context: { item: item }"></ng-container>
            </div>
          </ng-container>
        </div>

        <!-- Flat View -->
        <div class="items-list" *ngIf="!isLoadingItems && filteredProcurementItems.length > 0 && !displayPreferences.groupByCategory">
          <div class="item-card" *ngFor="let item of filteredProcurementItems; trackBy: trackByItemId" 
               [id]="'procurement-item-' + item.id"
               [class.expanded]="selectedItem?.id === item.id">
            <ng-container *ngTemplateOutlet="procurementItemTemplate; context: { item: item }"></ng-container>
          </div>
        </div>

        <!-- Procurement Item Template -->
        <ng-template #procurementItemTemplate let-item="item">
          <!-- Item Summary Row -->
          <div class="item-summary" (click)="toggleItemDetails(item)">
            <div class="item-info">
              <span class="item-pr">{{ item.purchaseRequisition }}</span>
              <span class="item-po" *ngIf="item.purchaseOrder">/ {{ item.purchaseOrder }}</span>
              <span class="item-name">{{ item.name }}</span>
              <span class="status-badge" [ngClass]="getTrackingStatusClass(item.trackingStatus)">
                {{ getTrackingStatusIcon(item.trackingStatus) }} {{ getTrackingStatusLabel(item.trackingStatus) }}
              </span>
              <span class="procurement-type-badge" [ngClass]="getProcurementTypeClass(item.procurementType)">
                {{ getProcurementTypeIcon(item.procurementType) }} {{ getProcurementTypeLabel(item.procurementType) }}
              </span>
              <span class="category-badge" *ngIf="item.categoryName && !displayPreferences.groupByCategory">üìÅ {{ getCategoryDisplayNameById(item.categoryId, item.categoryName) }}</span>
              <span class="quotes-count">üìã {{ item.quoteCount || 0 }}</span>
            </div>
            <div class="item-actions">
              <button
                class="btn-icon expand-btn"
                [title]="(selectedItem?.id === item.id ? 'common.collapse' : 'common.expand') | translate"
                (click)="toggleItemDetails(item); $event.stopPropagation()"
              >
                {{ selectedItem?.id === item.id ? '‚ñ≤' : '‚ñº' }}
              </button>
              <button
                class="btn-icon btn-edit"
                [title]="'common.edit' | translate"
                *ngIf="canWrite && editingItemId !== item.id"
                (click)="startEditProcurementItem(item); $event.stopPropagation()"
              >
                ‚úèÔ∏è
              </button>
              <button
                class="btn-icon btn-danger"
                [title]="'common.delete' | translate"
                *ngIf="canWrite"
                (click)="deleteProcurementItem(item); $event.stopPropagation()"
              >
                üóëÔ∏è
              </button>
              <!-- Linked spending indicator (only shown when linked, not a button) -->
              <span 
                class="linked-indicator"
                [title]="'procurement.linkedToSpending' | translate"
                *ngIf="item.linkedSpendingItemIds && item.linkedSpendingItemIds.length > 0"
              >
                üîó
              </span>
            </div>
          </div>

          <!-- Expanded Details Section -->
          <div class="item-details" *ngIf="selectedItem?.id === item.id">
              <div class="details-content">
                <!-- Item Info View Mode -->
                <div class="info-section" *ngIf="editingItemId !== item.id">
                  <div class="info-grid">
                    <div class="info-item">
                      <label>{{ 'procurement.purchaseRequisition' | translate }}</label>
                      <span>{{ item.purchaseRequisition }}</span>
                    </div>
                    <div class="info-item">
                      <label>{{ 'procurement.purchaseOrder' | translate }}</label>
                      <span>{{ item.purchaseOrder || '-' }}</span>
                    </div>
                    <div class="info-item">
                      <label>{{ 'procurement.procurementType' | translate }}</label>
                      <span class="procurement-type-badge" [ngClass]="getProcurementTypeClass(item.procurementType)">
                        {{ getProcurementTypeIcon(item.procurementType) }} {{ getProcurementTypeLabel(item.procurementType) }}
                      </span>
                    </div>
                    <div class="info-item">
                      <label>{{ 'procurement.trackingStatus' | translate }}</label>
                      <span class="status-badge" [ngClass]="getTrackingStatusClass(item.trackingStatus)">
                        {{ getTrackingStatusIcon(item.trackingStatus) }} {{ getTrackingStatusLabel(item.trackingStatus) }}
                      </span>
                    </div>
                    <div class="info-item" *ngIf="item.vendor">
                      <label>{{ 'procurement.vendor' | translate }}</label>
                      <span>{{ item.vendor }}</span>
                    </div>
                    <div class="info-item" *ngIf="item.quotedPrice">
                      <label>{{ 'procurement.quotedPrice' | translate }}</label>
                      <span class="quoted-price">
                        {{ item.quotedPrice | number:'1.2-2' }} {{ getCurrencyFlag(item.quotedPriceCurrency || 'CAD') }} {{ item.quotedPriceCurrency || 'CAD' }}
                      </span>
                      <span class="quoted-price-cad" *ngIf="item.quotedPriceCurrency !== 'CAD' && item.quotedPriceCad">
                        ({{ item.quotedPriceCad | number:'1.2-2' }} {{ getCurrencyFlag('CAD') }} CAD)
                      </span>
                    </div>
                    <div class="info-item" *ngIf="item.finalPrice">
                      <label>{{ 'procurement.finalPrice' | translate }}</label>
                      <span class="final-price">
                        {{ item.finalPrice | number:'1.2-2' }} {{ getCurrencyFlag(item.finalPriceCurrency || 'CAD') }} {{ item.finalPriceCurrency || 'CAD' }}
                      </span>
                      <span class="final-price-cad" *ngIf="item.finalPriceCurrency !== 'CAD' && item.finalPriceCad">
                        ({{ item.finalPriceCad | number:'1.2-2' }} {{ getCurrencyFlag('CAD') }} CAD)
                      </span>
                    </div>
                    <div class="info-item" *ngIf="item.contractNumber">
                      <label>{{ 'procurement.contractNumber' | translate }}</label>
                      <span>{{ item.contractNumber }}</span>
                    </div>
                    <div class="info-item" *ngIf="item.contractStartDate || item.contractEndDate">
                      <label>{{ 'procurement.contractPeriod' | translate }}</label>
                      <span>
                        {{ item.contractStartDate | date:'dd/MM/yyyy' }}
                        <ng-container *ngIf="item.contractStartDate && item.contractEndDate"> - </ng-container>
                        {{ item.contractEndDate | date:'dd/MM/yyyy' }}
                      </span>
                    </div>
                    <div class="info-item">
                      <label>{{ 'procurement.created' | translate }}</label>
                      <span>{{ item.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
                    </div>
                  </div>
                  <div class="description" *ngIf="item.description">
                    <label>{{ 'common.description' | translate }}</label>
                    <p>{{ item.description }}</p>
                  </div>
                  <!-- Linked Spending Items -->
                  <div class="linked-spending-section" *ngIf="item.linkedSpendingItemIds && item.linkedSpendingItemIds.length > 0">
                    <label>{{ 'procurement.linkedSpendingItems' | translate }}</label>
                    <div class="linked-items-list">
                      <div class="linked-item" *ngFor="let name of item.linkedSpendingItemNames; let i = index">
                        <span class="linked-item-icon">üí∞</span>
                        <span class="linked-item-name">{{ name }}</span>
                        <button 
                          class="btn-link" 
                          [title]="'procurement.viewInSpending' | translate"
                          (click)="viewLinkedSpendingItems()">
                          {{ 'common.view' | translate }} ‚Üí
                        </button>
                      </div>
                    </div>
                  </div>
                  <!-- Link to Spending button - shown in view mode -->
                  <div class="link-spending-action" *ngIf="canWrite && item.trackingStatus !== 'CANCELLED' && (!item.linkedSpendingItemIds || item.linkedSpendingItemIds.length === 0)">
                    <button
                      class="btn btn-spending-link"
                      [title]="'procurement.linkSpending' | translate"
                      [disabled]="isTogglingSpendingLink"
                      (click)="linkSpendingFromViewMode(item); $event.stopPropagation()"
                    >
                      {{ isTogglingSpendingLink ? '‚è≥' : '‚ûïüí∞ ' + ('procurement.linkSpending' | translate) }}
                    </button>
                  </div>
                </div>

                <!-- Edit Mode -->
                <div class="edit-form" *ngIf="editingItemId === item.id">
                  <div class="edit-form-header">
                    <h4>{{ 'procurement.editTitle' | translate }}</h4>
                    <!-- Delete Linked Spending button - shown only in edit mode when items are linked -->
                    <button
                      class="btn btn-spending-link btn-danger-outline"
                      [title]="'procurement.unlinkSpending' | translate"
                      *ngIf="canWrite && hasLinkedSpendingItems()"
                      [disabled]="isTogglingSpendingLink"
                      (click)="toggleSpendingLink(); $event.stopPropagation()"
                    >
                      {{ isTogglingSpendingLink ? '‚è≥' : 'üóëÔ∏è ' + ('procurement.unlinkSpending' | translate) }}
                    </button>
                  </div>
                  
                  <!-- Tracking Status Toggle -->
                  <div class="form-group">
                    <label>{{ 'procurement.trackingStatus' | translate }}</label>
                    <div class="tracking-status-toggle">
                      <button 
                        *ngFor="let ts of trackingStatusOptions"
                        type="button"
                        class="status-toggle-btn"
                        [class.active]="editItemTrackingStatus === ts"
                        [ngClass]="getTrackingStatusClass(ts)"
                        (click)="editItemTrackingStatus = ts"
                        [disabled]="isUpdatingItem"
                      >
                        {{ getTrackingStatusIcon(ts) }} {{ getTrackingStatusLabel(ts) }}
                      </button>
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label for="editItemPR">{{ 'procurement.pr' | translate }}</label>
                      <input
                        id="editItemPR"
                        type="text"
                        [(ngModel)]="editItemPR"
                        [placeholder]="'procurement.enterPrPlaceholder' | translate"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                    <div class="form-group">
                      <label for="editItemPO">{{ 'procurement.po' | translate }}</label>
                      <input
                        id="editItemPO"
                        type="text"
                        [(ngModel)]="editItemPO"
                        [placeholder]="'procurement.enterPoPlaceholder' | translate"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                    <div class="form-group">
                      <label for="editItemProcurementType">{{ 'procurement.procurementType' | translate }}</label>
                      <select id="editItemProcurementType" [(ngModel)]="editItemProcurementType" [disabled]="isUpdatingItem">
                        <option *ngFor="let pt of procurementTypeOptions" [value]="pt">
                          {{ getProcurementTypeIcon(pt) }} {{ getProcurementTypeLabel(pt) }}
                        </option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="editItemName">{{ 'common.name' | translate }} <span class="required">*</span></label>
                    <input
                      id="editItemName"
                      type="text"
                      [(ngModel)]="editItemName"
                      [placeholder]="'procurement.enterName' | translate"
                      [disabled]="isUpdatingItem"
                      required
                    />
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="editItemCategory">{{ 'common.category' | translate }}</label>
                      <select id="editItemCategory" [(ngModel)]="editItemCategoryId" [disabled]="isUpdatingItem">
                        <option [ngValue]="null">-- {{ 'procurement.noCategory' | translate }} --</option>
                        <option *ngFor="let category of categories" [ngValue]="category.id">
                          {{ getCategoryDisplayName(category) }}
                        </option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="editItemDescription">{{ 'common.description' | translate }}</label>
                    <textarea
                      id="editItemDescription"
                      [(ngModel)]="editItemDescription"
                      [placeholder]="'procurement.enterDescription' | translate"
                      [disabled]="isUpdatingItem"
                      rows="3"
                    ></textarea>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="editItemVendor">{{ 'procurement.vendor' | translate }}</label>
                      <input
                        id="editItemVendor"
                        type="text"
                        [(ngModel)]="editItemVendor"
                        [placeholder]="'procurement.vendorPlaceholder' | translate"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                    <div class="form-group">
                      <label for="editItemContractNumber">{{ 'procurement.contractNumber' | translate }}</label>
                      <input
                        id="editItemContractNumber"
                        type="text"
                        [(ngModel)]="editItemContractNumber"
                        [placeholder]="'procurement.contractPlaceholder' | translate"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                  </div>

                  <!-- Quoted/Estimated Price Fields -->
                  <div class="form-row">
                    <div class="form-group">
                      <label for="editItemQuotedPrice">{{ 'procurement.quotedPrice' | translate }}</label>
                      <input
                        id="editItemQuotedPrice"
                        type="text"
                        currencyInput
                        [(ngModel)]="editItemQuotedPrice"
                        (ngModelChange)="onEditQuotedPriceChange()"
                        [placeholder]="'procurement.quotedPricePlaceholder' | translate"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                    <div class="form-group">
                      <label for="editItemQuotedPriceCurrency">{{ 'procurement.quotedPriceCurrency' | translate }}</label>
                      <select id="editItemQuotedPriceCurrency" [(ngModel)]="editItemQuotedPriceCurrency" (ngModelChange)="onEditQuotedPriceChange()" [disabled]="isUpdatingItem">
                        <option *ngFor="let currency of currencies" [value]="currency.code">
                          {{ getCurrencyFlag(currency.code) }} {{ currency.code }} - {{ currency.name }}
                        </option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row" *ngIf="editItemQuotedPriceCurrency !== 'CAD'">
                    <div class="form-group">
                      <label for="editItemQuotedPriceExchangeRate">{{ 'procurement.quotedPriceExchangeRate' | translate }}</label>
                      <input
                        id="editItemQuotedPriceExchangeRate"
                        type="number"
                        [(ngModel)]="editItemQuotedPriceExchangeRate"
                        (ngModelChange)="onEditQuotedPriceChange()"
                        step="0.0001"
                        min="0"
                        [placeholder]="'procurement.exchangeRatePlaceholder' | translate"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                    <div class="form-group">
                      <label for="editItemQuotedPriceCad">{{ 'procurement.quotedPriceCad' | translate }}</label>
                      <input
                        id="editItemQuotedPriceCad"
                        type="text"
                        [value]="editItemQuotedPriceCad != null ? formatCurrency(editItemQuotedPriceCad, 'CAD') : ''"
                        readonly
                        class="computed-field"
                        [placeholder]="'procurement.cadEquivalent' | translate"
                      />
                    </div>
                  </div>

                  <!-- Final Price Fields -->
                  <div class="form-row">
                    <div class="form-group">
                      <label for="editItemFinalPrice">{{ 'procurement.finalPrice' | translate }}</label>
                      <input
                        id="editItemFinalPrice"
                        type="text"
                        currencyInput
                        [(ngModel)]="editItemFinalPrice"
                        (ngModelChange)="onEditFinalPriceChange()"
                        [placeholder]="'procurement.finalPricePlaceholder' | translate"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                    <div class="form-group">
                      <label for="editItemFinalPriceCurrency">{{ 'procurement.finalPriceCurrency' | translate }}</label>
                      <select id="editItemFinalPriceCurrency" [(ngModel)]="editItemFinalPriceCurrency" (ngModelChange)="onEditFinalPriceChange()" [disabled]="isUpdatingItem">
                        <option *ngFor="let currency of currencies" [value]="currency.code">
                          {{ getCurrencyFlag(currency.code) }} {{ currency.code }} - {{ currency.name }}
                        </option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row" *ngIf="editItemFinalPriceCurrency !== 'CAD'">
                    <div class="form-group">
                      <label for="editItemFinalPriceExchangeRate">{{ 'procurement.finalPriceExchangeRate' | translate }}</label>
                      <input
                        id="editItemFinalPriceExchangeRate"
                        type="number"
                        [(ngModel)]="editItemFinalPriceExchangeRate"
                        (ngModelChange)="onEditFinalPriceChange()"
                        step="0.0001"
                        min="0"
                        [placeholder]="'procurement.exchangeRatePlaceholder' | translate"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                    <div class="form-group">
                      <label for="editItemFinalPriceCad">{{ 'procurement.finalPriceCad' | translate }}</label>
                      <input
                        id="editItemFinalPriceCad"
                        type="text"
                        [value]="editItemFinalPriceCad != null ? formatCurrency(editItemFinalPriceCad, 'CAD') : ''"
                        readonly
                        class="computed-field"
                        [placeholder]="'procurement.cadEquivalent' | translate"
                      />
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group">
                      <label for="editItemContractStartDate">{{ 'procurement.contractStartDate' | translate }}</label>
                      <input
                        id="editItemContractStartDate"
                        type="text"
                        dateInput
                        [(ngModel)]="editItemContractStartDate"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                    <div class="form-group">
                      <label for="editItemContractEndDate">{{ 'procurement.contractEndDate' | translate }}</label>
                      <input
                        id="editItemContractEndDate"
                        type="text"
                        dateInput
                        [(ngModel)]="editItemContractEndDate"
                        [disabled]="isUpdatingItem"
                      />
                    </div>
                  </div>
                  <div class="form-actions">
                    <button 
                      type="button"
                      class="btn-secondary" 
                      (click)="cancelEditProcurementItem()"
                      [disabled]="isUpdatingItem"
                    >
                      {{ 'common.cancel' | translate }}
                    </button>
                    <button 
                      type="button"
                      class="btn-primary" 
                      (click)="updateProcurementItem()"
                      [disabled]="isUpdatingItem || !editItemName.trim() || !isEditFormDirty()"
                    >
                      <span *ngIf="isUpdatingItem">{{ 'procurement.updating' | translate }}</span>
                      <span *ngIf="!isUpdatingItem">{{ 'procurement.updateItem' | translate }}</span>
                    </button>
                  </div>
                </div>

                <!-- Quotes Section -->
                <div class="quotes-section">
                  <div class="section-header">
                    <h3>{{ 'procurement.quotes' | translate }} ({{ quotes.length }})</h3>
                    <button class="btn-primary" (click)="showCreateQuote()" *ngIf="canWrite && !showCreateQuoteForm">
                      ‚ûï {{ 'procurement.addQuote' | translate }}
                    </button>
                  </div>

                  <!-- Create Quote Form -->
                  <div class="create-form" *ngIf="showCreateQuoteForm">
                    <h4>{{ 'procurement.addNewQuote' | translate }}</h4>
                    <form (ngSubmit)="createQuote()">
                      <div class="form-row">
                        <div class="form-group">
                          <label for="newQuoteVendorName">{{ 'procurement.vendorName' | translate }} *</label>
                          <input
                            type="text"
                            id="newQuoteVendorName"
                            [(ngModel)]="newQuoteVendorName"
                            name="newQuoteVendorName"
                            required
                          />
                        </div>
                        <div class="form-group">
                          <label for="newQuoteVendorContact">{{ 'procurement.vendorContact' | translate }}</label>
                          <input
                            type="text"
                            id="newQuoteVendorContact"
                            [(ngModel)]="newQuoteVendorContact"
                            name="newQuoteVendorContact"
                          />
                        </div>
                      </div>
                      <div class="form-row">
                        <div class="form-group">
                          <label for="newQuoteReference">{{ 'procurement.quoteReference' | translate }}</label>
                          <input
                            type="text"
                            id="newQuoteReference"
                            [(ngModel)]="newQuoteReference"
                            name="newQuoteReference"
                          />
                        </div>
                        <div class="form-group">
                          <label for="newQuoteCurrency">{{ 'procurement.quoteCurrency' | translate }}</label>
                          <select id="newQuoteCurrency" [(ngModel)]="newQuoteCurrency" (ngModelChange)="onNewQuoteAmountChange()" name="newQuoteCurrency">
                            <option *ngFor="let currency of currencies" [value]="currency.code">
                              {{ getCurrencyFlag(currency.code) }} {{ currency.code }}
                            </option>
                          </select>
                        </div>
                      </div>
                      <!-- Quote Amount -->
                      <div class="form-row">
                        <div class="form-group">
                          <label for="newQuoteAmount">{{ 'procurement.quoteAmount' | translate }} ({{ newQuoteCurrency }})</label>
                          <input
                            type="text"
                            currencyInput
                            id="newQuoteAmount"
                            [(ngModel)]="newQuoteAmount"
                            (ngModelChange)="onNewQuoteAmountChange()"
                            name="newQuoteAmount"
                            [placeholder]="'procurement.quoteAmountPlaceholder' | translate"
                          />
                        </div>
                      </div>
                      <!-- Exchange Rate (only if currency is not CAD) -->
                      <div class="form-row" *ngIf="newQuoteCurrency !== 'CAD'">
                        <div class="form-group">
                          <label for="newQuoteExchangeRate">{{ 'procurement.quoteExchangeRate' | translate }}</label>
                          <input
                            type="number"
                            id="newQuoteExchangeRate"
                            [(ngModel)]="newQuoteExchangeRate"
                            (ngModelChange)="onNewQuoteAmountChange()"
                            name="newQuoteExchangeRate"
                            min="0"
                            step="0.000001"
                            [placeholder]="'procurement.quoteExchangeRatePlaceholder' | translate"
                          />
                        </div>
                      </div>
                      <!-- Computed Amount (CAD) -->
                      <div class="form-row" *ngIf="newQuoteCurrency !== 'CAD' && newQuoteAmountCad !== null">
                        <div class="form-group computed-field">
                          <label>{{ 'procurement.quoteAmountCad' | translate }}</label>
                          <input type="text" [value]="formatCurrency(newQuoteAmountCad!, 'CAD')" readonly />
                        </div>
                      </div>
                      <div class="form-row">
                        <div class="form-group">
                          <label for="newQuoteReceivedDate">{{ 'procurement.receivedDate' | translate }}</label>
                          <input
                            type="text"
                            dateInput
                            id="newQuoteReceivedDate"
                            [(ngModel)]="newQuoteReceivedDate"
                            name="newQuoteReceivedDate"
                          />
                        </div>
                        <div class="form-group">
                          <label for="newQuoteExpiryDate">{{ 'procurement.expiryDate' | translate }}</label>
                          <input
                            type="text"
                            dateInput
                            id="newQuoteExpiryDate"
                            [(ngModel)]="newQuoteExpiryDate"
                            name="newQuoteExpiryDate"
                          />
                        </div>
                      </div>
                      <div class="form-group">
                        <label for="newQuoteNotes">{{ 'procurement.notes' | translate }}</label>
                        <textarea
                          id="newQuoteNotes"
                          [(ngModel)]="newQuoteNotes"
                          name="newQuoteNotes"
                          rows="2"
                        ></textarea>
                      </div>
                      <!-- Attach File Section -->
                      <div class="form-group file-attach-section">
                        <label for="newQuoteFile">{{ 'procurement.attachFile' | translate }}</label>
                        <div class="file-input-wrapper">
                          <input
                            type="file"
                            id="newQuoteFile"
                            (change)="onQuoteFileSelected($event)"
                            accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.xls,.xlsx,.txt,.csv"
                          />
                          <span class="file-hint">{{ 'procurement.fileHint' | translate }}</span>
                        </div>
                        <div *ngIf="newQuoteFile" class="selected-file-info">
                          <span class="file-icon">üìé</span>
                          <span class="file-name">{{ newQuoteFile.name }}</span>
                          <span class="file-size">({{ formatFileSize(newQuoteFile.size) }})</span>
                          <button type="button" class="btn-remove-file" (click)="removeQuoteFile()">‚úï</button>
                        </div>
                        <div class="form-group file-description" *ngIf="newQuoteFile">
                          <label for="newQuoteFileDescription">{{ 'procurement.fileDescription' | translate }}</label>
                          <input
                            type="text"
                            id="newQuoteFileDescription"
                            [(ngModel)]="newQuoteFileDescription"
                            name="newQuoteFileDescription"
                            [placeholder]="'procurement.fileDescriptionPlaceholder' | translate"
                          />
                        </div>
                      </div>
                      <div class="form-actions">
                        <button type="button" class="btn-secondary" (click)="cancelCreateQuote()">{{ 'common.cancel' | translate }}</button>
                        <button
                          type="submit"
                          class="btn-primary"
                          [disabled]="isCreatingQuote || !newQuoteVendorName.trim()"
                        >
                          {{ isCreatingQuote ? ('procurement.adding' | translate) : ('procurement.addQuote' | translate) }}
                        </button>
                      </div>
                    </form>
                  </div>

                  <!-- Quotes List -->
                  <div class="quotes-list">
                    <div class="loading" *ngIf="isLoadingQuotes">
                      <span class="spinner"></span> {{ 'procurement.loadingQuotes' | translate }}
                    </div>

                    <div class="quote-card" *ngFor="let quote of quotes" [class.selected]="quote.selected" [class.editing]="editingQuoteId === quote.id">
                      <!-- Edit Quote Form (shown when editing this quote) -->
                      <div class="edit-quote-form" *ngIf="editingQuoteId === quote.id">
                        <h4>{{ 'procurement.editQuote' | translate }}</h4>
                        <form (ngSubmit)="updateQuote()">
                          <div class="form-row">
                            <div class="form-group">
                              <label for="editQuoteVendorName">{{ 'procurement.vendorName' | translate }} *</label>
                              <input
                                type="text"
                                id="editQuoteVendorName"
                                [(ngModel)]="editQuoteVendorName"
                                name="editQuoteVendorName"
                                required
                              />
                            </div>
                            <div class="form-group">
                              <label for="editQuoteVendorContact">{{ 'procurement.vendorContact' | translate }}</label>
                              <input
                                type="text"
                                id="editQuoteVendorContact"
                                [(ngModel)]="editQuoteVendorContact"
                                name="editQuoteVendorContact"
                              />
                            </div>
                          </div>
                          <div class="form-row">
                            <div class="form-group">
                              <label for="editQuoteReference">{{ 'procurement.quoteReference' | translate }}</label>
                              <input
                                type="text"
                                id="editQuoteReference"
                                [(ngModel)]="editQuoteReference"
                                name="editQuoteReference"
                              />
                            </div>
                            <div class="form-group">
                              <label for="editQuoteCurrency">{{ 'procurement.quoteCurrency' | translate }}</label>
                              <select id="editQuoteCurrency" [(ngModel)]="editQuoteCurrency" (ngModelChange)="onEditQuoteAmountChange()" name="editQuoteCurrency">
                                <option *ngFor="let currency of currencies" [value]="currency.code">
                                  {{ getCurrencyFlag(currency.code) }} {{ currency.code }}
                                </option>
                              </select>
                            </div>
                          </div>
                          <!-- Quote Amount -->
                          <div class="form-row">
                            <div class="form-group">
                              <label for="editQuoteAmount">{{ 'procurement.quoteAmount' | translate }} ({{ editQuoteCurrency }})</label>
                              <input
                                type="text"
                                currencyInput
                                id="editQuoteAmount"
                                [(ngModel)]="editQuoteAmount"
                                (ngModelChange)="onEditQuoteAmountChange()"
                                name="editQuoteAmount"
                              />
                            </div>
                          </div>
                          <!-- Exchange Rate (only if currency is not CAD) -->
                          <div class="form-row" *ngIf="editQuoteCurrency !== 'CAD'">
                            <div class="form-group">
                              <label for="editQuoteExchangeRate">{{ 'procurement.quoteExchangeRate' | translate }}</label>
                              <input
                                type="number"
                                id="editQuoteExchangeRate"
                                [(ngModel)]="editQuoteExchangeRate"
                                (ngModelChange)="onEditQuoteAmountChange()"
                                name="editQuoteExchangeRate"
                                min="0"
                                step="0.000001"
                              />
                            </div>
                          </div>
                          <!-- Computed Amount (CAD) -->
                          <div class="form-row" *ngIf="editQuoteCurrency !== 'CAD' && editQuoteAmountCad !== null">
                            <div class="form-group computed-field">
                              <label>{{ 'procurement.quoteAmountCad' | translate }}</label>
                              <input type="text" [value]="formatCurrency(editQuoteAmountCad!, 'CAD')" readonly />
                            </div>
                          </div>
                          <div class="form-row">
                            <div class="form-group">
                              <label for="editQuoteReceivedDate">{{ 'procurement.receivedDate' | translate }}</label>
                              <input
                                type="text"
                                dateInput
                                id="editQuoteReceivedDate"
                                [(ngModel)]="editQuoteReceivedDate"
                                name="editQuoteReceivedDate"
                              />
                            </div>
                            <div class="form-group">
                              <label for="editQuoteExpiryDate">{{ 'procurement.expiryDate' | translate }}</label>
                              <input
                                type="text"
                                dateInput
                                id="editQuoteExpiryDate"
                                [(ngModel)]="editQuoteExpiryDate"
                                name="editQuoteExpiryDate"
                              />
                            </div>
                          </div>
                          <div class="form-group">
                            <label for="editQuoteNotes">{{ 'procurement.notes' | translate }}</label>
                            <textarea
                              id="editQuoteNotes"
                              [(ngModel)]="editQuoteNotes"
                              name="editQuoteNotes"
                              rows="2"
                            ></textarea>
                          </div>
                          <div class="form-actions">
                            <button type="button" class="btn-secondary" (click)="cancelEditQuote()">{{ 'common.cancel' | translate }}</button>
                            <button
                              type="submit"
                              class="btn-primary"
                              [disabled]="isUpdatingQuote || !editQuoteVendorName.trim()"
                            >
                              {{ isUpdatingQuote ? ('common.saving' | translate) : ('common.save' | translate) }}
                            </button>
                          </div>
                        </form>
                      </div>

                      <!-- Quote Display (shown when not editing) -->
                      <ng-container *ngIf="editingQuoteId !== quote.id">
                        <div class="quote-header">
                          <div class="vendor-info">
                            <span class="vendor-name">{{ quote.vendorName }}</span>
                            <span class="quote-ref" *ngIf="quote.quoteReference">#{{ quote.quoteReference }}</span>
                          </div>
                        </div>
                        <div class="quote-body">
                          <div class="quote-amount" *ngIf="quote.amount !== null && quote.amount !== undefined">
                            <span class="currency-flag">{{ getCurrencyFlag(quote.currency) }}</span>
                            {{ formatCurrency(quote.amount, quote.currency) }}
                            <span class="quote-amount-cad" *ngIf="quote.currency !== 'CAD' && getQuoteAmountCad(quote) !== null">
                              ({{ formatCurrency(getQuoteAmountCad(quote)!, 'CAD') }})
                            </span>
                          </div>
                          <div class="quote-dates">
                            <span *ngIf="quote.receivedDate">{{ 'procurement.received' | translate }}: {{ quote.receivedDate | date:'dd/MM/yyyy' }}</span>
                            <span *ngIf="quote.expiryDate">{{ 'procurement.expires' | translate }}: {{ quote.expiryDate | date:'dd/MM/yyyy' }}</span>
                          </div>
                          <p class="quote-notes" *ngIf="quote.notes">{{ quote.notes }}</p>
                          <!-- Quote user info -->
                          <div class="quote-meta">
                            <span class="created-by" *ngIf="quote.modifiedBy || quote.createdBy">
                              {{ 'procurement.by' | translate }}: {{ quote.modifiedBy || quote.createdBy }}
                            </span>
                            <span class="modified-at" *ngIf="quote.updatedAt">{{ quote.updatedAt | date:'dd/MM/yyyy HH:mm' }}</span>
                          </div>
                        </div>
                        <div class="quote-actions">
                          <button class="btn-icon" [title]="'procurement.viewFiles' | translate" (click)="viewQuoteFiles(quote)">
                            üìÅ {{ 'procurement.files' | translate }} ({{ quote.fileCount || 0 }})
                          </button>
                          <button
                            class="btn-icon btn-edit"
                            [title]="'common.edit' | translate"
                            *ngIf="canWrite"
                            (click)="startEditQuote(quote)"
                          >
                            ‚úèÔ∏è
                          </button>
                          <button
                            class="btn-icon btn-danger"
                            [title]="'common.delete' | translate"
                            *ngIf="canWrite"
                            (click)="deleteQuote(quote)"
                          >
                            üóëÔ∏è
                          </button>
                        </div>
                        <div class="selected-badge" *ngIf="quote.selected">
                          ‚úì {{ 'procurement.selectedQuote' | translate }}
                        </div>
                      </ng-container>
                    </div>

                    <div class="empty-state" *ngIf="!isLoadingQuotes && quotes.length === 0">
                      <p>{{ 'procurement.noQuotes' | translate }}</p>
                      <p *ngIf="canWrite">{{ 'procurement.clickAddQuote' | translate }}</p>
                    </div>
                  </div>
                </div>

                <!-- Procurement Events/Tracking Section -->
                <div class="events-section">
                  <div class="section-header">
                    <h3>üìã {{ 'procurement.tracking' | translate }} ({{ events.length }})</h3>
                    <div class="section-actions">
                      <button 
                        class="btn-toggle" 
                        (click)="toggleEventsPanel()"
                        [class.active]="showEventsPanel">
                        {{ showEventsPanel ? ('procurement.hide' | translate) + ' ‚ñº' : ('procurement.show' | translate) + ' ‚ñ∂' }}
                      </button>
                      <button 
                        class="btn-primary" 
                        (click)="showCreateEvent(); showEventsPanel = true" 
                        *ngIf="canWrite && !showCreateEventForm">
                        ‚ûï {{ 'procurement.addEvent' | translate }}
                      </button>
                    </div>
                  </div>

                  <!-- Collapsed View - Show only the most recent event -->
                  <div class="events-collapsed" *ngIf="!showEventsPanel && mostRecentEvent">
                    <div class="event-item collapsed-event" [ngClass]="getEventTypeClass(mostRecentEvent.eventType)">
                      <div class="event-icon">{{ getEventTypeIcon(mostRecentEvent.eventType) }}</div>
                      <div class="event-content">
                        <div class="event-header">
                          <span class="event-type">{{ getEventTypeLabel(mostRecentEvent.eventType) }}</span>
                          <span class="event-date">{{ mostRecentEvent.eventDate | date:'dd/MM/yyyy' }}</span>
                          <span class="status-badge small" *ngIf="mostRecentEvent.newStatus" [ngClass]="getEventStatusClass(mostRecentEvent.newStatus)">
                            {{ getEventStatusLabel(mostRecentEvent.newStatus) }}
                          </span>
                        </div>
                        <p class="event-comment" *ngIf="mostRecentEvent.comment">{{ mostRecentEvent.comment }}</p>
                      </div>
                    </div>
                  </div>
                  <div class="events-collapsed empty" *ngIf="!showEventsPanel && !mostRecentEvent && !isLoadingEvents">
                    <p class="no-events-message">{{ 'procurement.noEvents' | translate }}</p>
                  </div>

                  <div class="events-content" *ngIf="showEventsPanel">
                    <!-- Create/Edit Event Form -->
                    <div class="create-form event-form" *ngIf="showCreateEventForm">
                      <h4>{{ editingEvent ? ('procurement.editEvent' | translate) : ('procurement.addNewEvent' | translate) }}</h4>
                      <form (ngSubmit)="editingEvent ? updateEvent() : createEvent()">
                        <div class="form-row">
                          <div class="form-group">
                            <label for="newEventType">{{ 'procurement.eventType' | translate }} *</label>
                            <select 
                              id="newEventType" 
                              [(ngModel)]="newEventType" 
                              name="newEventType"
                              required>
                              <option *ngFor="let type of eventTypeOptions" [value]="type">
                                {{ getEventTypeIcon(type) }} {{ getEventTypeLabel(type) }}
                              </option>
                            </select>
                          </div>
                          <div class="form-group">
                            <label for="newEventDate">{{ 'common.date' | translate }} *</label>
                            <input
                              type="text"
                              dateInput
                              id="newEventDate"
                              [(ngModel)]="newEventDate"
                              name="newEventDate"
                              required
                            />
                          </div>
                        </div>
                        <div class="form-group">
                          <label for="newEventComment">{{ 'procurement.commentNotes' | translate }}</label>
                          <textarea
                            id="newEventComment"
                            [(ngModel)]="newEventComment"
                            name="newEventComment"
                            rows="2"
                            [placeholder]="'procurement.optionalComment' | translate"
                          ></textarea>
                        </div>
                        <!-- File Attachment (optional) - only for new events, not editing -->
                        <div class="form-group" *ngIf="!editingEvent">
                          <label>{{ 'procurement.attachFiles' | translate }}</label>
                          <div class="file-upload-section">
                            <input 
                              type="file" 
                              (change)="onNewEventFileSelected($event)"
                              accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.xls,.xlsx,.txt,.csv"
                              [disabled]="isCreatingEvent"
                              multiple
                            />
                            <div class="selected-files-list" *ngIf="newEventFiles.length > 0">
                              <div class="selected-file" *ngFor="let file of newEventFiles; let i = index">
                                <span class="file-name">üìé {{ file.name }}</span>
                                <span class="file-size">({{ formatFileSize(file.size) }})</span>
                                <button type="button" class="btn-icon btn-small" (click)="removeNewEventFile(i)" [title]="'common.remove' | translate">‚úï</button>
                              </div>
                            </div>
                            <div class="form-group" *ngIf="newEventFiles.length > 0">
                              <label for="newEventFileDescription">{{ 'procurement.fileDescription' | translate }}</label>
                              <input 
                                type="text" 
                                id="newEventFileDescription"
                                [(ngModel)]="newEventFileDescription"
                                name="newEventFileDescription"
                                [placeholder]="'procurement.optionalDescription' | translate"
                                [disabled]="isCreatingEvent"
                              />
                            </div>
                          </div>
                        </div>
                        <div class="form-actions">
                          <button type="button" class="btn-secondary" (click)="cancelEventForm()">{{ 'common.cancel' | translate }}</button>
                          <button
                            type="submit"
                            class="btn-primary"
                            [disabled]="isCreatingEvent || !newEventDate">
                            {{ isCreatingEvent ? (editingEvent ? ('procurement.updating' | translate) : ('procurement.adding' | translate)) : (editingEvent ? ('common.edit' | translate) : ('procurement.addEvent' | translate)) }}
                          </button>
                        </div>
                      </form>
                    </div>

                    <!-- Events Timeline -->
                    <div class="events-timeline">
                      <div class="loading" *ngIf="isLoadingEvents">
                        <span class="spinner"></span> {{ 'procurement.loadingEvents' | translate }}
                      </div>

                      <div class="event-item" 
                           *ngFor="let event of events" 
                           [ngClass]="getEventTypeClass(event.eventType)">
                        <div class="event-icon">{{ getEventTypeIcon(event.eventType) }}</div>
                        <div class="event-content">
                          <div class="event-header">
                            <span class="event-type">{{ getEventTypeLabel(event.eventType) }}</span>
                            <span class="event-date">{{ event.eventDate | date:'dd/MM/yyyy' }}</span>
                            <span class="status-badge small" *ngIf="event.newStatus" [ngClass]="getEventStatusClass(event.newStatus)">
                              {{ getEventStatusLabel(event.newStatus) }}
                            </span>
                          </div>
                          <p class="event-comment" *ngIf="event.comment">{{ event.comment }}</p>
                          <div class="event-meta">
                            <span class="created-by" *ngIf="event.createdBy">{{ 'procurement.by' | translate }}: {{ event.createdBy }}</span>
                            <span class="created-at" *ngIf="event.createdAt">{{ event.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
                          </div>

                          <!-- Event Files Section -->
                          <div class="event-files-section">
                            <div class="event-files-header">
                              <button class="btn-link files-toggle" (click)="toggleEventFiles(event)">
                                <span class="toggle-icon">{{ expandedEventFiles[event.id] ? '‚ñº' : '‚ñ∂' }}</span>
                                üìé {{ 'procurement.files' | translate }} 
                                <span class="file-count" *ngIf="event.fileCount || eventFiles[event.id]?.length">
                                  ({{ eventFiles[event.id]?.length || event.fileCount || 0 }})
                                </span>
                              </button>
                              <button class="btn-small btn-secondary" *ngIf="canWrite && !(event.fileCount || eventFiles[event.id]?.length)" (click)="showEventFileUpload(event)" 
                                      [title]="'procurement.uploadFile' | translate">
                                üì§ {{ 'procurement.uploadFile' | translate }}
                              </button>
                            </div>

                            <!-- File Upload Form (inline) -->
                            <div class="event-file-upload-form" *ngIf="showEventFileUploadForm && selectedEventForUpload?.id === event.id">
                              <div class="form-group">
                                <label>{{ 'procurement.selectFiles' | translate }}</label>
                                <input type="file" (change)="onEventFileSelected($event)" 
                                       accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.xls,.xlsx,.txt,.csv"
                                       [disabled]="isUploadingEventFile"
                                       multiple />
                              </div>
                              <!-- Selected files preview -->
                              <div class="selected-files-list" *ngIf="selectedEventFiles.length > 0">
                                <div class="selected-file" *ngFor="let file of selectedEventFiles; let i = index">
                                  <span class="file-name">üìé {{ file.name }}</span>
                                  <span class="file-size">({{ formatFileSize(file.size) }})</span>
                                  <button type="button" class="btn-icon btn-small" (click)="removeSelectedEventFile(i)" [title]="'common.remove' | translate">‚úï</button>
                                </div>
                              </div>
                              <div class="form-group">
                                <label>{{ 'procurement.fileDescription' | translate }}</label>
                                <input type="text" [(ngModel)]="eventFileDescription" 
                                       [placeholder]="'procurement.optionalDescription' | translate"
                                       [disabled]="isUploadingEventFile" />
                              </div>
                              <div class="form-actions">
                                <button class="btn-secondary btn-small" (click)="cancelEventFileUpload()" 
                                        [disabled]="isUploadingEventFile">
                                  {{ 'common.cancel' | translate }}
                                </button>
                                <button class="btn-primary btn-small" (click)="uploadEventFile()" 
                                        [disabled]="selectedEventFiles.length === 0 || isUploadingEventFile">
                                  {{ isUploadingEventFile ? ('procurement.uploading' | translate) : ('procurement.upload' | translate) }}
                                </button>
                              </div>
                            </div>

                            <!-- Files List -->
                            <div class="event-files-list" *ngIf="expandedEventFiles[event.id]">
                              <div class="loading" *ngIf="isLoadingEventFiles[event.id]">
                                <span class="spinner small"></span> {{ 'procurement.loadingFiles' | translate }}
                              </div>

                              <div class="file-item" *ngFor="let file of eventFiles[event.id]">
                                <!-- Edit Description Mode -->
                                <ng-container *ngIf="editingEventFile?.id === file.id; else fileDisplay">
                                  <div class="file-edit-form">
                                    <span class="file-icon">{{ getFileIcon(file.contentType) }}</span>
                                    <span class="file-name">{{ file.fileName }}</span>
                                    <input type="text" [(ngModel)]="editingEventFileDescription" 
                                           class="description-input"
                                           [placeholder]="'procurement.fileDescription' | translate" />
                                    <div class="file-edit-actions">
                                      <button class="btn-icon" [title]="'common.save' | translate" 
                                              (click)="saveEventFileDescription(event)">‚úîÔ∏è</button>
                                      <button class="btn-icon" [title]="'common.cancel' | translate" 
                                              (click)="cancelEditEventFileDescription()">‚ùå</button>
                                    </div>
                                  </div>
                                </ng-container>

                                <!-- Normal File Display -->
                                <ng-template #fileDisplay>
                                  <span class="file-icon">{{ getFileIcon(file.contentType) }}</span>
                                  <div class="file-info">
                                    <span class="file-name">{{ file.fileName }}</span>
                                    <span class="file-size">({{ file.formattedFileSize }})</span>
                                    <span class="file-description" *ngIf="file.description">- {{ file.description }}</span>
                                  </div>
                                  <div class="file-actions">
                                    <button class="btn-icon" [title]="'procurement.preview' | translate" (click)="previewEventFile(event, file)" *ngIf="isPreviewable(file.contentType)">üëÅÔ∏è</button>
                                    <button class="btn-icon" [title]="'procurement.openInNewTab' | translate" (click)="viewEventFile(event, file)">üîó</button>
                                    <button class="btn-icon" [title]="'common.download' | translate" 
                                            (click)="downloadEventFile(event, file)">‚¨áÔ∏è</button>
                                    <label class="btn-icon btn-replace" *ngIf="canWrite" [title]="'procurement.replaceFile' | translate">
                                      üîÑ
                                      <input type="file" (change)="replaceEventFile($event, event, file)" style="display: none"
                                             accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.xls,.xlsx,.txt,.csv" />
                                    </label>
                                    <button class="btn-icon" *ngIf="canWrite" [title]="'common.edit' | translate" 
                                            (click)="editEventFileDescription(file)">‚úèÔ∏è</button>
                                    <button class="btn-icon btn-danger" *ngIf="canWrite" [title]="'common.delete' | translate" 
                                            (click)="deleteEventFile(event, file)">üóëÔ∏è</button>
                                  </div>
                                </ng-template>
                              </div>

                              <div class="no-files" *ngIf="!isLoadingEventFiles[event.id] && (!eventFiles[event.id] || eventFiles[event.id].length === 0)">
                                {{ 'procurement.noFilesAttached' | translate }}
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="event-actions" *ngIf="canWrite">
                          <button class="btn-icon" [title]="'common.edit' | translate" (click)="editEvent(event)">‚úèÔ∏è</button>
                          <button class="btn-icon btn-danger" [title]="'common.delete' | translate" (click)="deleteEvent(event)">üóëÔ∏è</button>
                        </div>
                      </div>

                      <div class="empty-state" *ngIf="!isLoadingEvents && events.length === 0">
                        <p>{{ 'procurement.noEvents' | translate }}</p>
                        <p *ngIf="canWrite">{{ 'procurement.clickAddEvent' | translate }}</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
        </ng-template>

        <!-- Add Button - After Items List -->
        <div class="action-bar bottom" *ngIf="canWrite && !showCreateItemForm && procurementItems.length > 0">
          <button class="btn btn-primary" (click)="showCreateItem()">
            + {{ 'procurement.addItem' | translate }}
          </button>
        </div>

        <!-- Empty State - No items match filter -->
        <div class="empty-state" *ngIf="!isLoadingItems && procurementItems.length > 0 && filteredProcurementItems.length === 0">
          <div class="empty-icon">üîç</div>
          <h3>{{ 'procurement.noMatchingItems' | translate }}</h3>
          <p>{{ 'procurement.noMatchingItemsDesc' | translate }}</p>
          <button class="btn-secondary" (click)="clearSearch(); selectedCategoryId = null">
            {{ 'procurement.clearFilters' | translate }}
          </button>
        </div>

        <!-- Empty State - No items exist -->
        <div class="empty-state" *ngIf="!isLoadingItems && procurementItems.length === 0">
          <div class="empty-icon">üõí</div>
          <h3>{{ 'procurement.noItems' | translate }}</h3>
          <p>{{ 'procurement.createFirst' | translate }}</p>
          <button class="btn btn-primary" (click)="showCreateItem()" *ngIf="canWrite">
            {{ 'procurement.createFirstItem' | translate }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Files Modal -->
  <div class="modal-overlay" *ngIf="selectedQuote" (click)="closeQuoteFiles()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ 'procurement.filesForQuote' | translate }}: {{ selectedQuote.vendorName }}</h3>
        <button class="btn-close" (click)="closeQuoteFiles()">‚úï</button>
      </div>
      <div class="modal-body">
        <!-- Upload Form -->
        <div class="upload-section" *ngIf="canWrite">
          <button class="btn-primary" (click)="showFileUploadForm()" *ngIf="!showFileUpload">
            üìé {{ 'procurement.uploadFile' | translate }}
          </button>

          <div class="upload-form" *ngIf="showFileUpload">
            <div class="form-group">
              <label for="fileInput">{{ 'procurement.selectFiles' | translate }}</label>
              <input
                type="file"
                id="fileInput"
                (change)="onFileSelected($event)"
                accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.xls,.xlsx,.txt,.csv"
                multiple
              />
            </div>
            <!-- Selected files preview -->
            <div class="selected-files-list" *ngIf="selectedFiles.length > 0">
              <div class="selected-file-item" *ngFor="let file of selectedFiles; let i = index">
                <span class="file-icon">üìé</span>
                <span class="file-name">{{ file.name }}</span>
                <span class="file-size">({{ formatFileSize(file.size) }})</span>
                <button type="button" class="btn-icon btn-small" (click)="removeSelectedFile(i)" [title]="'common.remove' | translate">‚úï</button>
              </div>
            </div>
            <div class="form-group">
              <label for="fileDescription">{{ 'procurement.descriptionOptional' | translate }}</label>
              <input
                type="text"
                id="fileDescription"
                [(ngModel)]="fileDescription"
                [placeholder]="'procurement.fileDescriptionPlaceholder' | translate"
              />
            </div>
            <div class="form-actions">
              <button type="button" class="btn-secondary" (click)="cancelFileUpload()">{{ 'common.cancel' | translate }}</button>
              <button
                type="button"
                class="btn-primary"
                [disabled]="isUploadingFile || selectedFiles.length === 0"
                (click)="uploadFile()"
              >
                {{ isUploadingFile ? ('common.uploading' | translate) : ('common.upload' | translate) }}
              </button>
            </div>
          </div>
        </div>

        <!-- Files List -->
        <div class="files-list">
          <div class="loading" *ngIf="isLoadingFiles">
            <span class="spinner"></span> {{ 'procurement.loadingFiles' | translate }}
          </div>

          <div class="file-item" *ngFor="let file of files" [class.replacing]="replacingFileId === file.id">
            <!-- Replace File Form (shown when replacing this file) -->
            <div class="replace-file-form" *ngIf="replacingFileId === file.id">
              <h5>{{ 'procurement.replaceFile' | translate }}: {{ file.fileName }}</h5>
              <div class="form-group">
                <label for="replacementFile">{{ 'procurement.selectNewFile' | translate }}</label>
                <input
                  type="file"
                  id="replacementFile"
                  (change)="onReplacementFileSelected($event)"
                  accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.xls,.xlsx,.txt,.csv"
                />
              </div>
              <div *ngIf="replacementFile" class="selected-file-info">
                <span class="file-icon">üìé</span>
                <span class="file-name">{{ replacementFile.name }}</span>
                <span class="file-size">({{ formatFileSize(replacementFile.size) }})</span>
              </div>
              <div class="form-group" *ngIf="replacementFile">
                <label for="replacementFileDescription">{{ 'procurement.fileDescription' | translate }}</label>
                <input
                  type="text"
                  id="replacementFileDescription"
                  [(ngModel)]="replacementFileDescription"
                  [placeholder]="'procurement.fileDescriptionPlaceholder' | translate"
                />
              </div>
              <div class="form-actions">
                <button type="button" class="btn-secondary" (click)="cancelReplaceFile()">{{ 'common.cancel' | translate }}</button>
                <button
                  type="button"
                  class="btn-primary"
                  [disabled]="isReplacingFile || !replacementFile"
                  (click)="replaceFile()"
                >
                  {{ isReplacingFile ? ('procurement.replacing' | translate) : ('procurement.replace' | translate) }}
                </button>
              </div>
            </div>

            <!-- File Display (shown when not replacing) -->
            <ng-container *ngIf="replacingFileId !== file.id">
              <span class="file-icon">{{ getFileIcon(file.contentType) }}</span>
              <div class="file-info">
                <span class="file-name">{{ file.fileName }}</span>
                <span class="file-meta">{{ file.fileSize | number }} {{ 'procurement.bytes' | translate }}</span>
                <span class="file-desc" *ngIf="file.description">{{ file.description }}</span>
              </div>
              <div class="file-actions">
                <button class="btn-icon" [title]="'procurement.preview' | translate" (click)="previewFile(file)" *ngIf="isPreviewable(file.contentType)">üëÅÔ∏è</button>
                <button class="btn-icon" [title]="'procurement.openInNewTab' | translate" (click)="viewFile(file)">üîó</button>
                <button class="btn-icon" [title]="'common.download' | translate" (click)="downloadFile(file)">‚¨áÔ∏è</button>
                <button
                  class="btn-icon btn-replace"
                  [title]="'procurement.replaceFile' | translate"
                  *ngIf="canWrite"
                  (click)="startReplaceFile(file)"
                >
                  üîÑ
                </button>
                <button
                  class="btn-icon btn-danger"
                  [title]="'common.delete' | translate"
                  *ngIf="canWrite"
                  (click)="deleteFile(file)"
                >
                  üóëÔ∏è
                </button>
              </div>
            </ng-container>
          </div>

          <div class="empty-state" *ngIf="!isLoadingFiles && files.length === 0">
            <p>{{ 'procurement.noFilesUploaded' | translate }}</p>
            <p *ngIf="canWrite">{{ 'procurement.clickUploadFile' | translate }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- File Preview Modal -->
  <div class="preview-overlay" *ngIf="previewingFile" (click)="closePreview()">
    <div class="preview-modal" (click)="$event.stopPropagation()">
      <div class="preview-header">
        <h3>{{ previewingFile.fileName }}</h3>
        <div class="preview-actions">
          <button class="btn-icon" [title]="'procurement.openInNewTab' | translate"
            (click)="previewingEventContext ? viewEventFile(previewingEventContext.event, $any(previewingFile)) : viewFile($any(previewingFile))">üîó</button>
          <button class="btn-icon" [title]="'common.download' | translate"
            (click)="previewingEventContext ? downloadEventFile(previewingEventContext.event, $any(previewingFile)) : downloadFile($any(previewingFile))">‚¨áÔ∏è</button>
          <button class="btn-close" (click)="closePreview()">‚úï</button>
        </div>
      </div>
      <div class="preview-content">
        <div class="loading" *ngIf="isLoadingPreview">
          <span class="spinner"></span> {{ 'procurement.loadingPreview' | translate }}
        </div>
        <iframe 
          *ngIf="!isLoadingPreview && previewUrl && previewingFile.contentType === 'application/pdf'" 
          [src]="previewUrl" 
          class="pdf-preview"
          [title]="'procurement.pdfPreview' | translate">
        </iframe>
        <img 
          *ngIf="!isLoadingPreview && previewUrl && previewingFile.contentType.startsWith('image/')" 
          [src]="previewUrl" 
          class="image-preview"
          [alt]="'procurement.imagePreview' | translate"
        />
        <div class="text-preview" *ngIf="!isLoadingPreview && previewUrl && previewingFile.contentType.startsWith('text/')">
          <pre>{{ previewTextContent }}</pre>
        </div>
      </div>
    </div>
  </div>

  <!-- Spending Link Unlink Warning Modal -->
  <div class="modal-overlay" *ngIf="showSpendingLinkWarning" (click)="cancelUnlinkSpending()">
    <div class="modal confirm-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>‚ö†Ô∏è {{ 'procurement.spendingLinkWarningTitle' | translate }}</h3>
        <button class="close-btn" (click)="cancelUnlinkSpending()">‚úï</button>
      </div>
      <div class="modal-body">
        <p>{{ spendingLinkWarningMessage || ('procurement.spendingLinkWarningDefault' | translate) }}</p>
        <p class="warning-note">{{ 'procurement.spendingLinkWarningNote' | translate }}</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="cancelUnlinkSpending()">
          {{ 'common.cancel' | translate }}
        </button>
        <button class="btn btn-danger" (click)="confirmUnlinkSpending()">
          {{ 'procurement.confirmUnlink' | translate }}
        </button>
      </div>
    </div>
  </div>
</div>
