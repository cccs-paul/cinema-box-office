<!--
  myRC - Procurement Component Template
  Copyright (c) 2026 myRC Team
  Licensed under MIT License
-->
<div class="procurement-container">
  <!-- Header -->
  <div class="page-header">
    <h1>Procurement Management</h1>
    <p class="subtitle" *ngIf="selectedRC && selectedFY">
      {{ selectedRC.name }} - {{ selectedFY.name }}
    </p>
  </div>

  <!-- Messages -->
  <div class="messages" *ngIf="errorMessage || successMessage">
    <div class="alert alert-error" *ngIf="errorMessage">
      <span>‚ùå</span> {{ errorMessage }}
    </div>
    <div class="alert alert-success" *ngIf="successMessage">
      <span>‚úÖ</span> {{ successMessage }}
    </div>
  </div>

  <!-- Main Content -->
  <div class="content-wrapper">
    <!-- Left Panel: Procurement Items List -->
    <div class="items-panel" [class.collapsed]="selectedItem">
      <!-- Search and Filter Bar -->
      <div class="toolbar">
        <div class="search-box">
          <input
            type="text"
            [(ngModel)]="searchTerm"
            (keyup.enter)="onSearch()"
            placeholder="Search by PR, PO, or name..."
            class="search-input"
          />
          <button class="btn-search" (click)="onSearch()">üîç</button>
        </div>
        <div class="filter-dropdown">
          <select [(ngModel)]="selectedStatusFilter" (change)="filterByStatus(selectedStatusFilter)">
            <option [ngValue]="null">All Statuses</option>
            <option *ngFor="let status of statusOptions" [ngValue]="status">
              {{ getStatusLabel(status) }}
            </option>
          </select>
        </div>
        <button class="btn-primary" (click)="showCreateItem()" *ngIf="canWrite">
          ‚ûï New Procurement
        </button>
      </div>

      <!-- Create Item Form -->
      <div class="create-form" *ngIf="showCreateItemForm">
        <h3>Create Procurement Item</h3>
        <form (ngSubmit)="createProcurementItem()">
          <div class="form-row">
            <div class="form-group">
              <label for="newItemPR">Purchase Requisition (PR) *</label>
              <input
                type="text"
                id="newItemPR"
                [(ngModel)]="newItemPR"
                name="newItemPR"
                required
                placeholder="e.g., PR-2026-001"
              />
            </div>
            <div class="form-group">
              <label for="newItemPO">Purchase Order (PO)</label>
              <input
                type="text"
                id="newItemPO"
                [(ngModel)]="newItemPO"
                name="newItemPO"
                placeholder="e.g., PO-2026-001"
              />
            </div>
          </div>
          <div class="form-group">
            <label for="newItemName">Name *</label>
            <input
              type="text"
              id="newItemName"
              [(ngModel)]="newItemName"
              name="newItemName"
              required
              placeholder="Brief name for this procurement"
            />
          </div>
          <div class="form-group">
            <label for="newItemDescription">Description</label>
            <textarea
              id="newItemDescription"
              [(ngModel)]="newItemDescription"
              name="newItemDescription"
              placeholder="Detailed description..."
              rows="3"
            ></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="newItemCurrency">Currency</label>
              <select id="newItemCurrency" [(ngModel)]="newItemCurrency" name="newItemCurrency">
                <option *ngFor="let currency of currencies" [value]="currency.code">
                  {{ getCurrencyFlag(currency.code) }} {{ currency.code }} - {{ currency.name }}
                </option>
              </select>
            </div>
            <div class="form-group" *ngIf="newItemCurrency !== 'CAD'">
              <label for="newItemExchangeRate">Exchange Rate to CAD</label>
              <input
                type="number"
                id="newItemExchangeRate"
                [(ngModel)]="newItemExchangeRate"
                name="newItemExchangeRate"
                step="0.0001"
                min="0"
                placeholder="e.g., 1.35"
              />
            </div>
          </div>
          
          <!-- Contract & Vendor Fields -->
          <div class="form-row">
            <div class="form-group">
              <label for="newItemPreferredVendor">Preferred Vendor</label>
              <input
                type="text"
                id="newItemPreferredVendor"
                [(ngModel)]="newItemPreferredVendor"
                name="newItemPreferredVendor"
                placeholder="e.g., Acme Corp"
              />
            </div>
            <div class="form-group">
              <label for="newItemContractNumber">Contract Number</label>
              <input
                type="text"
                id="newItemContractNumber"
                [(ngModel)]="newItemContractNumber"
                name="newItemContractNumber"
                placeholder="e.g., CON-2026-001"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="newItemContractStartDate">Contract Start Date</label>
              <input
                type="date"
                id="newItemContractStartDate"
                [(ngModel)]="newItemContractStartDate"
                name="newItemContractStartDate"
              />
            </div>
            <div class="form-group">
              <label for="newItemContractEndDate">Contract End Date</label>
              <input
                type="date"
                id="newItemContractEndDate"
                [(ngModel)]="newItemContractEndDate"
                name="newItemContractEndDate"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group form-checkbox">
              <input
                type="checkbox"
                id="newItemProcurementCompleted"
                [(ngModel)]="newItemProcurementCompleted"
                name="newItemProcurementCompleted"
              />
              <label for="newItemProcurementCompleted">Procurement Completed</label>
            </div>
            <div class="form-group" *ngIf="newItemProcurementCompleted">
              <label for="newItemProcurementCompletedDate">Completion Date</label>
              <input
                type="date"
                id="newItemProcurementCompletedDate"
                [(ngModel)]="newItemProcurementCompletedDate"
                name="newItemProcurementCompletedDate"
              />
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-secondary" (click)="cancelCreateItem()">Cancel</button>
            <button
              type="submit"
              class="btn-primary"
              [disabled]="isCreatingItem || !newItemPR.trim() || !newItemName.trim()"
            >
              {{ isCreatingItem ? 'Creating...' : 'Create' }}
            </button>
          </div>
        </form>
      </div>

      <!-- Items Table -->
      <div class="items-table-container">
        <div class="loading" *ngIf="isLoadingItems">
          <span class="spinner"></span> Loading...
        </div>

        <table class="items-table" *ngIf="!isLoadingItems && procurementItems.length > 0">
          <thead>
            <tr>
              <th>PR</th>
              <th>PO</th>
              <th>Name</th>
              <th>Currency</th>
              <th>Status</th>
              <th>Quotes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr
              *ngFor="let item of procurementItems"
              [class.selected]="selectedItem?.id === item.id"
              (click)="viewItemDetails(item)"
            >
              <td class="pr-cell">{{ item.purchaseRequisition }}</td>
              <td class="po-cell">{{ item.purchaseOrder || '-' }}</td>
              <td class="name-cell">{{ item.name }}</td>
              <td class="currency-cell">
                <span class="currency-badge" [class.foreign-currency]="item.currency !== 'CAD'">
                  {{ getCurrencyFlag(item.currency) }} {{ item.currency }}
                </span>
                <span class="exchange-rate" *ngIf="item.currency !== 'CAD' && item.exchangeRate">
                  ({{ item.exchangeRate }} CAD)
                </span>
              </td>
              <td class="status-cell">
                <span class="status-badge" [ngClass]="getStatusClass(item.status)">
                  {{ getStatusLabel(item.status) }}
                </span>
              </td>
              <td class="quotes-cell">{{ item.quoteCount || 0 }}</td>
              <td class="actions-cell">
                <button class="btn-icon" title="View Details" (click)="viewItemDetails(item); $event.stopPropagation()">
                  üëÅÔ∏è
                </button>
                <button
                  class="btn-icon btn-danger"
                  title="Delete"
                  *ngIf="canWrite"
                  (click)="deleteProcurementItem(item); $event.stopPropagation()"
                >
                  üóëÔ∏è
                </button>
              </td>
            </tr>
          </tbody>
        </table>

        <div class="empty-state" *ngIf="!isLoadingItems && procurementItems.length === 0">
          <p>No procurement items found.</p>
          <p *ngIf="canWrite">Click "New Procurement" to create one.</p>
        </div>
      </div>
    </div>

    <!-- Right Panel: Item Details -->
    <div class="details-panel" *ngIf="selectedItem">
      <div class="details-header">
        <h2>{{ selectedItem.name }}</h2>
        <button class="btn-close" (click)="closeItemDetails()">‚úï</button>
      </div>

      <div class="details-content">
        <!-- Item Info -->
        <div class="info-section">
          <div class="info-grid">
            <div class="info-item">
              <label>Purchase Requisition (PR)</label>
              <span>{{ selectedItem.purchaseRequisition }}</span>
            </div>
            <div class="info-item">
              <label>Purchase Order (PO)</label>
              <span>{{ selectedItem.purchaseOrder || '-' }}</span>
            </div>
            <div class="info-item">
              <label>Currency</label>
              <span class="currency-badge" [class.foreign-currency]="selectedItem.currency !== 'CAD'">
                {{ getCurrencyFlag(selectedItem.currency) }} {{ selectedItem.currency }}
              </span>
              <span class="exchange-rate" *ngIf="selectedItem.currency !== 'CAD' && selectedItem.exchangeRate">
                (1 {{ selectedItem.currency }} = {{ selectedItem.exchangeRate }} CAD)
              </span>
            </div>
            <div class="info-item">
              <label>Status</label>
              <span class="status-badge" [ngClass]="getStatusClass(selectedItem.status)">
                {{ getStatusLabel(selectedItem.status) }}
              </span>
            </div>
            <div class="info-item" *ngIf="selectedItem.preferredVendor">
              <label>Preferred Vendor</label>
              <span>{{ selectedItem.preferredVendor }}</span>
            </div>
            <div class="info-item" *ngIf="selectedItem.contractNumber">
              <label>Contract Number</label>
              <span>{{ selectedItem.contractNumber }}</span>
            </div>
            <div class="info-item" *ngIf="selectedItem.contractStartDate || selectedItem.contractEndDate">
              <label>Contract Period</label>
              <span>
                {{ selectedItem.contractStartDate | date:'mediumDate' }}
                <ng-container *ngIf="selectedItem.contractStartDate && selectedItem.contractEndDate"> - </ng-container>
                {{ selectedItem.contractEndDate | date:'mediumDate' }}
              </span>
            </div>
            <div class="info-item">
              <label>Procurement Completed</label>
              <span class="completion-badge" [class.completed]="selectedItem.procurementCompleted">
                {{ selectedItem.procurementCompleted ? '‚úÖ Yes' : '‚è≥ No' }}
              </span>
              <span *ngIf="selectedItem.procurementCompleted && selectedItem.procurementCompletedDate" class="completion-date">
                ({{ selectedItem.procurementCompletedDate | date:'mediumDate' }})
              </span>
            </div>
            <div class="info-item">
              <label>Created</label>
              <span>{{ selectedItem.createdAt | date:'medium' }}</span>
            </div>
          </div>
          <div class="description" *ngIf="selectedItem.description">
            <label>Description</label>
            <p>{{ selectedItem.description }}</p>
          </div>
        </div>

        <!-- Quotes Section -->
        <div class="quotes-section">
          <div class="section-header">
            <h3>Quotes ({{ quotes.length }})</h3>
            <button class="btn-primary btn-sm" (click)="showCreateQuote()" *ngIf="canWrite && !showCreateQuoteForm">
              ‚ûï Add Quote
            </button>
          </div>

          <!-- Create Quote Form -->
          <div class="create-form" *ngIf="showCreateQuoteForm">
            <h4>Add New Quote</h4>
            <form (ngSubmit)="createQuote()">
              <div class="form-row">
                <div class="form-group">
                  <label for="newQuoteVendorName">Vendor Name *</label>
                  <input
                    type="text"
                    id="newQuoteVendorName"
                    [(ngModel)]="newQuoteVendorName"
                    name="newQuoteVendorName"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="newQuoteVendorContact">Vendor Contact</label>
                  <input
                    type="text"
                    id="newQuoteVendorContact"
                    [(ngModel)]="newQuoteVendorContact"
                    name="newQuoteVendorContact"
                  />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="newQuoteReference">Quote Reference</label>
                  <input
                    type="text"
                    id="newQuoteReference"
                    [(ngModel)]="newQuoteReference"
                    name="newQuoteReference"
                  />
                </div>
                <div class="form-group">
                  <label for="newQuoteAmount">Amount</label>
                  <div class="amount-input">
                    <select [(ngModel)]="newQuoteCurrency" name="newQuoteCurrency">
                      <option *ngFor="let currency of currencies" [value]="currency.code">
                        {{ getCurrencyFlag(currency.code) }} {{ currency.code }}
                      </option>
                    </select>
                    <input
                      type="number"
                      id="newQuoteAmount"
                      [(ngModel)]="newQuoteAmount"
                      name="newQuoteAmount"
                      min="0"
                      step="0.01"
                    />
                  </div>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="newQuoteReceivedDate">Received Date</label>
                  <input
                    type="date"
                    id="newQuoteReceivedDate"
                    [(ngModel)]="newQuoteReceivedDate"
                    name="newQuoteReceivedDate"
                  />
                </div>
                <div class="form-group">
                  <label for="newQuoteExpiryDate">Expiry Date</label>
                  <input
                    type="date"
                    id="newQuoteExpiryDate"
                    [(ngModel)]="newQuoteExpiryDate"
                    name="newQuoteExpiryDate"
                  />
                </div>
              </div>
              <div class="form-group">
                <label for="newQuoteNotes">Notes</label>
                <textarea
                  id="newQuoteNotes"
                  [(ngModel)]="newQuoteNotes"
                  name="newQuoteNotes"
                  rows="2"
                ></textarea>
              </div>
              <!-- Attach File Section -->
              <div class="form-group file-attach-section">
                <label for="newQuoteFile">Attach File (Optional)</label>
                <div class="file-input-wrapper">
                  <input
                    type="file"
                    id="newQuoteFile"
                    (change)="onQuoteFileSelected($event)"
                    accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.xls,.xlsx,.txt,.csv"
                  />
                  <span class="file-hint">PDF, images, documents up to 10MB</span>
                </div>
                <div *ngIf="newQuoteFile" class="selected-file-info">
                  <span class="file-icon">üìé</span>
                  <span class="file-name">{{ newQuoteFile.name }}</span>
                  <span class="file-size">({{ formatFileSize(newQuoteFile.size) }})</span>
                  <button type="button" class="btn-remove-file" (click)="removeQuoteFile()">‚úï</button>
                </div>
                <div class="form-group file-description" *ngIf="newQuoteFile">
                  <label for="newQuoteFileDescription">File Description</label>
                  <input
                    type="text"
                    id="newQuoteFileDescription"
                    [(ngModel)]="newQuoteFileDescription"
                    name="newQuoteFileDescription"
                    placeholder="Brief description of the attached file"
                  />
                </div>
              </div>
              <div class="form-actions">
                <button type="button" class="btn-secondary" (click)="cancelCreateQuote()">Cancel</button>
                <button
                  type="submit"
                  class="btn-primary"
                  [disabled]="isCreatingQuote || !newQuoteVendorName.trim()"
                >
                  {{ isCreatingQuote ? 'Adding...' : 'Add Quote' }}
                </button>
              </div>
            </form>
          </div>

          <!-- Quotes List -->
          <div class="quotes-list">
            <div class="loading" *ngIf="isLoadingQuotes">
              <span class="spinner"></span> Loading quotes...
            </div>

            <div class="quote-card" *ngFor="let quote of quotes" [class.selected]="quote.selected">
              <div class="quote-header">
                <div class="vendor-info">
                  <span class="vendor-name">{{ quote.vendorName }}</span>
                  <span class="quote-ref" *ngIf="quote.quoteReference">#{{ quote.quoteReference }}</span>
                </div>
                <span class="status-badge" [ngClass]="getQuoteStatusClass(quote.status)">
                  {{ getQuoteStatusLabel(quote.status) }}
                </span>
              </div>
              <div class="quote-body">
                <div class="quote-amount" *ngIf="quote.amount !== null && quote.amount !== undefined">
                  <span class="currency-flag">{{ getCurrencyFlag(quote.currency) }}</span>
                  {{ formatCurrency(quote.amount, quote.currency) }}
                </div>
                <div class="quote-dates">
                  <span *ngIf="quote.receivedDate">Received: {{ quote.receivedDate | date:'shortDate' }}</span>
                  <span *ngIf="quote.expiryDate">Expires: {{ quote.expiryDate | date:'shortDate' }}</span>
                </div>
                <p class="quote-notes" *ngIf="quote.notes">{{ quote.notes }}</p>
              </div>
              <div class="quote-actions">
                <button class="btn-icon" title="View Files" (click)="viewQuoteFiles(quote)">
                  üìÅ Files ({{ quote.fileCount || 0 }})
                </button>
                <button
                  class="btn-icon btn-select"
                  title="Select Quote (Coming Soon)"
                  *ngIf="canWrite && !quote.selected && quote.status !== 'REJECTED'"
                  disabled
                  [class.disabled]="true"
                >
                  ‚úÖ Select
                </button>
                <button
                  class="btn-icon btn-danger"
                  title="Delete"
                  *ngIf="canWrite"
                  (click)="deleteQuote(quote)"
                >
                  üóëÔ∏è
                </button>
              </div>
              <div class="selected-badge" *ngIf="quote.selected">
                ‚úì Selected Quote
              </div>
            </div>

            <div class="empty-state" *ngIf="!isLoadingQuotes && quotes.length === 0">
              <p>No quotes added yet.</p>
              <p *ngIf="canWrite">Click "Add Quote" to add one.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Files Modal -->
    <div class="modal-overlay" *ngIf="selectedQuote" (click)="closeQuoteFiles()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Files for Quote: {{ selectedQuote.vendorName }}</h3>
          <button class="btn-close" (click)="closeQuoteFiles()">‚úï</button>
        </div>
        <div class="modal-body">
          <!-- Upload Form -->
          <div class="upload-section" *ngIf="canWrite">
            <button class="btn-primary btn-sm" (click)="showFileUploadForm()" *ngIf="!showFileUpload">
              üìé Upload File
            </button>

            <div class="upload-form" *ngIf="showFileUpload">
              <div class="form-group">
                <label for="fileInput">Select File</label>
                <input
                  type="file"
                  id="fileInput"
                  (change)="onFileSelected($event)"
                  accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.xls,.xlsx,.txt,.csv"
                />
              </div>
              <div class="form-group">
                <label for="fileDescription">Description (optional)</label>
                <input
                  type="text"
                  id="fileDescription"
                  [(ngModel)]="fileDescription"
                  placeholder="Brief description of the file"
                />
              </div>
              <div class="form-actions">
                <button type="button" class="btn-secondary" (click)="cancelFileUpload()">Cancel</button>
                <button
                  type="button"
                  class="btn-primary"
                  [disabled]="isUploadingFile || !selectedFile"
                  (click)="uploadFile()"
                >
                  {{ isUploadingFile ? 'Uploading...' : 'Upload' }}
                </button>
              </div>
            </div>
          </div>

          <!-- Files List -->
          <div class="files-list">
            <div class="loading" *ngIf="isLoadingFiles">
              <span class="spinner"></span> Loading files...
            </div>

            <div class="file-item" *ngFor="let file of files">
              <span class="file-icon">{{ getFileIcon(file.contentType) }}</span>
              <div class="file-info">
                <span class="file-name">{{ file.fileName }}</span>
                <span class="file-meta">{{ file.fileSize | number }} bytes</span>
                <span class="file-desc" *ngIf="file.description">{{ file.description }}</span>
              </div>
              <div class="file-actions">
                <button class="btn-icon" title="Preview" (click)="previewFile(file)" *ngIf="isPreviewable(file.contentType)">üëÅÔ∏è</button>
                <button class="btn-icon" title="Open in New Tab" (click)="viewFile(file)">üîó</button>
                <button class="btn-icon" title="Download" (click)="downloadFile(file)">‚¨áÔ∏è</button>
                <button
                  class="btn-icon btn-danger"
                  title="Delete"
                  *ngIf="canWrite"
                  (click)="deleteFile(file)"
                >
                  üóëÔ∏è
                </button>
              </div>
            </div>

            <div class="empty-state" *ngIf="!isLoadingFiles && files.length === 0">
              <p>No files uploaded.</p>
              <p *ngIf="canWrite">Click "Upload File" to add one.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- File Preview Modal -->
    <div class="preview-overlay" *ngIf="previewingFile" (click)="closePreview()">
      <div class="preview-modal" (click)="$event.stopPropagation()">
        <div class="preview-header">
          <h3>{{ previewingFile.fileName }}</h3>
          <div class="preview-actions">
            <button class="btn-icon" title="Open in New Tab" (click)="viewFile(previewingFile)">üîó</button>
            <button class="btn-icon" title="Download" (click)="downloadFile(previewingFile)">‚¨áÔ∏è</button>
            <button class="btn-close" (click)="closePreview()">‚úï</button>
          </div>
        </div>
        <div class="preview-content">
          <div class="loading" *ngIf="isLoadingPreview">
            <span class="spinner"></span> Loading preview...
          </div>
          <iframe 
            *ngIf="!isLoadingPreview && previewUrl && previewingFile.contentType === 'application/pdf'" 
            [src]="previewUrl" 
            class="pdf-preview"
            title="PDF Preview">
          </iframe>
          <img 
            *ngIf="!isLoadingPreview && previewUrl && previewingFile.contentType.startsWith('image/')" 
            [src]="previewUrl" 
            class="image-preview"
            alt="Image Preview"
          />
          <div class="text-preview" *ngIf="!isLoadingPreview && previewUrl && previewingFile.contentType.startsWith('text/')">
            <pre>{{ previewTextContent }}</pre>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
