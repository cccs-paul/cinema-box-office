<!--
  myRC - RC Permissions Component Template
  Copyright (c) 2026 myRC Team
  Licensed under MIT License
-->
<div class="permissions-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-left">
      <button class="btn-back" (click)="goBack()">
        <span class="back-icon">â†</span> {{ 'rcPermissions.backToRcSelection' | translate }}
      </button>
      <h1>ğŸ” {{ 'rcPermissions.title' | translate }}</h1>
      <p class="subtitle" *ngIf="rc">{{ rc.name }}</p>
    </div>
  </div>

  <!-- Messages -->
  <div class="alert alert-error" *ngIf="errorMessage">
    <span>âŒ</span> {{ errorMessage }}
  </div>
  <div class="alert alert-success" *ngIf="successMessage">
    <span>âœ…</span> {{ successMessage }}
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>{{ 'rcPermissions.loadingPermissions' | translate }}</p>
  </div>

  <!-- Main Content -->
  <div class="content" *ngIf="!isLoading && rc?.isOwner">
    <!-- Access Level Legend -->
    <div class="legend-card">
      <h3>{{ 'rcPermissions.accessLevels' | translate }}</h3>
      <div class="legend-items">
        <div class="legend-item">
          <span class="legend-icon">ğŸ‘‘</span>
          <div class="legend-info">
            <strong>{{ 'rcPermissions.owner' | translate }}</strong>
            <p>{{ 'rcPermissions.ownerDesc' | translate }}</p>
          </div>
        </div>
        <div class="legend-item">
          <span class="legend-icon">âœï¸</span>
          <div class="legend-info">
            <strong>{{ 'rcPermissions.readWrite' | translate }}</strong>
            <p>{{ 'rcPermissions.readWriteDesc' | translate }}</p>
          </div>
        </div>
        <div class="legend-item">
          <span class="legend-icon">ğŸ‘ï¸</span>
          <div class="legend-info">
            <strong>{{ 'rcPermissions.readOnly' | translate }}</strong>
            <p>{{ 'rcPermissions.readOnlyDesc' | translate }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Grant Access Section -->
    <div class="grant-section">
      <h2>{{ 'rcPermissions.grantAccess' | translate }}</h2>
      <div class="grant-buttons">
        <button class="btn-grant" (click)="openGrantForm('USER')">
          <span>ğŸ‘¤</span> {{ 'rcPermissions.addUser' | translate }}
        </button>
        <button class="btn-grant" (click)="openGrantForm('GROUP')">
          <span>ğŸ‘¥</span> {{ 'rcPermissions.addSecurityGroup' | translate }}
        </button>
        <button class="btn-grant" (click)="openGrantForm('DISTRIBUTION_LIST')">
          <span>ğŸ“§</span> {{ 'rcPermissions.addDistributionList' | translate }}
        </button>
      </div>

      <!-- Grant Form Modal -->
      <div class="modal-overlay" *ngIf="showGrantForm" (click)="closeGrantForm()">
        <div class="modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h3>{{ getPrincipalTypeIcon(grantFormType) }} {{ getFormTypeLabelTranslated() }}</h3>
            <button class="btn-close" (click)="closeGrantForm()">Ã—</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label *ngIf="grantFormType === 'USER'">{{ 'rcPermissions.username' | translate }}</label>
              <label *ngIf="grantFormType === 'GROUP'">{{ 'rcPermissions.groupIdentifier' | translate }}</label>
              <label *ngIf="grantFormType === 'DISTRIBUTION_LIST'">{{ 'rcPermissions.distributionList' | translate }}</label>
              <input 
                type="text" 
                [(ngModel)]="newPrincipalIdentifier" 
                [placeholder]="getIdentifierPlaceholderTranslated()"
                class="form-input"
              />
            </div>
            <div class="form-group" *ngIf="grantFormType !== 'USER'">
              <label>{{ 'rcPermissions.displayNameOptional' | translate }}</label>
              <input 
                type="text" 
                [(ngModel)]="newPrincipalDisplayName" 
                [placeholder]="'rcPermissions.displayNamePlaceholder' | translate"
                class="form-input"
              />
            </div>
            <div class="form-group">
              <label>{{ 'rcPermissions.accessLevel' | translate }}</label>
              <select [(ngModel)]="newAccessLevel" class="form-select">
                <option value="OWNER">ğŸ‘‘ {{ 'rcPermissions.owner' | translate }}</option>
                <option value="READ_WRITE">âœï¸ {{ 'rcPermissions.readWrite' | translate }}</option>
                <option value="READ_ONLY">ğŸ‘ï¸ {{ 'rcPermissions.readOnly' | translate }}</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn-cancel" (click)="closeGrantForm()">{{ 'common.cancel' | translate }}</button>
            <button 
              class="btn-primary" 
              (click)="grantAccess()" 
              [disabled]="isGranting || !newPrincipalIdentifier.trim()"
            >
              <span *ngIf="isGranting">{{ 'rcPermissions.granting' | translate }}</span>
              <span *ngIf="!isGranting">{{ 'rcPermissions.grantAccess' | translate }}</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Current Permissions Table -->
    <div class="permissions-table-section">
      <h2>{{ 'rcPermissions.currentPermissions' | translate }}</h2>
      <div class="table-wrapper" *ngIf="permissions.length > 0">
        <table class="permissions-table">
          <thead>
            <tr>
              <th>{{ 'rcPermissions.tableType' | translate }}</th>
              <th>{{ 'rcPermissions.tablePrincipal' | translate }}</th>
              <th>{{ 'rcPermissions.tableAccessLevel' | translate }}</th>
              <th>{{ 'rcPermissions.tableGranted' | translate }}</th>
              <th>{{ 'rcPermissions.tableActions' | translate }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let permission of permissions" 
                [class.editing]="editingPermissionId === permission.id"
                [class.original-owner]="!permission.id">
              <td class="type-cell">
                <span class="type-icon">{{ getPrincipalTypeIcon(permission.principalType) }}</span>
                <span class="type-label">{{ getPrincipalTypeLabelTranslated(permission.principalType) }}</span>
              </td>
              <td class="principal-cell">
                <div class="principal-info">
                  <span class="principal-name">{{ permission.principalDisplayName || permission.principalIdentifier }}</span>
                  <span class="principal-id" *ngIf="permission.principalDisplayName && permission.principalDisplayName !== permission.principalIdentifier">
                    {{ permission.principalIdentifier }}
                  </span>
                </div>
              </td>
              <td class="access-cell">
                <!-- Normal view -->
                <span *ngIf="editingPermissionId !== permission.id" class="access-badge" [class]="'level-' + permission.accessLevel.toLowerCase()">
                  {{ getAccessLevelIcon(permission.accessLevel) }} {{ getAccessLevelLabelTranslated(permission.accessLevel) }}
                </span>
                <!-- Edit view -->
                <select 
                  *ngIf="editingPermissionId === permission.id" 
                  [(ngModel)]="editAccessLevel" 
                  class="form-select inline"
                >
                  <option value="OWNER">ğŸ‘‘ {{ 'rcPermissions.owner' | translate }}</option>
                  <option value="READ_WRITE">âœï¸ {{ 'rcPermissions.readWrite' | translate }}</option>
                  <option value="READ_ONLY">ğŸ‘ï¸ {{ 'rcPermissions.readOnly' | translate }}</option>
                </select>
              </td>
              <td class="granted-cell">
                <div class="granted-info">
                  <span class="granted-date">{{ permission.grantedAt | date:'mediumDate' }}</span>
                  <span class="granted-by" *ngIf="permission.grantedBy">{{ 'rcPermissions.by' | translate }} {{ permission.grantedBy }}</span>
                  <span class="granted-by" *ngIf="!permission.grantedBy && !permission.id">{{ 'rcPermissions.originalOwner' | translate }}</span>
                </div>
              </td>
              <td class="actions-cell">
                <!-- Normal actions -->
                <div *ngIf="editingPermissionId !== permission.id && canEditPermission(permission)" class="action-buttons">
                  <button class="btn-action btn-edit" (click)="startEdit(permission)" [title]="'common.edit' | translate">
                    âœï¸
                  </button>
                  <button class="btn-action btn-delete" (click)="confirmDelete(permission)" [title]="'rcPermissions.revokeAccess' | translate">
                    ğŸ—‘ï¸
                  </button>
                </div>
                <!-- Edit actions -->
                <div *ngIf="editingPermissionId === permission.id" class="action-buttons">
                  <button class="btn-action btn-save" (click)="saveEdit()" [title]="'common.save' | translate">
                    âœ…
                  </button>
                  <button class="btn-action btn-cancel-edit" (click)="cancelEdit()" [title]="'common.cancel' | translate">
                    âŒ
                  </button>
                </div>
                <!-- Original owner badge -->
                <span *ngIf="!canEditPermission(permission)" class="original-badge">
                  {{ 'rcPermissions.originalOwner' | translate }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="empty-state" *ngIf="permissions.length === 0">
        <p>{{ 'rcPermissions.noPermissions' | translate }}</p>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" *ngIf="deleteConfirmId" (click)="cancelDelete()">
    <div class="modal modal-danger" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>âš ï¸ {{ 'rcPermissions.confirmRevokeAccess' | translate }}</h3>
        <button class="btn-close" (click)="cancelDelete()">Ã—</button>
      </div>
      <div class="modal-body">
        <p>{{ 'rcPermissions.revokeConfirmMessage' | translate }}</p>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="cancelDelete()">{{ 'common.cancel' | translate }}</button>
        <button class="btn-danger" (click)="deletePermission()">{{ 'rcPermissions.revokeAccess' | translate }}</button>
      </div>
    </div>
  </div>

  <!-- Not Owner Message -->
  <div class="not-owner-message" *ngIf="!isLoading && rc && !rc.isOwner">
    <div class="message-icon">ğŸ”’</div>
    <h2>{{ 'rcPermissions.accessDenied' | translate }}</h2>
    <p>{{ 'rcPermissions.accessDeniedMessage' | translate }}</p>
    <button class="btn-primary" (click)="goBack()">{{ 'rcPermissions.returnToRcSelection' | translate }}</button>
  </div>
</div>
