<!--
  myRC - RC Permissions Component Template
  Copyright (c) 2026 myRC Team
  Licensed under MIT License
-->
<div class="permissions-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-left">
      <button class="btn-back" (click)="goBack()">
        <span class="back-icon">â†</span> Back to RC Selection
      </button>
      <h1>ğŸ” RC Permissions</h1>
      <p class="subtitle" *ngIf="rc">{{ rc.name }}</p>
    </div>
  </div>

  <!-- Messages -->
  <div class="alert alert-error" *ngIf="errorMessage">
    <span>âŒ</span> {{ errorMessage }}
  </div>
  <div class="alert alert-success" *ngIf="successMessage">
    <span>âœ…</span> {{ successMessage }}
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Loading permissions...</p>
  </div>

  <!-- Main Content -->
  <div class="content" *ngIf="!isLoading && rc?.isOwner">
    <!-- Access Level Legend -->
    <div class="legend-card">
      <h3>Access Levels</h3>
      <div class="legend-items">
        <div class="legend-item">
          <span class="legend-icon">ğŸ‘‘</span>
          <div class="legend-info">
            <strong>Owner</strong>
            <p>Can grant/revoke access, rename, delete RC, create FYs, and manage Money Types & Categories</p>
          </div>
        </div>
        <div class="legend-item">
          <span class="legend-icon">âœï¸</span>
          <div class="legend-info">
            <strong>Read/Write</strong>
            <p>Can create and edit Funding, Spending, Procurement items and quotes</p>
          </div>
        </div>
        <div class="legend-item">
          <span class="legend-icon">ğŸ‘ï¸</span>
          <div class="legend-info">
            <strong>Read Only</strong>
            <p>Can view all data but cannot make any changes</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Grant Access Section -->
    <div class="grant-section">
      <h2>Grant Access</h2>
      <div class="grant-buttons">
        <button class="btn-grant" (click)="openGrantForm('USER')">
          <span>ğŸ‘¤</span> Add User
        </button>
        <button class="btn-grant" (click)="openGrantForm('GROUP')">
          <span>ğŸ‘¥</span> Add Security Group
        </button>
        <button class="btn-grant" (click)="openGrantForm('DISTRIBUTION_LIST')">
          <span>ğŸ“§</span> Add Distribution List
        </button>
      </div>

      <!-- Grant Form Modal -->
      <div class="modal-overlay" *ngIf="showGrantForm" (click)="closeGrantForm()">
        <div class="modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h3>{{ getPrincipalTypeIcon(grantFormType) }} Grant {{ getFormTypeLabel() }} Access</h3>
            <button class="btn-close" (click)="closeGrantForm()">Ã—</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label *ngIf="grantFormType === 'USER'">Username</label>
              <label *ngIf="grantFormType === 'GROUP'">Group Identifier</label>
              <label *ngIf="grantFormType === 'DISTRIBUTION_LIST'">Distribution List</label>
              <input 
                type="text" 
                [(ngModel)]="newPrincipalIdentifier" 
                [placeholder]="getIdentifierPlaceholder()"
                class="form-input"
              />
            </div>
            <div class="form-group" *ngIf="grantFormType !== 'USER'">
              <label>Display Name (optional)</label>
              <input 
                type="text" 
                [(ngModel)]="newPrincipalDisplayName" 
                placeholder="Human-readable name for this group"
                class="form-input"
              />
            </div>
            <div class="form-group">
              <label>Access Level</label>
              <select [(ngModel)]="newAccessLevel" class="form-select">
                <option value="OWNER">ğŸ‘‘ Owner</option>
                <option value="READ_WRITE">âœï¸ Read/Write</option>
                <option value="READ_ONLY">ğŸ‘ï¸ Read Only</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn-cancel" (click)="closeGrantForm()">Cancel</button>
            <button 
              class="btn-primary" 
              (click)="grantAccess()" 
              [disabled]="isGranting || !newPrincipalIdentifier.trim()"
            >
              <span *ngIf="isGranting">Granting...</span>
              <span *ngIf="!isGranting">Grant Access</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Current Permissions Table -->
    <div class="permissions-table-section">
      <h2>Current Permissions</h2>
      <div class="table-wrapper" *ngIf="permissions.length > 0">
        <table class="permissions-table">
          <thead>
            <tr>
              <th>Type</th>
              <th>Principal</th>
              <th>Access Level</th>
              <th>Granted</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let permission of permissions" 
                [class.editing]="editingPermissionId === permission.id"
                [class.original-owner]="!permission.id">
              <td class="type-cell">
                <span class="type-icon">{{ getPrincipalTypeIcon(permission.principalType) }}</span>
                <span class="type-label">{{ getPrincipalTypeLabel(permission.principalType) }}</span>
              </td>
              <td class="principal-cell">
                <div class="principal-info">
                  <span class="principal-name">{{ permission.principalDisplayName || permission.principalIdentifier }}</span>
                  <span class="principal-id" *ngIf="permission.principalDisplayName && permission.principalDisplayName !== permission.principalIdentifier">
                    {{ permission.principalIdentifier }}
                  </span>
                </div>
              </td>
              <td class="access-cell">
                <!-- Normal view -->
                <span *ngIf="editingPermissionId !== permission.id" class="access-badge" [class]="'level-' + permission.accessLevel.toLowerCase()">
                  {{ getAccessLevelIcon(permission.accessLevel) }} {{ getAccessLevelLabel(permission.accessLevel) }}
                </span>
                <!-- Edit view -->
                <select 
                  *ngIf="editingPermissionId === permission.id" 
                  [(ngModel)]="editAccessLevel" 
                  class="form-select inline"
                >
                  <option value="OWNER">ğŸ‘‘ Owner</option>
                  <option value="READ_WRITE">âœï¸ Read/Write</option>
                  <option value="READ_ONLY">ğŸ‘ï¸ Read Only</option>
                </select>
              </td>
              <td class="granted-cell">
                <div class="granted-info">
                  <span class="granted-date">{{ permission.grantedAt | date:'mediumDate' }}</span>
                  <span class="granted-by" *ngIf="permission.grantedBy">by {{ permission.grantedBy }}</span>
                  <span class="granted-by" *ngIf="!permission.grantedBy && !permission.id">Original Owner</span>
                </div>
              </td>
              <td class="actions-cell">
                <!-- Normal actions -->
                <div *ngIf="editingPermissionId !== permission.id && canEditPermission(permission)" class="action-buttons">
                  <button class="btn-action btn-edit" (click)="startEdit(permission)" title="Edit">
                    âœï¸
                  </button>
                  <button class="btn-action btn-delete" (click)="confirmDelete(permission)" title="Revoke">
                    ğŸ—‘ï¸
                  </button>
                </div>
                <!-- Edit actions -->
                <div *ngIf="editingPermissionId === permission.id" class="action-buttons">
                  <button class="btn-action btn-save" (click)="saveEdit()" title="Save">
                    âœ…
                  </button>
                  <button class="btn-action btn-cancel-edit" (click)="cancelEdit()" title="Cancel">
                    âŒ
                  </button>
                </div>
                <!-- Original owner badge -->
                <span *ngIf="!canEditPermission(permission)" class="original-badge">
                  Original Owner
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="empty-state" *ngIf="permissions.length === 0">
        <p>No permissions configured yet. Use the buttons above to grant access.</p>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" *ngIf="deleteConfirmId" (click)="cancelDelete()">
    <div class="modal modal-danger" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>âš ï¸ Confirm Revoke Access</h3>
        <button class="btn-close" (click)="cancelDelete()">Ã—</button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to revoke this access? The user/group will no longer be able to access this RC.</p>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="cancelDelete()">Cancel</button>
        <button class="btn-danger" (click)="deletePermission()">Revoke Access</button>
      </div>
    </div>
  </div>

  <!-- Not Owner Message -->
  <div class="not-owner-message" *ngIf="!isLoading && rc && !rc.isOwner">
    <div class="message-icon">ğŸ”’</div>
    <h2>Access Denied</h2>
    <p>Only RC owners can manage permissions for this Responsibility Centre.</p>
    <button class="btn-primary" (click)="goBack()">Return to RC Selection</button>
  </div>
</div>
