<!--
  myRC - Training Component Template
  Copyright (c) 2026 myRC Team
  Licensed under MIT License
-->
<div class="training-container">
  <!-- Messages -->
  <div class="messages">
    <div class="alert alert-danger" *ngIf="errorMessage" (click)="dismissError()">
      {{ errorMessage }}
    </div>
    <div class="alert alert-success" *ngIf="successMessage" (click)="dismissSuccess()">
      {{ successMessage }}
    </div>
  </div>

  <!-- Search and Filter Bar -->
  <div class="filters-bar" [class.collapsed]="!filtersExpanded" *ngIf="!showCreateForm">
    <!-- Search Box - Always Visible -->
    <div class="search-box-always-visible">
      <input
        type="text"
        [(ngModel)]="searchTerm"
        [placeholder]="'training.searchPlaceholder' | translate"
        class="search-input"
      />
      <button class="btn-clear" *ngIf="searchTerm" (click)="clearSearch()" [title]="'common.clearSearch' | translate">âœ•</button>
      <button
        class="btn-toggle-filters"
        (click)="toggleFilters()"
        [title]="filtersExpanded ? ('common.hideFilters' | translate) : ('common.showFilters' | translate)">
        <span class="toggle-icon" [class.collapsed]="!filtersExpanded">â–¼</span>
        <span class="toggle-label">{{ filtersExpanded ? ('common.hideFilters' | translate) : ('common.showFilters' | translate) }}</span>
      </button>
    </div>
    <div class="filters-content" *ngIf="filtersExpanded">
      <!-- Status Filter -->
      <div class="filter-group">
        <span class="filter-label">{{ 'common.status' | translate }}:</span>
        <button
          class="filter-btn"
          [class.active]="selectedStatusFilter === null"
          (click)="filterByStatus(null)">
          {{ 'common.all' | translate }}
        </button>
        <button
          *ngFor="let s of statusOptions"
          class="filter-btn"
          [class.active]="selectedStatusFilter === s"
          (click)="filterByStatus(s)">
          {{ 'training.status_' + s | translate }}
        </button>
      </div>
      <!-- Type Filter -->
      <div class="filter-group">
        <span class="filter-label">{{ 'training.trainingType' | translate }}:</span>
        <button
          class="filter-btn"
          [class.active]="selectedTypeFilter === null"
          (click)="filterByType(null)">
          {{ 'common.all' | translate }}
        </button>
        <button
          *ngFor="let t of trainingTypeOptions"
          class="filter-btn"
          [class.active]="selectedTypeFilter === t"
          (click)="filterByType(t)">
          {{ 'training.type_' + t | translate }}
        </button>
      </div>
    </div>
  </div>

  <!-- Create Form -->
  <div class="create-form-container" *ngIf="showCreateForm">
    <div class="create-form">
      <h2>{{ 'training.createTitle' | translate }}</h2>

      <div class="form-row">
        <div class="form-group">
          <label for="name">{{ 'common.name' | translate }} *</label>
          <input type="text" id="name" [(ngModel)]="newItemName" [placeholder]="'training.enterName' | translate" class="form-control">
        </div>
        <div class="form-group">
          <label for="trainingType">{{ 'training.trainingType' | translate }}</label>
          <select id="trainingType" [(ngModel)]="newItemTrainingType" class="form-control">
            <option *ngFor="let t of trainingTypeOptions" [value]="t">{{ 'training.type_' + t | translate }}</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="description">{{ 'common.description' | translate }}</label>
        <textarea id="description" [(ngModel)]="newItemDescription" [placeholder]="'training.enterDescription' | translate" class="form-control" rows="2"></textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="provider">{{ 'training.provider' | translate }}</label>
          <input type="text" id="provider" [(ngModel)]="newItemProvider" [placeholder]="'training.enterProvider' | translate" class="form-control">
        </div>
        <div class="form-group">
          <label for="referenceNumber">{{ 'training.referenceNumber' | translate }}</label>
          <input type="text" id="referenceNumber" [(ngModel)]="newItemReferenceNumber" [placeholder]="'training.enterReferenceNumber' | translate" class="form-control">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="employeeName">{{ 'training.employeeName' | translate }}</label>
          <input type="text" id="employeeName" [(ngModel)]="newItemEmployeeName" [placeholder]="'training.enterEmployeeName' | translate" class="form-control">
        </div>
        <div class="form-group">
          <label for="numberOfParticipants">{{ 'training.numberOfParticipants' | translate }}</label>
          <input type="number" id="numberOfParticipants" [(ngModel)]="newItemNumberOfParticipants" min="1" class="form-control">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="location">{{ 'training.location' | translate }}</label>
          <input type="text" id="location" [(ngModel)]="newItemLocation" [placeholder]="'training.enterLocation' | translate" class="form-control">
        </div>
        <div class="form-group">
          <label for="status">{{ 'common.status' | translate }}</label>
          <select id="status" [(ngModel)]="newItemStatus" class="form-control">
            <option *ngFor="let s of statusOptions" [value]="s">{{ 'training.status_' + s | translate }}</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="startDate">{{ 'training.startDate' | translate }}</label>
          <input type="date" id="startDate" [(ngModel)]="newItemStartDate" class="form-control">
        </div>
        <div class="form-group">
          <label for="endDate">{{ 'training.endDate' | translate }}</label>
          <input type="date" id="endDate" [(ngModel)]="newItemEndDate" class="form-control">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="currency">{{ 'common.currency' | translate }}</label>
          <select id="currency" [(ngModel)]="newItemCurrency" class="form-control">
            <option *ngFor="let c of currencies" [value]="c.code">{{ getCurrencyFlag(c.code) }} {{ c.code }} - {{ c.name }}</option>
          </select>
        </div>
        <div class="form-group" *ngIf="newItemCurrency !== 'CAD'">
          <label for="exchangeRate">{{ 'training.exchangeRate' | translate }}</label>
          <input type="number" id="exchangeRate" [(ngModel)]="newItemExchangeRate" step="0.0001" class="form-control">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="estimatedCost">{{ 'training.estimatedCost' | translate }}</label>
          <input type="number" id="estimatedCost" [(ngModel)]="newItemEstimatedCost" step="0.01" [placeholder]="'training.enterEstimatedCost' | translate" class="form-control">
        </div>
        <div class="form-group">
          <label for="actualCost">{{ 'training.actualCost' | translate }}</label>
          <input type="number" id="actualCost" [(ngModel)]="newItemActualCost" step="0.01" [placeholder]="'training.enterActualCost' | translate" class="form-control">
        </div>
      </div>

      <!-- Money Allocations (O&M only) -->
      <div class="allocations-section">
        <div class="allocations-header">
          <h3>{{ 'training.moneyAllocations' | translate }}</h3>
          <span class="om-only-badge">{{ 'training.omOnly' | translate }}</span>
          <button class="btn-add-allocation" (click)="addNewAllocation(newItemMoneyAllocations)" *ngIf="monies.length > 0">
            + {{ 'training.addAllocation' | translate }}
          </button>
        </div>
        <div class="allocation-row" *ngFor="let alloc of newItemMoneyAllocations; let i = index">
          <select [(ngModel)]="alloc.moneyId" (ngModelChange)="onAllocationMoneyChange(alloc)" class="form-control money-select">
            <option *ngFor="let m of monies" [ngValue]="m.id">{{ m.code }} - {{ m.name }}</option>
          </select>
          <div class="allocation-amount">
            <label>{{ 'training.omAmount' | translate }}</label>
            <input type="number" [(ngModel)]="alloc.omAmount" step="0.01" class="form-control">
          </div>
          <button class="btn-remove-allocation" (click)="removeAllocation(newItemMoneyAllocations, i)">âœ•</button>
        </div>
      </div>

      <div class="form-actions">
        <button class="btn btn-primary" (click)="createItem()" [disabled]="isCreating || !newItemName.trim()">
          {{ isCreating ? ('training.creating' | translate) : ('training.create' | translate) }}
        </button>
        <button class="btn btn-secondary" (click)="cancelCreate()">{{ 'common.cancel' | translate }}</button>
      </div>
    </div>
  </div>

  <!-- Action Bar -->
  <div class="action-bar" *ngIf="!showCreateForm">
    <button class="btn btn-primary" (click)="openCreateForm()">
      + {{ 'training.addItem' | translate }}
    </button>
  </div>

  <!-- Loading -->
  <div class="loading-container" *ngIf="isLoadingItems">
    <div class="loading-spinner"></div>
    <p>{{ 'training.loadingItems' | translate }}</p>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="!isLoadingItems && trainingItems.length === 0 && !showCreateForm">
    <div class="empty-icon">ðŸŽ“</div>
    <h3>{{ 'training.noItemsYet' | translate }}</h3>
    <p>{{ 'training.noItemsYetDesc' | translate }}</p>
    <button class="btn btn-primary" (click)="openCreateForm()">{{ 'training.createFirstItem' | translate }}</button>
  </div>

  <!-- No Matching Items -->
  <div class="empty-state" *ngIf="!isLoadingItems && trainingItems.length > 0 && filteredItems.length === 0 && !showCreateForm">
    <h3>{{ 'training.noMatchingItems' | translate }}</h3>
    <p>{{ 'training.noMatchingItemsHint' | translate }}</p>
  </div>

  <!-- Items List -->
  <div class="items-list" *ngIf="!isLoadingItems && filteredItems.length > 0 && !showCreateForm">
    <div
      class="item-card"
      *ngFor="let item of filteredItems"
      [class.expanded]="isExpanded(item.id)"
    >
      <!-- Item Header (click to expand) -->
      <div class="item-header" (click)="toggleItem(item.id)">
        <div class="item-main-info">
          <span class="item-type-icon">{{ getTrainingTypeInfo(item.trainingType).icon }}</span>
          <span class="item-name">{{ item.name }}</span>
          <span class="status-badge" [attr.data-status]="item.status">
            {{ getStatusInfo(item.status).icon }} {{ 'training.status_' + item.status | translate }}
          </span>
        </div>
        <div class="item-meta">
          <span class="item-cost" *ngIf="item.estimatedCost !== null">
            {{ formatCurrency(item.estimatedCostCad ?? item.estimatedCost) }}
          </span>
          <span class="item-participants" *ngIf="item.numberOfParticipants">
            ðŸ‘¥ {{ item.numberOfParticipants }}
          </span>
          <span class="expand-icon" [class.rotated]="isExpanded(item.id)">â–¼</span>
        </div>
      </div>

      <!-- Expanded Content -->
      <div class="item-details" *ngIf="isExpanded(item.id)">
        <!-- View Mode -->
        <div class="detail-view" *ngIf="editingItemId !== item.id">
          <div class="detail-grid">
            <div class="detail-field" *ngIf="item.description">
              <span class="detail-label">{{ 'common.description' | translate }}</span>
              <span class="detail-value">{{ item.description }}</span>
            </div>
            <div class="detail-field" *ngIf="item.provider">
              <span class="detail-label">{{ 'training.provider' | translate }}</span>
              <span class="detail-value">{{ item.provider }}</span>
            </div>
            <div class="detail-field" *ngIf="item.referenceNumber">
              <span class="detail-label">{{ 'training.referenceNumber' | translate }}</span>
              <span class="detail-value">{{ item.referenceNumber }}</span>
            </div>
            <div class="detail-field" *ngIf="item.employeeName">
              <span class="detail-label">{{ 'training.employeeName' | translate }}</span>
              <span class="detail-value">{{ item.employeeName }}</span>
            </div>
            <div class="detail-field" *ngIf="item.location">
              <span class="detail-label">{{ 'training.location' | translate }}</span>
              <span class="detail-value">{{ item.location }}</span>
            </div>
            <div class="detail-field">
              <span class="detail-label">{{ 'training.trainingType' | translate }}</span>
              <span class="detail-value">{{ getTrainingTypeInfo(item.trainingType).icon }} {{ 'training.type_' + item.trainingType | translate }}</span>
            </div>
            <div class="detail-field" *ngIf="item.startDate">
              <span class="detail-label">{{ 'training.startDate' | translate }}</span>
              <span class="detail-value">{{ formatDate(item.startDate) }}</span>
            </div>
            <div class="detail-field" *ngIf="item.endDate">
              <span class="detail-label">{{ 'training.endDate' | translate }}</span>
              <span class="detail-value">{{ formatDate(item.endDate) }}</span>
            </div>
            <div class="detail-field">
              <span class="detail-label">{{ 'training.numberOfParticipants' | translate }}</span>
              <span class="detail-value">{{ item.numberOfParticipants }}</span>
            </div>
            <div class="detail-field">
              <span class="detail-label">{{ 'training.estimatedCost' | translate }}</span>
              <span class="detail-value">{{ formatCurrency(item.estimatedCost, item.currency) }}
                <span *ngIf="item.currency !== 'CAD' && item.estimatedCostCad"> ({{ formatCurrency(item.estimatedCostCad, 'CAD') }})</span>
              </span>
            </div>
            <div class="detail-field">
              <span class="detail-label">{{ 'training.actualCost' | translate }}</span>
              <span class="detail-value">{{ formatCurrency(item.actualCost, item.currency) }}
                <span *ngIf="item.currency !== 'CAD' && item.actualCostCad"> ({{ formatCurrency(item.actualCostCad, 'CAD') }})</span>
              </span>
            </div>
          </div>

          <!-- Money Allocations Display -->
          <div class="allocations-display" *ngIf="item.moneyAllocations && item.moneyAllocations.length > 0">
            <h4>{{ 'training.moneyAllocations' | translate }} <span class="om-only-badge">{{ 'training.omOnly' | translate }}</span></h4>
            <table class="allocations-table">
              <thead>
                <tr>
                  <th>{{ 'training.moneyType' | translate }}</th>
                  <th>{{ 'training.omAmount' | translate }}</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let alloc of item.moneyAllocations">
                  <td>{{ alloc.moneyCode }} - {{ alloc.moneyName }}</td>
                  <td class="amount-cell">{{ formatCurrency(alloc.omAmount) }}</td>
                </tr>
              </tbody>
              <tfoot>
                <tr>
                  <td><strong>{{ 'common.total' | translate }}</strong></td>
                  <td class="amount-cell"><strong>{{ formatCurrency(item.moneyAllocationTotalOm) }}</strong></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <!-- Status Change -->
          <div class="status-section">
            <label>{{ 'common.status' | translate }}:</label>
            <select [ngModel]="item.status" (ngModelChange)="updateStatus(item, $event)" class="form-control status-select">
              <option *ngFor="let s of statusOptions" [value]="s">{{ 'training.status_' + s | translate }}</option>
            </select>
          </div>

          <!-- Action Buttons -->
          <div class="item-actions">
            <button class="btn btn-secondary" (click)="startEdit(item)">{{ 'common.edit' | translate }}</button>
            <button class="btn btn-danger" (click)="deleteItem(item)">{{ 'common.delete' | translate }}</button>
          </div>
        </div>

        <!-- Edit Mode -->
        <div class="edit-form" *ngIf="editingItemId === item.id">
          <h3>{{ 'training.editTitle' | translate }}</h3>

          <div class="form-row">
            <div class="form-group">
              <label>{{ 'common.name' | translate }} *</label>
              <input type="text" [(ngModel)]="editItemName" class="form-control">
            </div>
            <div class="form-group">
              <label>{{ 'training.trainingType' | translate }}</label>
              <select [(ngModel)]="editItemTrainingType" class="form-control">
                <option *ngFor="let t of trainingTypeOptions" [value]="t">{{ 'training.type_' + t | translate }}</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>{{ 'common.description' | translate }}</label>
            <textarea [(ngModel)]="editItemDescription" class="form-control" rows="2"></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>{{ 'training.provider' | translate }}</label>
              <input type="text" [(ngModel)]="editItemProvider" class="form-control">
            </div>
            <div class="form-group">
              <label>{{ 'training.referenceNumber' | translate }}</label>
              <input type="text" [(ngModel)]="editItemReferenceNumber" class="form-control">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>{{ 'training.employeeName' | translate }}</label>
              <input type="text" [(ngModel)]="editItemEmployeeName" class="form-control">
            </div>
            <div class="form-group">
              <label>{{ 'training.numberOfParticipants' | translate }}</label>
              <input type="number" [(ngModel)]="editItemNumberOfParticipants" min="1" class="form-control">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>{{ 'training.location' | translate }}</label>
              <input type="text" [(ngModel)]="editItemLocation" class="form-control">
            </div>
            <div class="form-group">
              <label>{{ 'common.status' | translate }}</label>
              <select [(ngModel)]="editItemStatus" class="form-control">
                <option *ngFor="let s of statusOptions" [value]="s">{{ 'training.status_' + s | translate }}</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>{{ 'training.startDate' | translate }}</label>
              <input type="date" [(ngModel)]="editItemStartDate" class="form-control">
            </div>
            <div class="form-group">
              <label>{{ 'training.endDate' | translate }}</label>
              <input type="date" [(ngModel)]="editItemEndDate" class="form-control">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>{{ 'common.currency' | translate }}</label>
              <select [(ngModel)]="editItemCurrency" class="form-control">
                <option *ngFor="let c of currencies" [value]="c.code">{{ getCurrencyFlag(c.code) }} {{ c.code }} - {{ c.name }}</option>
              </select>
            </div>
            <div class="form-group" *ngIf="editItemCurrency !== 'CAD'">
              <label>{{ 'training.exchangeRate' | translate }}</label>
              <input type="number" [(ngModel)]="editItemExchangeRate" step="0.0001" class="form-control">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>{{ 'training.estimatedCost' | translate }}</label>
              <input type="number" [(ngModel)]="editItemEstimatedCost" step="0.01" class="form-control">
            </div>
            <div class="form-group">
              <label>{{ 'training.actualCost' | translate }}</label>
              <input type="number" [(ngModel)]="editItemActualCost" step="0.01" class="form-control">
            </div>
          </div>

          <!-- Money Allocations Edit -->
          <div class="allocations-section">
            <div class="allocations-header">
              <h3>{{ 'training.moneyAllocations' | translate }}</h3>
              <span class="om-only-badge">{{ 'training.omOnly' | translate }}</span>
              <button class="btn-add-allocation" (click)="addNewAllocation(editItemMoneyAllocations)" *ngIf="monies.length > 0">
                + {{ 'training.addAllocation' | translate }}
              </button>
            </div>
            <div class="allocation-row" *ngFor="let alloc of editItemMoneyAllocations; let i = index">
              <select [(ngModel)]="alloc.moneyId" (ngModelChange)="onAllocationMoneyChange(alloc)" class="form-control money-select">
                <option *ngFor="let m of monies" [ngValue]="m.id">{{ m.code }} - {{ m.name }}</option>
              </select>
              <div class="allocation-amount">
                <label>{{ 'training.omAmount' | translate }}</label>
                <input type="number" [(ngModel)]="alloc.omAmount" step="0.01" class="form-control">
              </div>
              <button class="btn-remove-allocation" (click)="removeAllocation(editItemMoneyAllocations, i)">âœ•</button>
            </div>
          </div>

          <div class="form-actions">
            <button class="btn btn-primary" (click)="saveEdit()" [disabled]="isUpdating || !editItemName.trim()">
              {{ isUpdating ? ('training.saving' | translate) : ('training.save' | translate) }}
            </button>
            <button class="btn btn-secondary" (click)="cancelEdit()">{{ 'common.cancel' | translate }}</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Button - After Items List -->
  <div class="action-bar bottom" *ngIf="!showCreateForm && trainingItems.length > 0">
    <button class="btn btn-primary" (click)="openCreateForm()">
      + {{ 'training.addItem' | translate }}
    </button>
  </div>

  <!-- Summary Section -->
  <div class="summary-section" [class.collapsed]="!summaryExpanded" *ngIf="trainingItems.length > 0">
    <div class="summary-header" (click)="toggleSummary()">
      <button
        class="btn-toggle-summary"
        [title]="summaryExpanded ? ('common.hideSummary' | translate) : ('common.showSummary' | translate)">
        <span class="toggle-icon" [class.collapsed]="!summaryExpanded">â–¼</span>
        <span class="toggle-label">{{ summaryExpanded ? ('common.hideSummary' | translate) : ('common.showSummary' | translate) }}</span>
      </button>
    </div>

    <div class="summary-content" *ngIf="summaryExpanded">
      <!-- Summary Cards -->
      <div class="summary-group">
        <div class="summary-cards">
          <div class="summary-card">
            <div class="summary-label">{{ 'training.totalItems' | translate }}</div>
            <div class="summary-value">{{ totalItems }}</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">{{ 'training.totalParticipants' | translate }}</div>
            <div class="summary-value">{{ totalParticipants }}</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">{{ 'training.totalEstimated' | translate }}</div>
            <div class="summary-value">{{ formatCurrency(grandTotalEstimated) }}</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">{{ 'training.totalActual' | translate }}</div>
            <div class="summary-value">{{ formatCurrency(grandTotalActual) }}</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">{{ 'training.totalOm' | translate }}</div>
            <div class="summary-value">{{ formatCurrency(grandTotalOm) }}</div>
          </div>
        </div>
      </div>

      <!-- Money Type Breakdown -->
      <div class="summary-group" *ngIf="summaryByMoneyType.length > 0">
        <h4>{{ 'training.totalsByMoneyType' | translate }}</h4>
        <table class="summary-table">
          <thead>
            <tr>
              <th>{{ 'training.moneyType' | translate }}</th>
              <th>{{ 'training.omAmount' | translate }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of summaryByMoneyType">
              <td>{{ row.moneyCode }} - {{ row.moneyName }}</td>
              <td class="amount">{{ formatCurrency(row.totalOm) }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Grand Total -->
      <div class="grand-total">
        <table class="summary-table">
          <tbody>
            <tr class="grand-total-row">
              <td><strong>{{ 'training.grandTotalOm' | translate }}</strong></td>
              <td class="amount"><strong>{{ formatCurrency(grandTotalOm) }}</strong></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
