<!--
  myRC - Configuration Component Template
  Copyright (c) 2026 myRC Team
  Licensed under MIT License
-->
<div class="configuration-page">
  <!-- Success Message -->
  <div class="success-message" *ngIf="successMessage">
    <span class="success-icon">‚úì</span>
    {{ successMessage }}
  </div>

  <!-- Error Message -->
  <div class="error-message" *ngIf="moneyError">
    <span class="error-icon">‚ö†Ô∏è</span>
    {{ moneyError }}
    <button class="dismiss-btn" (click)="clearError()">√ó</button>
  </div>

  <div class="error-message" *ngIf="categoryError">
    <span class="error-icon">‚ö†Ô∏è</span>
    {{ categoryError }}
    <button class="dismiss-btn" (click)="clearCategoryError()">√ó</button>
  </div>

  <!-- Configuration Tabs -->
  <div class="config-tabs">
    <button 
      class="tab-btn" 
      [class.active]="activeTab === 'general'"
      (click)="setActiveTab('general')">
      <span class="tab-icon">‚öôÔ∏è</span>
      <span class="tab-label">General</span>
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab === 'monies'"
      (click)="setActiveTab('monies')">
      <span class="tab-icon">üí∞</span>
      <span class="tab-label">Monies</span>
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab === 'categories'"
      (click)="setActiveTab('categories')">
      <span class="tab-icon">üìÅ</span>
      <span class="tab-label">Categories</span>
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab === 'summary'"
      (click)="setActiveTab('summary')">
      <span class="tab-icon">üìä</span>
      <span class="tab-label">Summary</span>
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab === 'import-export'"
      (click)="setActiveTab('import-export')">
      <span class="tab-icon">üì•</span>
      <span class="tab-label">Import/Export</span>
    </button>
  </div>

  <!-- Monies Tab Content -->
  <div class="tab-content" *ngIf="activeTab === 'monies'">
    <div class="section-header">
      <h2>Money Types</h2>
      <p class="section-description">
        Configure money types for this fiscal year. Each money type has two parts: Capital (CAP) and O&M (OM).
        The default "AB" money type cannot be deleted.
      </p>
    </div>

    <!-- Money List -->
    <div class="money-list" *ngIf="!isLoadingMonies">
      <div 
        class="money-card" 
        *ngFor="let money of monies; trackBy: trackByMoneyId"
        [class.is-default]="money.isDefault"
        [class.is-editing]="editingMoneyId === money.id">
        
        <!-- View Mode -->
        <div class="money-content" *ngIf="editingMoneyId !== money.id">
          <div class="money-header">
            <span class="money-code">{{ money.code }}</span>
            <span class="default-badge" *ngIf="money.isDefault">Default</span>
            <span class="readonly-badge" *ngIf="money.isDefault">Read-only</span>
          </div>
          <div class="money-name">{{ money.name }}</div>
          <div class="money-description" *ngIf="money.description">{{ money.description }}</div>
          <div class="money-parts">
            <span class="part-tag cap">{{ money.capLabel }}</span>
            <span class="part-tag om">{{ money.omLabel }}</span>
          </div>
          <div class="money-actions" *ngIf="!money.isDefault">
            <button 
              class="btn btn-secondary" 
              (click)="startEditMoney(money)"
              [disabled]="isSaving || isDeleting">
              Edit
            </button>
            <button 
              class="btn btn-danger" 
              (click)="deleteMoney(money)"
              [disabled]="isSaving || isDeleting"
              title="Delete">
              Delete
            </button>
          </div>
        </div>

        <!-- Edit Mode -->
        <div class="money-edit-form" *ngIf="editingMoneyId === money.id">
          <h4>Edit Money Type</h4>
          <div class="form-row">
            <div class="form-group">
              <label>Code</label>
              <input 
                type="text" 
                [(ngModel)]="editMoney.code"
                maxlength="10"
                [disabled]="money.isDefault || isSaving">
              <span class="form-hint" *ngIf="money.isDefault">Cannot change default code</span>
            </div>
            <div class="form-group">
              <label>Name *</label>
              <input 
                type="text" 
                [(ngModel)]="editMoney.name"
                maxlength="100"
                [disabled]="isSaving">
            </div>
          </div>
          <div class="form-group full-width">
            <label>Description</label>
            <textarea 
              [(ngModel)]="editMoney.description"
              rows="2"
              maxlength="500"
              [disabled]="isSaving"></textarea>
          </div>
          <div class="form-actions">
            <button 
              class="btn btn-secondary" 
              (click)="cancelEditMoney()"
              [disabled]="isSaving">
              Cancel
            </button>
            <button 
              class="btn btn-primary" 
              (click)="updateMoney(money)"
              [disabled]="isSaving || !editMoney.name">
              <span *ngIf="isSaving">Saving...</span>
              <span *ngIf="!isSaving">Update</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div class="empty-state" *ngIf="monies.length === 0 && !isAddingMoney">
        <span class="empty-icon">üí∞</span>
        <p>No money types configured yet.</p>
        <button class="btn btn-primary" (click)="startAddMoney()">
          Add Your First Money Type
        </button>
      </div>
    </div>

    <!-- Add Money Button -->
    <div class="action-bar" *ngIf="!isLoadingMonies">
      <button 
        class="btn btn-primary" 
        (click)="startAddMoney()"
        [disabled]="isAddingMoney || isSaving">
        <span class="btn-icon">+</span>
        Add Money Type
      </button>
    </div>

    <!-- Add Money Form -->
    <div class="money-form" *ngIf="isAddingMoney">
      <h3>Add New Money Type</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="new-code">Code *</label>
          <input 
            type="text" 
            id="new-code"
            [(ngModel)]="newMoney.code"
            placeholder="e.g., OA, WCF"
            maxlength="10"
            [disabled]="isSaving">
          <span class="form-hint">Short code (max 10 characters)</span>
        </div>
        <div class="form-group">
          <label for="new-name">Name *</label>
          <input 
            type="text" 
            id="new-name"
            [(ngModel)]="newMoney.name"
            placeholder="e.g., Operating Allotment"
            maxlength="100"
            [disabled]="isSaving">
        </div>
      </div>
      <div class="form-group full-width">
        <label for="new-description">Description</label>
        <textarea 
          id="new-description"
          [(ngModel)]="newMoney.description"
          placeholder="Optional description"
          rows="2"
          maxlength="500"
          [disabled]="isSaving"></textarea>
      </div>
      <div class="form-preview" *ngIf="newMoney.code">
        <span class="preview-label">Preview:</span>
        <span class="preview-tag">{{ newMoney.code | uppercase }} (CAP)</span>
        <span class="preview-tag">{{ newMoney.code | uppercase }} (O&M)</span>
      </div>
      <div class="form-actions">
        <button 
          class="btn btn-secondary" 
          (click)="cancelAddMoney()"
          [disabled]="isSaving">
          Cancel
        </button>
        <button 
          class="btn btn-primary" 
          (click)="saveMoney()"
          [disabled]="isSaving || !newMoney.code || !newMoney.name">
          <span *ngIf="isSaving">Saving...</span>
          <span *ngIf="!isSaving">Save Money Type</span>
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div class="loading-state" *ngIf="isLoadingMonies">
      <span class="loading-spinner"></span>
      <p>Loading money types...</p>
    </div>
  </div>

  <!-- Categories Tab Content -->
  <div class="tab-content" *ngIf="activeTab === 'categories'">
    <div class="section-header">
      <h2>Categories</h2>
      <p class="section-description">
        Configure categories for this fiscal year. Categories are used to group and organize both funding and spending items.
        Default categories are system-defined and cannot be modified or deleted.
      </p>
    </div>

    <!-- Category List -->
    <div class="category-list" *ngIf="!isLoadingCategories">
      <div 
        class="category-card" 
        *ngFor="let category of categories; trackBy: trackByCategoryId"
        [class.is-default]="category.isDefault"
        [class.is-editing]="editingCategoryId === category.id">
        
        <!-- View Mode -->
        <div class="category-content" *ngIf="editingCategoryId !== category.id">
          <div class="category-header">
            <span class="category-code">{{ category.name }}</span>
            <span class="default-badge" *ngIf="category.isDefault">Default</span>
            <span class="readonly-badge" *ngIf="category.isDefault">Read-only</span>
          </div>
          <div class="category-description" *ngIf="category.description">{{ category.description }}</div>
          <div class="category-tags">
            <span class="category-tag" [class.default-category]="category.isDefault" [class.custom-category]="!category.isDefault">
              {{ category.isDefault ? 'System' : 'Custom' }}
            </span>
            <span class="funding-type-tag" 
                  [class.cap-only]="category.fundingType === 'CAP_ONLY'"
                  [class.om-only]="category.fundingType === 'OM_ONLY'"
                  [class.both]="category.fundingType === 'BOTH' || !category.fundingType">
              {{ getFundingTypeLabel(category.fundingType) }}
            </span>
          </div>
          <div class="category-actions" *ngIf="!category.isDefault">
            <button 
              class="btn btn-secondary" 
              (click)="startEditCategory(category)"
              [disabled]="isSaving || isDeleting">
              Edit
            </button>
            <button 
              class="btn btn-danger" 
              (click)="deleteCategory(category)"
              [disabled]="isSaving || isDeleting"
              title="Delete">
              Delete
            </button>
          </div>
        </div>

        <!-- Edit Mode (only for custom categories) -->
        <div class="category-edit-form" *ngIf="editingCategoryId === category.id && !category.isDefault">
          <h4>Edit Category</h4>
          <div class="form-group">
            <label>Name *</label>
            <input 
              type="text" 
              [(ngModel)]="editCategory.name"
              maxlength="100"
              [disabled]="isSaving">
          </div>
          <div class="form-group full-width">
            <label>Description</label>
            <textarea 
              [(ngModel)]="editCategory.description"
              rows="2"
              maxlength="500"
              [disabled]="isSaving"></textarea>
          </div>
          <div class="form-group">
            <label>Funding Type</label>
            <select [(ngModel)]="editCategory.fundingType" [disabled]="isSaving">
              <option *ngFor="let ft of fundingTypeOptions" [value]="ft">
                {{ fundingTypeLabels[ft] }}
              </option>
            </select>
            <span class="form-hint">Determines which money allocation fields (CAP, OM, or both) are available</span>
          </div>
          <div class="form-actions">
            <button 
              class="btn btn-secondary" 
              (click)="cancelEditCategory()"
              [disabled]="isSaving">
              Cancel
            </button>
            <button 
              class="btn btn-primary" 
              (click)="updateCategory(category)"
              [disabled]="isSaving || !editCategory.name">
              <span *ngIf="isSaving">Saving...</span>
              <span *ngIf="!isSaving">Update</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div class="empty-state" *ngIf="categories.length === 0 && !isAddingCategory">
        <span class="empty-icon">üìÅ</span>
        <p>No categories configured yet.</p>
        <button class="btn btn-primary" (click)="startAddCategory()">
          Add Your First Category
        </button>
      </div>
    </div>

    <!-- Add Category Button -->
    <div class="action-bar" *ngIf="!isLoadingCategories">
      <button 
        class="btn btn-primary" 
        (click)="startAddCategory()"
        [disabled]="isAddingCategory || isSaving">
        <span class="btn-icon">+</span>
        Add Category
      </button>
    </div>

    <!-- Add Category Form -->
    <div class="category-form" *ngIf="isAddingCategory">
      <h3>Add New Custom Category</h3>
      <div class="form-group">
        <label for="new-category-name">Name *</label>
        <input 
          type="text" 
          id="new-category-name"
          [(ngModel)]="newCategory.name"
          placeholder="e.g., Cloud Services, Maintenance"
          maxlength="100"
          [disabled]="isSaving">
      </div>
      <div class="form-group full-width">
        <label for="new-category-description">Description</label>
        <textarea 
          id="new-category-description"
          [(ngModel)]="newCategory.description"
          placeholder="Optional description"
          rows="2"
          maxlength="500"
          [disabled]="isSaving"></textarea>
      </div>
      <div class="form-group">
        <label for="new-category-funding-type">Funding Type</label>
        <select 
          id="new-category-funding-type"
          [(ngModel)]="newCategory.fundingType" 
          [disabled]="isSaving">
          <option *ngFor="let ft of fundingTypeOptions" [value]="ft">
            {{ fundingTypeLabels[ft] }}
          </option>
        </select>
        <span class="form-hint">
          CAP Only = Capital expenditures only<br>
          O&M Only = Operations &amp; Maintenance only<br>
          Both = Both CAP and O&M allowed
        </span>
      </div>
      <div class="form-actions">
        <button 
          class="btn btn-secondary" 
          (click)="cancelAddCategory()"
          [disabled]="isSaving">
          Cancel
        </button>
        <button 
          class="btn btn-primary" 
          (click)="saveCategory()"
          [disabled]="isSaving || !newCategory.name">
          <span *ngIf="isSaving">Saving...</span>
          <span *ngIf="!isSaving">Save Category</span>
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div class="loading-state" *ngIf="isLoadingCategories">
      <span class="loading-spinner"></span>
      <p>Loading categories...</p>
    </div>
  </div>

  <!-- General Tab Content -->
  <div class="tab-content" *ngIf="activeTab === 'general'">
    <div class="section-header">
      <h2>General Settings</h2>
      <p class="section-description">
        Configure display options for funding and spending pages.
      </p>
    </div>

    <!-- Display Settings -->
    <div class="settings-section">
      <h3>Display Settings</h3>
      
      <div class="setting-card">
        <div class="setting-info">
          <span class="setting-label">Show Category Filter</span>
          <span class="setting-description">Display the category filter bar on funding and spending pages</span>
        </div>
        <div class="setting-control">
          <label class="toggle-switch">
            <input 
              type="checkbox" 
              [checked]="selectedFY?.showCategoryFilter !== false"
              (change)="updateDisplaySettings('showCategoryFilter', $any($event.target).checked)">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>

      <div class="setting-card">
        <div class="setting-info">
          <span class="setting-label">Group Items by Category</span>
          <span class="setting-description">Group funding and spending items by their category with section headers</span>
        </div>
        <div class="setting-control">
          <label class="toggle-switch">
            <input 
              type="checkbox" 
              [checked]="selectedFY?.groupByCategory === true"
              (change)="updateDisplaySettings('groupByCategory', $any($event.target).checked)">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- Summary Tab Content -->
  <div class="tab-content" *ngIf="activeTab === 'summary'">
    <div class="section-header">
      <h2>Summary Settings</h2>
      <p class="section-description">
        Configure settings for the Summary page display and indicators.
      </p>
    </div>

    <!-- On Target Settings -->
    <div class="settings-section">
      <h3>On Target Settings</h3>
      <p class="section-description">
        Configure the thresholds for the "On Target" indicator on the Summary page.
        The indicator compares Funding vs Spending percentages. When the difference falls
        within the configured range, the status shows as "On Target".
      </p>
      
      <div class="setting-card range-setting">
        <div class="setting-info">
          <span class="setting-label">Minimum Threshold</span>
          <span class="setting-description">
            Lower bound of the "On Target" range. Values below this show as "Under Budget".
          </span>
        </div>
        <div class="setting-control range-control">
          <input 
            type="range" 
            class="range-slider"
            min="-100" 
            max="100" 
            step="1"
            [value]="selectedFY?.onTargetMin ?? -10"
            (input)="onTargetMinValue = $any($event.target).value"
            (change)="updateOnTargetSetting('onTargetMin', $any($event.target).value)">
          <span class="range-value">{{ onTargetMinValue ?? selectedFY?.onTargetMin ?? -10 }}%</span>
        </div>
      </div>

      <div class="setting-card range-setting">
        <div class="setting-info">
          <span class="setting-label">Maximum Threshold</span>
          <span class="setting-description">
            Upper bound of the "On Target" range. Values above this show as "Over Budget".
          </span>
        </div>
        <div class="setting-control range-control">
          <input 
            type="range" 
            class="range-slider"
            min="-100" 
            max="100" 
            step="1"
            [value]="selectedFY?.onTargetMax ?? 10"
            (input)="onTargetMaxValue = $any($event.target).value"
            (change)="updateOnTargetSetting('onTargetMax', $any($event.target).value)">
          <span class="range-value">{{ onTargetMaxValue ?? selectedFY?.onTargetMax ?? 10 }}%</span>
        </div>
      </div>

      <div class="on-target-preview">
        <span class="preview-label">Preview:</span>
        <div class="preview-range">
          <span class="preview-under">Under Budget</span>
          <span class="preview-target">
            On Target ({{ selectedFY?.onTargetMin ?? -2 }}% to {{ selectedFY?.onTargetMax ?? 2 }}%)
          </span>
          <span class="preview-over">Over Budget</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Import/Export Tab Content -->
  <div class="tab-content" *ngIf="activeTab === 'import-export'">
    <div class="section-header">
      <h2>Import/Export Data</h2>
    </div>

    <!-- Export Section -->
    <div class="import-export-section">
      <h3>Export Line Items</h3>
      <p class="section-description">
        Export all Funding, Procurement, and Spending line items to a CSV file for backup or analysis.
      </p>
      
      <div class="export-options">
        <div class="form-group">
          <label for="exportPath">Export Destination</label>
          <div class="file-input-group">
            <input 
              type="text" 
              id="exportPath" 
              [(ngModel)]="exportPath"
              placeholder="Select export destination..."
              readonly
              class="file-path-input"
            />
            <button 
              type="button" 
              class="btn btn-secondary"
              (click)="selectExportDestination()">
              Browse...
            </button>
          </div>
        </div>
        
        <div class="export-actions">
          <button 
            type="button" 
            class="btn btn-primary"
            (click)="exportToCSV()"
            [disabled]="isExporting || !isExportValid()">
            <span *ngIf="!isExporting">üì§ Export to CSV</span>
            <span *ngIf="isExporting">Exporting...</span>
          </button>
        </div>
      </div>
      
      <div class="alert alert-success" *ngIf="exportSuccessMessage">
        {{ exportSuccessMessage }}
      </div>
      <div class="alert alert-error" *ngIf="exportErrorMessage">
        {{ exportErrorMessage }}
      </div>
    </div>

    <!-- Import Section -->
    <div class="import-export-section">
      <h3>Import Line Items</h3>
      <p class="section-description">
        Import line items from a CSV file. This feature is currently under development.
      </p>
      
      <div class="import-options">
        <div class="form-group">
          <label for="importPath">Import File</label>
          <div class="file-input-group">
            <input 
              type="text" 
              id="importPath" 
              placeholder="Select CSV file to import..."
              readonly
              disabled
              class="file-path-input"
            />
            <button 
              type="button" 
              class="btn btn-secondary"
              disabled>
              Browse...
            </button>
          </div>
        </div>
        
        <div class="import-actions">
          <button 
            type="button" 
            class="btn btn-primary"
            disabled
            title="Import functionality coming soon">
            üì• Import from CSV
          </button>
        </div>
      </div>
      
      <div class="import-notice">
        <span class="notice-icon">‚ÑπÔ∏è</span>
        <span class="notice-text">Import functionality will be available in a future update.</span>
      </div>
    </div>
  </div>
</div>
